---
phase: 07-schema-evolution-adaptive-difficulty
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TimeQuest/Models/Schemas/TimeQuestSchemaV4.swift
  - TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift
  - TimeQuest/Models/Routine.swift
  - TimeQuest/Models/RoutineTask.swift
  - TimeQuest/Models/GameSession.swift
  - TimeQuest/Models/TaskEstimation.swift
  - TimeQuest/Models/PlayerProfile.swift
  - TimeQuest/Models/TaskDifficultyState.swift
  - TimeQuest/Models/DifficultySnapshot.swift
  - TimeQuest/Domain/DifficultyConfiguration.swift
  - TimeQuest/App/TimeQuestApp.swift
  - generate-xcodeproj.js
autonomous: true

must_haves:
  truths:
    - "SchemaV4 defines all V3 models unchanged plus new TaskDifficultyState model and two new fields on GameSession (difficultyLevel, xpMultiplier)"
    - "Lightweight migration from V3 to V4 is configured -- all changes are additive with default values"
    - "All five existing typealias files point to V4 instead of V3, plus a new TaskDifficultyState typealias file exists"
    - "DifficultyConfiguration centralizes all tunable constants: 5 levels, EMA alpha, accuracy thresholds per level, XP multipliers per level"
    - "DifficultySnapshot bridges TaskDifficultyState to the pure domain layer following the EstimationSnapshot pattern"
    - "TimeQuestApp ModelContainer includes TaskDifficultyState.self and references V4"
    - "App compiles and launches successfully with the V4 schema"
  artifacts:
    - path: "TimeQuest/Models/Schemas/TimeQuestSchemaV4.swift"
      provides: "V4 schema with TaskDifficultyState model and GameSession.difficultyLevel/xpMultiplier fields"
      contains: "enum TimeQuestSchemaV4"
    - path: "TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift"
      provides: "V3-to-V4 lightweight migration stage"
      contains: "v3ToV4"
    - path: "TimeQuest/Domain/DifficultyConfiguration.swift"
      provides: "AccuracyThresholds struct and DifficultyConfiguration with 5 levels"
      contains: "struct DifficultyConfiguration"
    - path: "TimeQuest/Models/DifficultySnapshot.swift"
      provides: "Value-type bridge from TaskDifficultyState to domain layer"
      contains: "struct DifficultySnapshot"
    - path: "TimeQuest/Models/TaskDifficultyState.swift"
      provides: "Typealias for TaskDifficultyState"
      contains: "typealias TaskDifficultyState"
    - path: "TimeQuest/App/TimeQuestApp.swift"
      provides: "ModelContainer with V4 schema and TaskDifficultyState"
      contains: "TimeQuestSchemaV4"
    - path: "generate-xcodeproj.js"
      provides: "All new Phase 7 Plan 01 files registered in build system"
      contains: "TimeQuestSchemaV4.swift"
  key_links:
    - from: "TimeQuest/Models/Routine.swift"
      to: "TimeQuestSchemaV4"
      via: "typealias"
      pattern: "typealias Routine = TimeQuestSchemaV4\\.Routine"
    - from: "TimeQuest/Models/DifficultySnapshot.swift"
      to: "TaskDifficultyState"
      via: "init(from:) bridge"
      pattern: "init\\(from state: TaskDifficultyState\\)"
    - from: "TimeQuest/App/TimeQuestApp.swift"
      to: "TimeQuestSchemaV4.TaskDifficultyState.self"
      via: "ModelContainer model list"
      pattern: "TimeQuestSchemaV4\\.TaskDifficultyState\\.self"
---

# Plan 07-01: Schema Evolution (V3 to V4) + Foundation Types

## Goal

Create the SchemaV4 data model, migration chain, configuration, and bridge types that form the complete data foundation for adaptive difficulty. After this plan, the app compiles and launches on V4 with all new models and types in place, ready for the engine and integration in Plan 07-02.

## Prerequisites

- Phase 6 (v2.0) complete -- all existing schema V3 models stable
- Research complete: `.planning/phases/07-schema-evolution-adaptive-difficulty/07-RESEARCH.md`

## Requirements Covered

- **DIFF-05** (partial): SchemaV4 stores difficulty state per session (difficultyLevel, xpMultiplier on GameSession) and per task (TaskDifficultyState model) for fair historical comparisons
- **DIFF-03** (partial): No player-facing difficulty strings in any file created by this plan

<objective>
Create the SchemaV4 data model, migration chain, configuration types, and value-type bridge for adaptive difficulty.

Purpose: Establish the data foundation (new TaskDifficultyState model, two new GameSession fields, DifficultyConfiguration, DifficultySnapshot) and build system registration so that Plan 07-02 can wire the AdaptiveDifficultyEngine into the game flow against a compiling, launchable app.

Output: 5 new files (TimeQuestSchemaV4.swift, TaskDifficultyState.swift, DifficultySnapshot.swift, DifficultyConfiguration.swift), 7 updated files (MigrationPlan, 5 typealiases, TimeQuestApp.swift), updated generate-xcodeproj.js with all new files registered.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-schema-evolution-adaptive-difficulty/07-RESEARCH.md
@TimeQuest/Models/Schemas/TimeQuestSchemaV3.swift
@TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift
@TimeQuest/Models/Routine.swift
@TimeQuest/Models/RoutineTask.swift
@TimeQuest/Models/GameSession.swift
@TimeQuest/Models/TaskEstimation.swift
@TimeQuest/Models/PlayerProfile.swift
@TimeQuest/Models/EstimationSnapshot.swift
@TimeQuest/Domain/XPConfiguration.swift
@TimeQuest/App/TimeQuestApp.swift
@generate-xcodeproj.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SchemaV4 with TaskDifficultyState model, update migration chain and typealiases</name>
  <files>
    TimeQuest/Models/Schemas/TimeQuestSchemaV4.swift
    TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift
    TimeQuest/Models/Routine.swift
    TimeQuest/Models/RoutineTask.swift
    TimeQuest/Models/GameSession.swift
    TimeQuest/Models/TaskEstimation.swift
    TimeQuest/Models/PlayerProfile.swift
    TimeQuest/Models/TaskDifficultyState.swift
  </files>
  <action>
    **Create `TimeQuest/Models/Schemas/TimeQuestSchemaV4.swift`:**

    Copy the entire TimeQuestSchemaV3 structure and rename to TimeQuestSchemaV4 with versionIdentifier `Schema.Version(4, 0, 0)`. Keep ALL existing models (Routine, RoutineTask, GameSession, TaskEstimation, PlayerProfile) exactly as they are in V3 with these changes:

    1. Update `models` array to include `TaskDifficultyState.self` (6 models total)
    2. Update ALL internal relationship keypaths from `\TimeQuestSchemaV3.X` to `\TimeQuestSchemaV4.X` (there are 3: Routine.tasks inverse -> RoutineTask.routine, Routine.sessions inverse -> GameSession.routine, GameSession.estimations inverse -> TaskEstimation.session)
    3. Add two new fields to `GameSession`:
       - `var difficultyLevel: Int = 1` -- snapshot of difficulty when session was played
       - `var xpMultiplier: Double = 1.0` -- snapshot of multiplier applied to this session
       Add these as parameters to GameSession's init with default values.
    4. Add new `TaskDifficultyState` model (NO `@Attribute(.unique)` -- CloudKit forbids unique constraints):
       ```swift
       @Model
       final class TaskDifficultyState {
           var cloudID: String = UUID().uuidString
           var taskDisplayName: String = ""
           var difficultyLevel: Int = 1         // 1-5, starts at 1
           var ema: Double = 0.0               // Running EMA of accuracyPercent
           var sessionsAtCurrentLevel: Int = 0  // Count since last level change
           var lastUpdated: Date = Date.now

           init(
               taskDisplayName: String = "",
               difficultyLevel: Int = 1,
               ema: Double = 0.0,
               sessionsAtCurrentLevel: Int = 0,
               lastUpdated: Date = .now
           ) {
               self.cloudID = UUID().uuidString
               self.taskDisplayName = taskDisplayName
               self.difficultyLevel = difficultyLevel
               self.ema = ema
               self.sessionsAtCurrentLevel = sessionsAtCurrentLevel
               self.lastUpdated = lastUpdated
           }
       }
       ```

    **Update `TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift`:**

    1. Add `TimeQuestSchemaV4.self` to the `schemas` array (after V3)
    2. Add `v3ToV4` to the `stages` array
    3. Add the new stage:
       ```swift
       static let v3ToV4 = MigrationStage.lightweight(
           fromVersion: TimeQuestSchemaV3.self,
           toVersion: TimeQuestSchemaV4.self
       )
       ```

    **Update all 5 existing typealias files:**

    Change `TimeQuestSchemaV3.X` to `TimeQuestSchemaV4.X` in each typealias declaration. Keep all existing extensions exactly as they are:
    - `TimeQuest/Models/Routine.swift`: `typealias Routine = TimeQuestSchemaV4.Routine`
    - `TimeQuest/Models/RoutineTask.swift`: `typealias RoutineTask = TimeQuestSchemaV4.RoutineTask`
    - `TimeQuest/Models/GameSession.swift`: `typealias GameSession = TimeQuestSchemaV4.GameSession`
    - `TimeQuest/Models/TaskEstimation.swift`: `typealias TaskEstimation = TimeQuestSchemaV4.TaskEstimation`
    - `TimeQuest/Models/PlayerProfile.swift`: `typealias PlayerProfile = TimeQuestSchemaV4.PlayerProfile`

    **Create `TimeQuest/Models/TaskDifficultyState.swift`:**

    New typealias file following the exact same pattern as Routine.swift, GameSession.swift, etc.:
    ```swift
    import Foundation
    import SwiftData

    typealias TaskDifficultyState = TimeQuestSchemaV4.TaskDifficultyState
    ```
    No extensions needed for now -- the model is self-contained.

    **Critical constraints:**
    - Do NOT add `@Attribute(.unique)` on taskDisplayName (CloudKit forbids unique constraints)
    - Do NOT modify TimeQuestSchemaV3.swift -- it must remain unchanged for the migration chain
    - All new fields MUST have default values (required for lightweight migration and CloudKit compatibility)
    - Use `@preconcurrency import SwiftData` in SchemaV4 (same pattern as V3)
    - Use `nonisolated(unsafe)` on versionIdentifier (same pattern as V3)
  </action>
  <verify>
    1. Grep for `TimeQuestSchemaV3` in typealias files (Routine.swift, RoutineTask.swift, GameSession.swift, TaskEstimation.swift, PlayerProfile.swift) -- should return 0 matches (all updated to V4)
    2. Grep for `TimeQuestSchemaV4` in each of those 5 files -- should find 1 match each
    3. Grep for `v3ToV4` in TimeQuestMigrationPlan.swift -- should find 2 matches (declaration + stages array)
    4. Grep for `@Attribute(.unique)` in TimeQuestSchemaV4.swift -- should find 0 matches
    5. Grep for `TaskDifficultyState` in TimeQuestSchemaV4.swift -- should find matches for class definition and models array
    6. Verify TaskDifficultyState.swift exists with typealias
    7. Verify TimeQuestSchemaV3.swift is UNCHANGED (compare with git)
  </verify>
  <done>
    TimeQuestSchemaV4 defines all V3 models plus TaskDifficultyState and two new GameSession fields (difficultyLevel, xpMultiplier). Migration chain is V1->V2->V3->V4 with all lightweight stages. All 5 existing typealiases point to V4. New TaskDifficultyState typealias file created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DifficultyConfiguration and DifficultySnapshot, update TimeQuestApp and build system</name>
  <files>
    TimeQuest/Domain/DifficultyConfiguration.swift
    TimeQuest/Models/DifficultySnapshot.swift
    TimeQuest/App/TimeQuestApp.swift
    generate-xcodeproj.js
  </files>
  <action>
    **Create `TimeQuest/Domain/DifficultyConfiguration.swift`:**

    Follow the XPConfiguration pattern (Foundation only, Sendable, static default). This file centralizes ALL tunable constants for the adaptive difficulty system:

    ```swift
    import Foundation

    struct AccuracyThresholds: Sendable {
        let spotOn: Double    // Max abs difference ratio for spot_on
        let close: Double     // Max abs difference ratio for close
        let off: Double       // Max abs difference ratio for off
        // Anything beyond `off` is way_off
    }

    struct DifficultyConfiguration: Sendable {
        /// EMA smoothing factor. 0.3 = recent performance matters ~3x more than old.
        var emaAlpha: Double = 0.3

        /// Minimum completed estimations for a task before difficulty can advance beyond level 1.
        var minimumSessionsToAdvance: Int = 5

        /// EMA thresholds for advancing to each level.
        /// Levels: 1 (default), 2, 3, 4, 5
        var levelEMAThresholds: [Double] = [
            0,    // Level 1: everyone starts here
            65,   // Level 2: consistently above 65% accuracy
            75,   // Level 3: consistently above 75% accuracy
            83,   // Level 4: consistently above 83% accuracy
            90    // Level 5: consistently above 90% accuracy
        ]

        /// Accuracy band thresholds per level.
        /// As level increases, bands tighten (harder to earn top ratings).
        var thresholdsPerLevel: [AccuracyThresholds] = [
            AccuracyThresholds(spotOn: 0.10, close: 0.25, off: 0.50),  // Level 1: generous
            AccuracyThresholds(spotOn: 0.08, close: 0.20, off: 0.40),  // Level 2: slightly tighter
            AccuracyThresholds(spotOn: 0.06, close: 0.15, off: 0.35),  // Level 3: moderate
            AccuracyThresholds(spotOn: 0.05, close: 0.12, off: 0.30),  // Level 4: tight
            AccuracyThresholds(spotOn: 0.04, close: 0.10, off: 0.25),  // Level 5: very tight
        ]

        /// XP multiplier per level. Higher level = more XP reward.
        var xpMultipliers: [Double] = [
            1.0,   // Level 1: baseline
            1.15,  // Level 2: +15%
            1.35,  // Level 3: +35%
            1.60,  // Level 4: +60%
            2.00,  // Level 5: double XP
        ]

        /// Minimum absolute threshold in seconds (floor for very short tasks).
        var minimumAbsoluteThresholdSeconds: Double = 15.0

        static let `default` = DifficultyConfiguration()

        func levelForEMA(_ ema: Double) -> Int {
            var level = 1
            for (i, threshold) in levelEMAThresholds.enumerated() {
                if ema >= threshold { level = i + 1 }
            }
            return level
        }

        func thresholds(forLevel level: Int) -> AccuracyThresholds {
            let index = min(max(level - 1, 0), thresholdsPerLevel.count - 1)
            return thresholdsPerLevel[index]
        }

        func xpMultiplier(forLevel level: Int) -> Double {
            let index = min(max(level - 1, 0), xpMultipliers.count - 1)
            return xpMultipliers[index]
        }
    }
    ```

    **Create `TimeQuest/Models/DifficultySnapshot.swift`:**

    Follow the EstimationSnapshot pattern exactly (Foundation struct + SwiftData bridge extension in the same file):

    ```swift
    import Foundation

    /// Value type that bridges SwiftData's TaskDifficultyState to the pure domain layer.
    /// No SwiftData dependency in this struct definition -- only Foundation.
    struct DifficultySnapshot: Sendable {
        let taskDisplayName: String
        let difficultyLevel: Int
        let ema: Double
        let sessionsAtCurrentLevel: Int
        let lastUpdated: Date
    }

    // MARK: - SwiftData Bridge

    import SwiftData

    extension DifficultySnapshot {
        /// Map from the SwiftData model to a plain value type for domain logic.
        init(from state: TaskDifficultyState) {
            self.taskDisplayName = state.taskDisplayName
            self.difficultyLevel = state.difficultyLevel
            self.ema = state.ema
            self.sessionsAtCurrentLevel = state.sessionsAtCurrentLevel
            self.lastUpdated = state.lastUpdated
        }
    }
    ```

    **Update `TimeQuest/App/TimeQuestApp.swift`:**

    1. Change all `TimeQuestSchemaV3` references to `TimeQuestSchemaV4` (there are 10 occurrences: 5 model types x 2 container init attempts -- CloudKit and local fallback)
    2. Add `TimeQuestSchemaV4.TaskDifficultyState.self` to BOTH ModelContainer `for:` lists

    The model list in both container init calls should be:
    ```swift
    for: TimeQuestSchemaV4.Routine.self,
         TimeQuestSchemaV4.RoutineTask.self,
         TimeQuestSchemaV4.GameSession.self,
         TimeQuestSchemaV4.TaskEstimation.self,
         TimeQuestSchemaV4.PlayerProfile.self,
         TimeQuestSchemaV4.TaskDifficultyState.self,
    ```

    **Update `generate-xcodeproj.js`:**

    Add new source file entries to the `sourceFiles` array:
    ```javascript
    { name: 'TimeQuestSchemaV4.swift', path: 'Models/Schemas/TimeQuestSchemaV4.swift' },
    { name: 'TaskDifficultyState.swift', path: 'Models/TaskDifficultyState.swift' },
    { name: 'DifficultySnapshot.swift', path: 'Models/DifficultySnapshot.swift' },
    { name: 'DifficultyConfiguration.swift', path: 'Domain/DifficultyConfiguration.swift' },
    ```

    Add them to the appropriate `groups` entries:
    - `TimeQuestSchemaV4.swift` to the 'Schemas' group files array (after 'TimeQuestSchemaV3.swift')
    - `TaskDifficultyState.swift` to the 'Models' group files array (after 'PlayerProfile.swift' or 'EstimationSnapshot.swift')
    - `DifficultySnapshot.swift` to the 'Models' group files array (after 'EstimationSnapshot.swift')
    - `DifficultyConfiguration.swift` to the 'Domain' group files array

    After editing, run the script to regenerate the pbxproj:
    ```bash
    cd /Users/davezabihaylo/Desktop/Claude\ Cowork/GSD && node generate-xcodeproj.js
    ```

    Then verify the build compiles:
    ```bash
    cd /Users/davezabihaylo/Desktop/Claude\ Cowork/GSD/TimeQuest && xcodebuild -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -20
    ```

    **Critical constraints:**
    - DifficultyConfiguration must NOT import SwiftData -- Foundation only
    - DifficultySnapshot follows the EstimationSnapshot dual-import pattern (Foundation struct, SwiftData extension)
    - TimeQuestApp must include TaskDifficultyState in BOTH container init paths (CloudKit and local fallback)
    - No string containing "difficulty" in any player-facing context -- comments and code-level names are fine
    - The build MUST succeed before this task is considered done
  </action>
  <verify>
    1. Grep for `import SwiftData` in DifficultyConfiguration.swift -- should find 0 matches
    2. Grep for `import SwiftData` in DifficultySnapshot.swift -- should find 1 match (bridge extension only)
    3. Grep for `TimeQuestSchemaV3` in TimeQuestApp.swift -- should find 0 matches (all changed to V4)
    4. Grep for `TaskDifficultyState.self` in TimeQuestApp.swift -- should find 2 matches (both container paths)
    5. Grep for `TimeQuestSchemaV4.swift` in generate-xcodeproj.js -- should find matches
    6. Grep for `DifficultyConfiguration.swift` in generate-xcodeproj.js -- should find matches
    7. Grep for `DifficultySnapshot.swift` in generate-xcodeproj.js -- should find matches
    8. Grep for `TaskDifficultyState.swift` in generate-xcodeproj.js -- should find matches
    9. Run `node generate-xcodeproj.js` -- should complete without errors
    10. Run `xcodebuild -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build` -- should succeed (BUILD SUCCEEDED)
  </verify>
  <done>
    DifficultyConfiguration centralizes all 5-level tunables (EMA alpha, thresholds, XP multipliers). DifficultySnapshot bridges TaskDifficultyState to the domain layer following the EstimationSnapshot pattern. TimeQuestApp ModelContainer references V4 schema and includes TaskDifficultyState. All new files registered in generate-xcodeproj.js. App compiles successfully on V4 schema.
  </done>
</task>

</tasks>

<verification>
Phase 7 Plan 01 verification:
1. TimeQuestSchemaV4.swift exists with TaskDifficultyState model and updated GameSession (difficultyLevel, xpMultiplier)
2. TimeQuestMigrationPlan.swift has V1->V2->V3->V4 chain with all lightweight stages
3. All 5 existing typealias files reference V4, plus new TaskDifficultyState.swift typealias
4. DifficultyConfiguration has 5 levels with EMA thresholds, accuracy thresholds, and XP multipliers
5. DifficultySnapshot follows EstimationSnapshot bridge pattern exactly
6. TimeQuestApp ModelContainer includes TaskDifficultyState.self and references V4
7. No `@Attribute(.unique)` anywhere in V4 schema
8. No player-facing strings referencing difficulty levels
9. `xcodebuild build` succeeds
10. All new files registered in generate-xcodeproj.js
</verification>

<success_criteria>
- 5 new Swift files created (TimeQuestSchemaV4.swift, TaskDifficultyState.swift, DifficultySnapshot.swift, DifficultyConfiguration.swift)
- 7 existing files updated (MigrationPlan, 5 typealiases, TimeQuestApp.swift)
- generate-xcodeproj.js updated with all new files
- Schema migration chain is V1->V2->V3->V4, all lightweight
- All new fields have default values compatible with CloudKit
- DifficultyConfiguration is Foundation-only with no SwiftData import
- Build succeeds: `xcodebuild -scheme TimeQuest build` passes
</success_criteria>

## Estimated Scope

- **New files:** 5 (TimeQuestSchemaV4.swift ~160 LOC, TaskDifficultyState.swift ~5 LOC, DifficultySnapshot.swift ~25 LOC, DifficultyConfiguration.swift ~55 LOC)
- **Modified files:** 8 (MigrationPlan, 5 typealiases, TimeQuestApp.swift, generate-xcodeproj.js)
- **Estimated LOC added:** ~245

<output>
After completion, create `.planning/phases/07-schema-evolution-adaptive-difficulty/07-01-SUMMARY.md`
</output>
</content>
</invoke>