---
phase: 06-weekly-reflection-summaries
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - TimeQuest/Features/Player/Views/WeeklyReflectionCardView.swift
  - TimeQuest/Features/Player/Views/PlayerHomeView.swift
  - TimeQuest/Features/Player/Views/PlayerStatsView.swift
  - generate-xcodeproj.js
autonomous: true

must_haves:
  truths:
    - "On the first app open of a new week, a dismissible reflection card appears at the top of PlayerHomeView"
    - "The reflection card is absorbable in ~15 seconds on a single screen with no scrolling"
    - "The card shows quests completed, average accuracy, accuracy change vs prior week, best estimate, most improved, streak context, and pattern highlight"
    - "Streak context reads 'N of 7 days' -- never shows missed days"
    - "Player can dismiss the card with an X button and it disappears with animation"
    - "Dismissed or missed reflections are accessible from PlayerStatsView as 'Weekly Recaps'"
    - "Stats view shows up to 4 weeks of reflection history as compact rows"
    - "Reflection card never blocks gameplay -- it is purely informational and dismissible"
    - "The card uses the existing styling (systemGray6 background, RoundedRectangle cornerRadius 12)"
  artifacts:
    - path: "TimeQuest/Features/Player/Views/WeeklyReflectionCardView.swift"
      provides: "Dismissible 'sports score card' weekly summary component"
      contains: "struct WeeklyReflectionCardView"
    - path: "TimeQuest/Features/Player/Views/PlayerHomeView.swift"
      provides: "Reflection card integration at top of home screen"
      contains: "WeeklyReflectionCardView"
    - path: "TimeQuest/Features/Player/Views/PlayerStatsView.swift"
      provides: "Weekly Recaps history section"
      contains: "Weekly Recaps"
  key_links:
    - from: "TimeQuest/Features/Player/Views/PlayerHomeView.swift"
      to: "TimeQuest/Features/Player/ViewModels/WeeklyReflectionViewModel.swift"
      via: "Creates and refreshes WeeklyReflectionViewModel on .onAppear"
      pattern: "reflectionVM"
    - from: "TimeQuest/Features/Player/Views/PlayerHomeView.swift"
      to: "TimeQuest/Features/Player/Views/WeeklyReflectionCardView.swift"
      via: "Conditionally renders card when shouldShowCard is true"
      pattern: "WeeklyReflectionCardView"
    - from: "TimeQuest/Features/Player/Views/PlayerStatsView.swift"
      to: "TimeQuest/Features/Player/ViewModels/WeeklyReflectionViewModel.swift"
      via: "Reads reflectionHistory array to display past weeks"
      pattern: "reflectionHistory"
    - from: "TimeQuest/Features/Player/Views/WeeklyReflectionCardView.swift"
      to: "TimeQuest/Models/WeeklyReflection.swift"
      via: "Renders all fields from WeeklyReflection value type"
      pattern: "reflection\\."
---

<objective>
Build the WeeklyReflectionCardView ("sports score card"), integrate it as a dismissible card at the top of PlayerHomeView, and add a "Weekly Recaps" history section to PlayerStatsView.

Purpose: This is the player-facing delivery of weekly reflections. The card must be instantly scannable (~15 seconds), positively framed, and never block gameplay. The stats integration ensures dismissed or missed reflections remain accessible.

Output: WeeklyReflectionCardView.swift, updated PlayerHomeView.swift with card integration, updated PlayerStatsView.swift with history section, updated generate-xcodeproj.js.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-weekly-reflection-summaries/06-RESEARCH.md

# Prior plan summary (needed: uses types + ViewModel from 06-01)
@.planning/phases/06-weekly-reflection-summaries/06-01-SUMMARY.md

# Key source files to read before implementing
@TimeQuest/Features/Player/Views/PlayerHomeView.swift
@TimeQuest/Features/Player/Views/PlayerStatsView.swift
@TimeQuest/Features/Player/ViewModels/ProgressionViewModel.swift
@TimeQuest/Models/WeeklyReflection.swift
@TimeQuest/Features/Player/ViewModels/WeeklyReflectionViewModel.swift
@TimeQuest/Features/Shared/Components/InsightCardView.swift
@generate-xcodeproj.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: WeeklyReflectionCardView "sports score card" component</name>
  <files>
    TimeQuest/Features/Player/Views/WeeklyReflectionCardView.swift
  </files>
  <action>
Create WeeklyReflectionCardView.swift -- a compact, scannable card designed for 15-second absorption (REQ-041). This is NOT a report; it's a "sports score card" like an ESPN game recap. Uses large numbers, SF Symbols, and color coding rather than paragraphs of text.

The card takes a `WeeklyReflection` and a dismiss closure. Layout must fit on a single screen with no scrolling.

**Layout structure (top to bottom, all in a single VStack):**

1. **Header row** (HStack):
   - Left: `Label("Last Week", systemImage: "calendar")` styled with `.font(.subheadline.bold())` and `.foregroundStyle(.teal)`
   - Right: Dismiss button with `Image(systemName: "xmark.circle.fill")` styled `.foregroundStyle(.secondary)`

2. **Stat pills row** (HStack with equal spacing):
   - "Quests" pill: large number (questsCompleted), small label "Quests"
   - "Accuracy" pill: large number (averageAccuracy as Int%), small label "Accuracy"
   - "vs Last Week" pill (only if accuracyChangeVsPriorWeek is non-nil): signed delta with color coding (green for positive/zero, orange for negative), small label "vs Last Week"
   - Each pill is a VStack with the value on top (.font(.title2.bold())) and label below (.font(.caption), .foregroundStyle(.secondary))
   - Use Spacer() or frame(maxWidth: .infinity) to distribute pills evenly

3. **Highlights row** (HStack):
   - Best estimate chip (if bestEstimateTaskName non-nil): SF Symbol "star.fill" orange + task name + accuracy percent
   - Most improved chip (if mostImprovedTaskName non-nil): SF Symbol "arrow.up.right" green + task name
   - Each chip: HStack with icon + text, `.font(.caption)`, with a capsule background (`.background(color.opacity(0.1)).clipShape(Capsule())`)
   - If neither highlight exists, omit this row entirely

4. **Footer row** (HStack):
   - Streak context: `Label(reflection.streakContextString, systemImage: "flame.fill")` in `.font(.caption)`, `.foregroundStyle(.secondary)`
   - Pattern highlight (if non-nil): `Text(highlight)` in `.font(.caption)`, `.foregroundStyle(.secondary)`, `.lineLimit(1)`
   - Separate with Spacer()

**Card container styling** (matching existing codebase cards):
- `.padding(16)`
- `.background(Color(.systemGray6))`
- `.clipShape(RoundedRectangle(cornerRadius: 12))`

**Private helper methods:**
- `statPill(value:label:valueColor:)` -> some View -- renders a single stat metric with large value and small label
- `highlightChip(icon:color:text:)` -> some View -- renders an icon+text chip with colored capsule background

**Important constraints:**
- NO ScrollView inside the card (REQ-041: no scrolling)
- NO long paragraphs or multi-line text -- everything is short labels and numbers
- lineLimit(1) on all text that could overflow (pattern highlight, task names)
- The card must look good even when some optional fields are nil (accuracy change, best estimate, most improved, pattern highlight) -- conditionally show/hide elements
  </action>
  <verify>
- grep "struct WeeklyReflectionCardView" in WeeklyReflectionCardView.swift to confirm view exists
- grep "xmark.circle.fill" in WeeklyReflectionCardView.swift to confirm dismiss button
- grep "streakContextString" in WeeklyReflectionCardView.swift to confirm positive streak framing
- grep "ScrollView" in WeeklyReflectionCardView.swift should NOT match (no scrolling in card)
- grep "systemGray6" in WeeklyReflectionCardView.swift to confirm existing styling pattern
- grep "lineLimit" in WeeklyReflectionCardView.swift to confirm text truncation for overflow prevention
- grep "onDismiss" in WeeklyReflectionCardView.swift to confirm dismiss callback
  </verify>
  <done>
WeeklyReflectionCardView renders a compact "sports score card" with stat pills (quests, accuracy, delta), highlight chips (best estimate, most improved), and a footer (streak context, pattern highlight). No scrolling. All optional fields conditionally shown. Dismiss button with X. Existing card styling (systemGray6, cornerRadius 12). Text is large numbers and short labels, not paragraphs -- designed for 15-second absorption.
  </done>
</task>

<task type="auto">
  <name>Task 2: PlayerHomeView reflection card integration and PlayerStatsView history section</name>
  <files>
    TimeQuest/Features/Player/Views/PlayerHomeView.swift
    TimeQuest/Features/Player/Views/PlayerStatsView.swift
    generate-xcodeproj.js
  </files>
  <action>
**PlayerHomeView.swift** modifications (REQ-038, REQ-039):

1. Add state properties:
```swift
@State private var reflectionVM: WeeklyReflectionViewModel?
@State private var showReflectionCard = false
```

2. In the body's VStack, add the reflection card ABOVE the quest list but BELOW the progression header. Place it after the second `Spacer()` and before the quest list `if todayQuests.isEmpty` block. Wrap it in a conditional and horizontal padding:

```swift
// Weekly reflection card (REQ-039)
if let reflection = reflectionVM?.currentReflection, showReflectionCard {
    WeeklyReflectionCardView(reflection: reflection) {
        withAnimation(.easeOut(duration: 0.3)) {
            showReflectionCard = false
        }
        reflectionVM?.dismissCurrentReflection()
    }
    .padding(.horizontal, 24)
    .transition(.move(edge: .top).combined(with: .opacity))
}
```

3. In the `.onAppear` block, add reflection loading after existing calls:
```swift
.onAppear {
    loadTodayQuests()
    loadProgression()
    loadReflection()
}
```

4. Add the `loadReflection()` private method:
```swift
private func loadReflection() {
    let vm = WeeklyReflectionViewModel(modelContext: modelContext)
    vm.refresh()
    reflectionVM = vm
    showReflectionCard = vm.shouldShowCard
}
```

5. When passing the ViewModel to PlayerStatsView, also pass the reflectionVM. Update the NavigationLink that creates PlayerStatsView to also pass the reflection history. The cleanest approach: add `reflectionHistory` as a parameter to PlayerStatsView (since it already takes a viewModel parameter). Update the NavigationLink:

```swift
NavigationLink {
    PlayerStatsView(
        viewModel: ProgressionViewModel(
            playerProfileRepository: SwiftDataPlayerProfileRepository(modelContext: modelContext),
            sessionRepository: SwiftDataSessionRepository(modelContext: modelContext),
            modelContext: modelContext
        ),
        reflectionHistory: reflectionVM?.reflectionHistory ?? []
    )
} label: { ... }
```

**PlayerStatsView.swift** modifications (REQ-040):

1. Add a `reflectionHistory` parameter to the view:
```swift
struct PlayerStatsView: View {
    let viewModel: ProgressionViewModel
    let reflectionHistory: [WeeklyReflection]
    ...
```

Add a default value: `let reflectionHistory: [WeeklyReflection] = []` so existing callers don't break (if any exist elsewhere).

2. Add a "Weekly Recaps" section AFTER the "Personal Bests" section in the ScrollView VStack. Only show if reflectionHistory is non-empty:

```swift
// Section 3: Weekly Recaps (REQ-040)
if !reflectionHistory.isEmpty {
    VStack(alignment: .leading, spacing: 12) {
        Text("Weekly Recaps")
            .font(.headline)
            .padding(.leading, 4)

        ForEach(reflectionHistory, id: \.weekStartDate) { reflection in
            miniReflectionRow(reflection)
        }
    }
}
```

3. Add the `miniReflectionRow` private method:

```swift
private func miniReflectionRow(_ reflection: WeeklyReflection) -> some View {
    HStack {
        VStack(alignment: .leading, spacing: 4) {
            Text(reflection.weekStartDate, format: .dateTime.month(.abbreviated).day())
                .font(.subheadline)
                .fontWeight(.medium)

            HStack(spacing: 8) {
                Label("\(reflection.questsCompleted) quests", systemImage: "checkmark.circle")
                Label("\(Int(reflection.averageAccuracy))%", systemImage: "target")
            }
            .font(.caption)
            .foregroundStyle(.secondary)
        }

        Spacer()

        Text(reflection.streakContextString)
            .font(.caption)
            .foregroundStyle(.secondary)
    }
    .padding(12)
    .background(Color(.systemGray6))
    .clipShape(RoundedRectangle(cornerRadius: 12))
}
```

This mini row shows: week start date, quest count, accuracy, and streak context. Compact enough for a list of 4 items without dominating the stats page.

**generate-xcodeproj.js** updates:

Add the WeeklyReflectionCardView to the sourceFiles array:
```javascript
{ name: 'WeeklyReflectionCardView.swift', path: 'Features/Player/Views/WeeklyReflectionCardView.swift' },
```

Add to the PlayerViews group files array.

Run `node generate-xcodeproj.js` to regenerate the project file.

Verify build: `cd TimeQuest && xcodebuild build -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' -quiet 2>&1 | tail -5`
  </action>
  <verify>
- grep "WeeklyReflectionCardView" in PlayerHomeView.swift to confirm card integration
- grep "showReflectionCard" in PlayerHomeView.swift to confirm dismissal state
- grep "loadReflection" in PlayerHomeView.swift to confirm lazy loading on appear
- grep "reflectionVM" in PlayerHomeView.swift to confirm ViewModel is created
- grep "Weekly Recaps" in PlayerStatsView.swift to confirm history section exists
- grep "reflectionHistory" in PlayerStatsView.swift to confirm parameter exists
- grep "miniReflectionRow" in PlayerStatsView.swift to confirm compact history rows
- grep "WeeklyReflectionCardView.swift" in generate-xcodeproj.js to confirm build registration
- grep "transition" in PlayerHomeView.swift to confirm dismiss animation
- Build succeeds: xcodebuild build
  </verify>
  <done>
PlayerHomeView shows a dismissible WeeklyReflectionCardView at the top of the screen on the first open of a new week (REQ-039). Card appears with animation and disappears on X tap with .easeOut animation. PlayerStatsView has a "Weekly Recaps" section showing up to 4 weeks of compact reflection history (REQ-040). The reflection never blocks gameplay (REQ-039 -- purely informational, dismissible). WeeklyReflectionCardView registered in generate-xcodeproj.js. Build compiles.
  </done>
</task>

</tasks>

<verification>
1. Reflection card appears at top of PlayerHomeView -- grep "WeeklyReflectionCardView" in PlayerHomeView.swift
2. Card is dismissible with X button -- grep "xmark.circle.fill" in WeeklyReflectionCardView.swift
3. Card has no ScrollView (single screen, no scrolling) -- grep "ScrollView" in WeeklyReflectionCardView.swift should NOT match
4. Card shows all required metrics -- grep "questsCompleted\|averageAccuracy\|streakContextString\|bestEstimate\|mostImproved\|patternHighlight" in WeeklyReflectionCardView.swift
5. Streak is positive framing only -- grep "streakContextString" (never shows missed days)
6. Stats view has "Weekly Recaps" section -- grep "Weekly Recaps" in PlayerStatsView.swift
7. History accessible after dismissal -- grep "reflectionHistory" in PlayerStatsView.swift
8. Dismiss animation exists -- grep "withAnimation" in PlayerHomeView.swift
9. Lazy loading on appear -- grep "loadReflection" in PlayerHomeView.swift onAppear block
10. All new files registered in generate-xcodeproj.js
11. Build compiles without errors
</verification>

<success_criteria>
- On first app open of new week, dismissible reflection card appears above quest list (REQ-039)
- Card is "sports score card" -- scannable in ~15 seconds, no scrolling (REQ-041)
- Card shows: quests, accuracy, accuracy delta, best estimate, most improved, streak, pattern highlight (REQ-034 through REQ-037)
- Streak always positive: "N of 7 days" (REQ-036)
- Dismissed reflections accessible from stats as "Weekly Recaps" (REQ-040)
- Card never blocks gameplay (REQ-039: dismissible, not modal)
- Existing PlayerHomeView and PlayerStatsView functionality unchanged
- Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-weekly-reflection-summaries/06-02-SUMMARY.md`
</output>
