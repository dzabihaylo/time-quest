---
phase: 01-playable-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - TimeQuest/Features/Parent/Views/ParentDashboardView.swift
  - TimeQuest/Features/Parent/Views/RoutineListView.swift
  - TimeQuest/Features/Parent/Views/RoutineEditorView.swift
  - TimeQuest/Features/Parent/Views/TaskEditorView.swift
  - TimeQuest/Features/Parent/Views/SchedulePickerView.swift
  - TimeQuest/Features/Parent/ViewModels/RoutineEditorViewModel.swift
autonomous: true

must_haves:
  truths:
    - "Parent can create a new routine with a name and a player-facing display name"
    - "Parent can add ordered tasks to a routine with names, display names, and optional reference durations"
    - "Parent can set which days of the week a routine is active"
    - "Parent can activate or deactivate a routine"
    - "Parent can edit existing routines and reorder tasks via drag"
    - "Parent can complete full routine setup (5-7 tasks) in under 5 minutes"
    - "All routine data persists across app launches"
  artifacts:
    - path: "TimeQuest/Features/Parent/Views/ParentDashboardView.swift"
      provides: "Main parent screen with routine list and add button"
      contains: "NavigationStack"
    - path: "TimeQuest/Features/Parent/Views/RoutineListView.swift"
      provides: "List of all routines with active/inactive status and swipe actions"
      contains: "List"
    - path: "TimeQuest/Features/Parent/Views/RoutineEditorView.swift"
      provides: "Create/edit routine form with name, display name, schedule, task list"
      contains: "Form"
    - path: "TimeQuest/Features/Parent/Views/TaskEditorView.swift"
      provides: "Add/edit task with name, display name, optional reference duration"
      contains: "TextField"
    - path: "TimeQuest/Features/Parent/Views/SchedulePickerView.swift"
      provides: "Day-of-week selector for routine scheduling"
      contains: "ForEach"
    - path: "TimeQuest/Features/Parent/ViewModels/RoutineEditorViewModel.swift"
      provides: "Value-type editing state to prevent SwiftData auto-save surprises"
      exports: ["RoutineEditorViewModel", "RoutineEditState", "TaskEditState"]
  key_links:
    - from: "TimeQuest/Features/Parent/ViewModels/RoutineEditorViewModel.swift"
      to: "TimeQuest/Repositories/RoutineRepository.swift"
      via: "Repository protocol for save/delete operations"
      pattern: "RoutineRepositoryProtocol"
    - from: "TimeQuest/Features/Parent/Views/RoutineEditorView.swift"
      to: "TimeQuest/Features/Parent/ViewModels/RoutineEditorViewModel.swift"
      via: "ViewModel owns editing state, view binds to it"
      pattern: "RoutineEditorViewModel"
    - from: "TimeQuest/Features/Parent/Views/ParentDashboardView.swift"
      to: "TimeQuest/Features/Parent/Views/RoutineListView.swift"
      via: "NavigationStack routing"
      pattern: "RoutineListView"
    - from: "TimeQuest/Features/Parent/Views/RoutineEditorView.swift"
      to: "TimeQuest/Models/Routine.swift"
      via: "ViewModel writes edit state back to @Model on explicit save only"
      pattern: "routine\\.name = editState\\.name"
---

<objective>
Build the complete parent setup flow: routine CRUD, task editing with reorder, day-of-week scheduling, and activate/deactivate -- all using value-type editing state to prevent SwiftData auto-save surprises.

Purpose: Parents need to configure real routines (school mornings, activity prep) before the player can use the game. This flow must be fast (under 5 minutes for a full routine with 5-7 tasks) and intuitive since parents configure once and rarely return.

Output: A fully functional parent setup experience accessible from ParentDashboardView. Parent can create, edit, reorder, schedule, and toggle routines. All data persists via SwiftData.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-playable-foundation/01-RESEARCH.md
@.planning/phases/01-playable-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Routine list, editor, and schedule picker with value-type editing</name>
  <files>
    TimeQuest/Features/Parent/Views/ParentDashboardView.swift
    TimeQuest/Features/Parent/Views/RoutineListView.swift
    TimeQuest/Features/Parent/Views/RoutineEditorView.swift
    TimeQuest/Features/Parent/Views/SchedulePickerView.swift
    TimeQuest/Features/Parent/ViewModels/RoutineEditorViewModel.swift
  </files>
  <action>
    **RoutineEditorViewModel.swift -- value-type editing state:**
    This is the CRITICAL pattern for avoiding SwiftData auto-save surprises (research pitfall 3). The ViewModel holds a value-type copy of the routine data. The @Model is only mutated on explicit save.

    - `RoutineEditState` struct: name (String), displayName (String), activeDays ([Int] -- 1=Sun through 7=Sat), isActive (Bool), tasks ([TaskEditState])
    - `TaskEditState` struct: id (UUID -- for SwiftUI identification), name (String), displayName (String), referenceDurationSeconds (Int?), orderIndex (Int). Identifiable conformance.
    - `RoutineEditorViewModel` @Observable class:
      - `var editState: RoutineEditState`
      - Private reference to the Routine @Model (nil for new routines)
      - Private reference to RoutineRepositoryProtocol
      - `init(routine: Routine?, repository: RoutineRepositoryProtocol)` -- if routine provided, populate editState from it; if nil, start with defaults (isActive = true, activeDays = [2,3,4,5,6] for weekdays)
      - `func addTask()` -- appends new TaskEditState with next orderIndex
      - `func removeTask(at offsets: IndexSet)` -- removes and reindexes
      - `func moveTask(from source: IndexSet, to destination: Int)` -- moves and reindexes
      - `func save() throws` -- creates new Routine or updates existing. For new: create Routine, insert into context, create RoutineTask objects for each TaskEditState, insert each, set relationships AFTER insertion (pitfall 2). For existing: update properties, sync tasks (add new, update existing, remove deleted). Set updatedAt = Date.now.
      - `var canSave: Bool` -- name and displayName non-empty, at least 1 task with non-empty name/displayName
      - Validation: displayName gets placeholder suggestions like "Morning Quest", "Adventure Time" to encourage game-like naming (pitfall 4 prevention)

    **ParentDashboardView.swift (replace placeholder from Plan 01):**
    - NavigationStack with "Setup" title
    - Contains RoutineListView
    - Toolbar button: "Add Routine" (plus icon) that navigates to RoutineEditorView(routine: nil)
    - Toolbar button: "Done" that calls roleState.exitParentMode() (from Plan 01)

    **RoutineListView.swift:**
    - Uses @Query to fetch all Routine objects sorted by createdAt
    - Displays each routine as a row: displayName (primary), name (secondary/subtitle), active days summary (e.g., "Mon-Fri"), task count
    - Toggle for isActive on each row (this CAN directly mutate the @Model since it is an intentional, single-property change)
    - Swipe to delete with confirmation
    - Tap row navigates to RoutineEditorView(routine: tappedRoutine)
    - Empty state: friendly message encouraging first routine creation ("Create your first routine to get started")

    **RoutineEditorView.swift:**
    - Creates RoutineEditorViewModel with the passed routine (or nil for new)
    - Form layout with sections:
      1. "Names" section: TextField for name (label: "Internal name"), TextField for displayName (label: "Quest name" with placeholder "e.g., Morning Quest"). Help text under displayName: "This is what the player sees"
      2. "Schedule" section: SchedulePickerView bound to editState.activeDays
      3. "Tasks" section: List of tasks with EditButton for reorder mode. Each task row shows displayName and name. Tap to edit (sheet or navigation to TaskEditorView). Drag to reorder via .onMove(perform: viewModel.moveTask). "Add Task" button at bottom. Swipe to delete via .onDelete(perform: viewModel.removeTask)
    - Navigation title: "New Routine" or "Edit Routine"
    - Save button (toolbar trailing): calls viewModel.save(), dismiss on success. Disabled when !viewModel.canSave
    - Cancel button (toolbar leading): dismiss without saving

    **SchedulePickerView.swift:**
    - 7 day buttons in a horizontal row (Sun through Sat)
    - Each button toggles that day in the activeDays binding
    - Selected days are visually highlighted (filled circle or accent color background)
    - Uses Calendar.current.shortWeekdaySymbols for labels ("Sun", "Mon", etc.)
    - Binding: `@Binding var activeDays: [Int]`
    - Quick-select shortcuts: "Weekdays" (2-6), "Weekend" (1,7), "Every day" (1-7)
  </action>
  <verify>
    Build the project: `xcodebuild build -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' 2>&1 | tail -10`. Must succeed.

    Verify value-type editing pattern is used: grep RoutineEditorViewModel.swift for "editState" -- should be a struct, not direct @Model mutation. Grep for "routine.name = editState.name" in the save() method only.
  </verify>
  <done>
    ParentDashboardView shows routine list with add button. Routines display with name, displayName, active days, task count, and active toggle. New routines can be created with all required fields. Value-type editing state prevents auto-save corruption. Schedule picker allows day-of-week selection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Task editor with duration input and reorder integration</name>
  <files>
    TimeQuest/Features/Parent/Views/TaskEditorView.swift
  </files>
  <action>
    **TaskEditorView.swift:**
    A sheet or pushed view for editing a single task within a routine.

    - Receives a `@Binding var task: TaskEditState`
    - Form layout with sections:
      1. "Task Names" section:
         - TextField for name (label: "Internal name", placeholder: "e.g., Take a shower")
         - TextField for displayName (label: "Quest step name", placeholder: "e.g., Shower Power")
         - Help text: "The quest step name is what the player sees"
      2. "Reference Duration" section:
         - Optional toggle: "I know roughly how long this takes"
         - When toggled on, show a minute/second picker (Picker with .wheel style or stepper)
         - Minutes: 0-60, Seconds: 0-59
         - Help text: "This is hidden from the player -- it's just for your reference"
         - When toggled off, referenceDurationSeconds = nil
    - Done button to dismiss (changes are already in the binding)
    - The binding approach means changes flow back to RoutineEditorViewModel's editState.tasks array, which is only persisted when the parent form's Save is tapped. This maintains the value-type editing safety.

    **Integration with RoutineEditorView:**
    In the tasks section of RoutineEditorView, tapping a task row presents TaskEditorView as a sheet with a binding to that task in editState.tasks. New tasks created via "Add Task" should immediately open TaskEditorView for the new task.

    **Duration picker UX for speed (PRNT-07 -- under 5 minutes):**
    - Default reference duration to nil (off) -- most parents won't set this initially
    - Quick-add flow: tapping "Add Task" creates a task and opens the editor. Parent fills name + displayName (two fields) and optionally sets duration. Three taps total to add a basic task.
    - Consider: "Add Task" button could just add a row inline and let the parent edit inline (name + displayName as TextFields in the list row) rather than requiring navigation. This is faster for bulk entry. The sheet is for the optional duration picker. Decide based on implementation simplicity -- either approach satisfies the requirement.
  </action>
  <verify>
    Build the project: `xcodebuild build -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' 2>&1 | tail -10`. Must succeed.

    Verify TaskEditorView accepts a binding, not a direct @Model: grep for "@Binding var task: TaskEditState" in TaskEditorView.swift.
  </verify>
  <done>
    TaskEditorView allows editing task name, displayName, and optional reference duration. Duration picker is toggleable (off by default for speed). Changes flow through value-type binding back to RoutineEditorViewModel. Full routine with 5-7 tasks can be created in under 5 minutes: create routine -> set names + schedule -> add tasks (name + displayName each) -> save. Requirements covered: PRNT-01, PRNT-02, PRNT-03, PRNT-04, PRNT-05, PRNT-06, PRNT-07.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild build` succeeds
2. Value-type editing: RoutineEditorViewModel uses RoutineEditState struct, writes to @Model only in save()
3. CRUD operations: create routine, edit routine, delete routine, add task, edit task, remove task, reorder tasks
4. Reorder: tasks have orderIndex that updates correctly on drag-reorder
5. Schedule: activeDays persists correct weekday integers
6. Display names: separate name and displayName fields with clear labeling
7. Reference duration: optional, hidden from player (label says so)
8. Performance: routine creation flow is streamlined for speed (few taps per task)
</verification>

<success_criteria>
- Parent can create a routine with name + displayName (PRNT-01)
- Parent can add ordered tasks with names, displayNames, optional reference durations (PRNT-02, PRNT-03)
- Parent can set active days per routine (PRNT-04)
- Parent can activate/deactivate routines from the list (PRNT-05)
- Parent can edit routines and reorder tasks via drag (PRNT-06)
- Full routine setup (5-7 tasks) achievable in under 5 minutes (PRNT-07)
- All data persists via SwiftData across app launches (FOUN-04)
- No auto-save corruption -- value-type editing with explicit save
</success_criteria>

<output>
After completion, create `.planning/phases/01-playable-foundation/01-02-SUMMARY.md`
</output>
