---
phase: 01-playable-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - TimeQuest/Features/Player/Views/PlayerHomeView.swift
  - TimeQuest/Features/Player/Views/QuestView.swift
  - TimeQuest/Features/Player/Views/EstimationInputView.swift
  - TimeQuest/Features/Player/Views/TaskActiveView.swift
  - TimeQuest/Features/Player/Views/AccuracyRevealView.swift
  - TimeQuest/Features/Player/Views/SessionSummaryView.swift
  - TimeQuest/Features/Player/Views/OnboardingView.swift
  - TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift
  - TimeQuest/Features/Shared/Components/AccuracyMeter.swift
  - TimeQuest/Game/AccuracyRevealScene.swift
autonomous: false

must_haves:
  truths:
    - "Player sees available quests (active routines for today) on the home screen"
    - "Player selects a quest and estimates each task duration BEFORE doing it"
    - "No visible clock or countdown appears while the player performs a task"
    - "After completing a task, player sees estimated vs actual time with curiosity-framed feedback"
    - "Large estimation gaps are framed as discoveries, not failures"
    - "Both overestimation and underestimation are tracked and displayed separately"
    - "Session completes when all tasks are estimated and done"
    - "First 3 sessions per routine are framed as calibration"
    - "First session teaches one routine, one estimate, one result via onboarding"
    - "Visual design feels age-appropriate for a 13-year-old (modern, slightly aspirational)"
    - "Estimation and session data persists across app launches"
  artifacts:
    - path: "TimeQuest/Features/Player/Views/PlayerHomeView.swift"
      provides: "Quest selection screen showing today's available routines as quests"
      contains: "quest"
    - path: "TimeQuest/Features/Player/Views/QuestView.swift"
      provides: "Orchestrates the full task-by-task flow within a quest"
      contains: "GameSessionViewModel"
    - path: "TimeQuest/Features/Player/Views/EstimationInputView.swift"
      provides: "Duration estimation picker (minutes + seconds) with 'Lock It In' submit"
      contains: "Picker"
    - path: "TimeQuest/Features/Player/Views/TaskActiveView.swift"
      provides: "Task-in-progress screen with NO visible timer -- just task name and done button"
      contains: "Done"
    - path: "TimeQuest/Features/Player/Views/AccuracyRevealView.swift"
      provides: "Post-task feedback showing estimated vs actual with curiosity framing"
      contains: "FeedbackGenerator"
    - path: "TimeQuest/Features/Player/Views/SessionSummaryView.swift"
      provides: "End-of-session recap with all task results"
      contains: "orderedEstimations"
    - path: "TimeQuest/Features/Player/Views/OnboardingView.swift"
      provides: "3-screen first-launch experience explaining the game"
      contains: "onboardingComplete"
    - path: "TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift"
      provides: "State machine managing quest flow: estimate -> active -> reveal -> next task -> summary"
      exports: ["GameSessionViewModel", "QuestPhase"]
    - path: "TimeQuest/Features/Shared/Components/AccuracyMeter.swift"
      provides: "Visual accuracy indicator component"
      contains: "accuracyPercent"
    - path: "TimeQuest/Game/AccuracyRevealScene.swift"
      provides: "SpriteKit scene for animated accuracy reveal"
      contains: "SKScene"
  key_links:
    - from: "TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift"
      to: "TimeQuest/Domain/TimeEstimationScorer.swift"
      via: "Scores estimation after task completion"
      pattern: "TimeEstimationScorer\\.score"
    - from: "TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift"
      to: "TimeQuest/Domain/FeedbackGenerator.swift"
      via: "Generates curiosity-framed message from score"
      pattern: "FeedbackGenerator\\.message"
    - from: "TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift"
      to: "TimeQuest/Domain/CalibrationTracker.swift"
      via: "Checks if session is in calibration phase"
      pattern: "CalibrationTracker\\.isCalibrationSession"
    - from: "TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift"
      to: "TimeQuest/Repositories/SessionRepository.swift"
      via: "Persists GameSession and TaskEstimation records"
      pattern: "SessionRepositoryProtocol"
    - from: "TimeQuest/Features/Player/Views/PlayerHomeView.swift"
      to: "TimeQuest/Repositories/RoutineRepository.swift"
      via: "Fetches active routines for today"
      pattern: "fetchActiveForToday"
    - from: "TimeQuest/Features/Player/Views/AccuracyRevealView.swift"
      to: "TimeQuest/Game/AccuracyRevealScene.swift"
      via: "SpriteView embedding for animated reveal"
      pattern: "SpriteView"
---

<objective>
Build the complete player-facing gameplay loop: quest selection, task-by-task estimation, silent task execution (no visible timer), curiosity-framed accuracy feedback, session completion, onboarding, and age-appropriate visual design. This is the core training mechanism -- the experience that tests whether estimation-with-feedback improves time perception.

Purpose: This is the game. Everything in Plans 01 and 02 exists to make this work. The player selects a quest, guesses how long each step takes, does it, and discovers how close she was. Over sessions, her internal clock calibrates.

Output: A complete, playable gameplay loop from quest selection through session summary, with onboarding for first launch, calibration framing for early sessions, and visual design appropriate for a 13-year-old.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-playable-foundation/01-RESEARCH.md
@.planning/phases/01-playable-foundation/01-01-SUMMARY.md
@.planning/phases/01-playable-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: GameSessionViewModel state machine and quest flow views</name>
  <files>
    TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift
    TimeQuest/Features/Player/Views/PlayerHomeView.swift
    TimeQuest/Features/Player/Views/QuestView.swift
    TimeQuest/Features/Player/Views/EstimationInputView.swift
    TimeQuest/Features/Player/Views/TaskActiveView.swift
    TimeQuest/Features/Player/Views/AccuracyRevealView.swift
    TimeQuest/Features/Player/Views/SessionSummaryView.swift
    TimeQuest/Features/Shared/Components/AccuracyMeter.swift
  </files>
  <action>
    **GameSessionViewModel.swift -- the quest state machine:**
    This is the most complex piece. It orchestrates the entire per-task flow.

    @Observable class with:
    - `enum QuestPhase`: .selecting (choosing a quest), .estimating(taskIndex: Int), .active(taskIndex: Int), .revealing(taskIndex: Int), .summary
    - `var phase: QuestPhase = .selecting`
    - `var routine: Routine?` -- the selected routine
    - `var session: GameSession?` -- the current SwiftData session
    - `var currentTaskIndex: Int = 0`
    - `var estimatedMinutes: Int = 0` and `var estimatedSeconds: Int = 0`
    - `var currentResult: EstimationResult?` -- latest scoring result
    - `var currentFeedback: FeedbackMessage?` -- latest feedback text
    - `var taskStartedAt: Date?` -- saved to UserDefaults on set (pitfall 6 -- survive app kill)
    - `var isCalibration: Bool = false`
    - References to SessionRepositoryProtocol and RoutineRepositoryProtocol

    State transitions:
    1. `.selecting` -> player taps a quest -> `startQuest(routine:)`:
       - Query SessionRepository for completed session count for this routine
       - Set isCalibration via CalibrationTracker.isCalibrationSession(completedSessionCount:)
       - Create GameSession via SessionRepository
       - Set phase to .estimating(taskIndex: 0)

    2. `.estimating(taskIndex)` -> player sets estimate and taps "Lock It In" -> `submitEstimation()`:
       - Record estimated seconds = estimatedMinutes * 60 + estimatedSeconds
       - Set taskStartedAt = Date.now (ALSO persist to UserDefaults key "activeTaskStartedAt" for crash recovery)
       - Set phase to .active(taskIndex)
       - Reset estimatedMinutes/estimatedSeconds to 0

    3. `.active(taskIndex)` -> player taps "Done" -> `completeTask()`:
       - Record completedAt = Date.now
       - Calculate actual seconds from taskStartedAt
       - Score via TimeEstimationScorer.score(estimated:actual:)
       - Generate feedback via FeedbackGenerator.message(for:isCalibrationPhase:)
       - Create TaskEstimation record via SessionRepository (snapshot task displayName, store all scores, set orderIndex)
       - Clear UserDefaults "activeTaskStartedAt"
       - Set currentResult and currentFeedback
       - Set phase to .revealing(taskIndex)

    4. `.revealing(taskIndex)` -> player taps "Continue" or "Next" -> `advanceToNextTask()`:
       - If more tasks: set phase to .estimating(taskIndex + 1), clear currentResult/currentFeedback
       - If last task: set session.completedAt = Date.now, save session, set phase to .summary

    5. `.summary` -> player taps "Done" or "Finish" -> `finishQuest()`:
       - Reset to .selecting, clear all state

    **Crash recovery on init:**
    Check UserDefaults for "activeTaskStartedAt". If found, there was an interrupted session. For v1: clear it and let the user start fresh (don't try to resume mid-task -- too complex for v1).

    **PlayerHomeView.swift (replace Plan 01 placeholder):**
    - Shows "TimeQuest" title/logo area with hidden triple-tap gesture (preserved from Plan 01)
    - Below: list of available quests fetched via RoutineRepository.fetchActiveForToday()
    - Each quest shows: routine.displayName as primary text, task count as subtitle (e.g., "5 steps")
    - Tap a quest: navigate to QuestView with the selected routine
    - If no quests available: friendly empty state "No quests today" with subtle text "Quests appear on their scheduled days"
    - If onboarding not complete (check UserDefaults "onboardingComplete"): show OnboardingView first
    - CRITICAL: Zero parent language. Use "quest" not "routine". Use "steps" not "tasks". No "settings", "parent", "admin" anywhere.
    - Calibration badge: if routine has < 3 completed sessions, show a small "Calibrating" badge on the quest card

    **QuestView.swift:**
    - Creates GameSessionViewModel for the selected routine
    - Switches on viewModel.phase to show the appropriate view:
      - .estimating: EstimationInputView
      - .active: TaskActiveView
      - .revealing: AccuracyRevealView
      - .summary: SessionSummaryView
    - Navigation title: routine.displayName
    - Provides a way to abandon the quest (toolbar button -> confirmation -> pop back to home)

    **EstimationInputView.swift:**
    Implement closely following RESEARCH.md code example:
    - Shows task displayName prominently
    - "How long will this take?" prompt
    - Minute/second wheel pickers (0-59 each)
    - "Lock It In" button (prominent, borderedProminent style)
    - If calibration session: show small banner "Calibration mode -- just learning your patterns"
    - Step indicator: "Step 2 of 5" at top
    - PRNT-03 note: no reference duration shown here -- it is hidden from the player

    **TaskActiveView.swift:**
    - Shows task displayName as the prominent heading
    - Shows "Do it now!" or "Go!" encouragement text
    - Shows NOTHING related to time. No clock. No countdown. No timer. No elapsed time. (Success criterion 4)
    - Large "I'm Done" button at bottom
    - Optional: ambient visual (subtle gradient animation or breathing dot) to indicate the app is "alive" without showing time. Keep it minimal.
    - CRITICAL: Do NOT add any time-related information to this screen. The entire point is that the player relies on internal time sense.

    **AccuracyRevealView.swift:**
    - Shows the estimation result with animation:
      1. "You estimated: [formatted estimated time]"
      2. "It actually took: [formatted actual time]" (revealed with slight delay/animation)
      3. Difference: "[X]m [Y]s [over/under]" with visual direction indicator
      4. AccuracyMeter component showing accuracy percentage
      5. Feedback headline and body from FeedbackGenerator (curiosity-framed)
    - Overestimation vs underestimation: visually distinguish direction. Research says GAME-08 requires tracking both separately. Show "over" in one color, "under" in another. Not red/green (avoid pass/fail framing) -- use warm/cool neutrals or thematic colors.
    - If .way_off rating: frame as "Big Discovery!" not "Way off!" (GAME-05, GAME-06)
    - If calibration: show CalibrationTracker.calibrationSessionsRemaining() as "Calibration: X sessions to go"
    - SpriteView embedding: for .spot_on results, show AccuracyRevealScene (SpriteKit particle celebration). For other ratings, use SwiftUI animations only. This keeps SpriteKit minimal in Phase 1 per research recommendation.
    - "Continue" button to advance

    **SessionSummaryView.swift:**
    - Shows all task results for the completed session
    - For each task estimation (from session.orderedEstimations):
      - Task displayName
      - Estimated vs actual time
      - Accuracy rating icon (SF Symbol matching the rating)
      - Direction: over or under
    - Summary stats at top:
      - Average accuracy percentage
      - Best accuracy task
      - Number of overestimates vs underestimates (GAME-08)
    - If calibration: "Calibration session complete! [N] more to go before your baseline is set"
    - "Finish" button returns to PlayerHomeView

    **AccuracyMeter.swift (shared component):**
    - Takes accuracyPercent (Double, 0-100) and rating (AccuracyRating)
    - Visual: circular progress indicator or horizontal bar
    - Color coding by rating (NOT red/green -- use theme-appropriate colors):
      - .spot_on: gold/accent
      - .close: positive neutral
      - .off: cool neutral
      - .way_off: exploratory purple/discovery color
    - Animated fill on appear
    - Accessibility: `.accessibilityLabel("Accuracy: \(Int(accuracyPercent)) percent")`

    **Visual design direction (FEEL-04 -- age-appropriate for 13):**
    Apply consistent visual treatment across all player views:
    - Font: use system fonts with modern weight choices (.title, .headline, .body). No custom fonts in v1.
    - Colors: define a small color palette using Color extensions or asset catalog. Avoid primary/bright colors that feel childish. Think: muted tones with one accent color. Modern app aesthetic.
    - Spacing: generous padding (20-32pt), card-like surfaces with subtle shadows or background fills
    - Buttons: borderedProminent for primary actions, subtle for secondary. Rounded, modern feel.
    - Icons: SF Symbols throughout -- consistent weight and size
    - No cartoon characters, no excessive gamification chrome, no stars/badges in Phase 1
    - Aspirational tone: the app should feel like something a teen would choose to use, not something prescribed
  </action>
  <verify>
    Build: `xcodebuild build -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' 2>&1 | tail -10`. Must succeed.

    Verify no timer on TaskActiveView: grep TaskActiveView.swift for "timer", "Timer", "clock", "elapsed", "countdown", "timeInterval", "Date.now" -- none should appear in user-visible strings or display logic.

    Verify curiosity framing: grep AccuracyRevealView.swift and FeedbackGenerator.swift for "fail", "wrong", "bad", "poor" -- none should appear. Grep for "discovery", "interesting", "learning" -- should find these.

    Verify overestimate/underestimate tracking: grep SessionSummaryView.swift for "over" and "under" -- both should appear in the summary stats.
  </verify>
  <done>
    Complete quest flow works: select quest -> estimate each task -> do task (no clock) -> see accuracy feedback -> advance through all tasks -> session summary. GameSessionViewModel state machine handles all transitions. Estimation data is scored and persisted. TaskActiveView shows absolutely zero time information.
  </done>
</task>

<task type="auto">
  <name>Task 2: Onboarding, calibration framing, and SpriteKit accuracy scene</name>
  <files>
    TimeQuest/Features/Player/Views/OnboardingView.swift
    TimeQuest/Game/AccuracyRevealScene.swift
  </files>
  <action>
    **OnboardingView.swift -- first-launch experience (FEEL-05, FEEL-06):**
    A 3-screen onboarding flow shown ONLY on first launch (checked via UserDefaults "onboardingComplete").

    Screen 1 -- "This is your time game":
    - Large visual (SF Symbol or simple illustration placeholder)
    - Title: "TimeQuest" or "Your Time Game"
    - Body: Something like "Discover how your brain sees time. No clocks. No pressure. Just you and your gut feeling."
    - CRITICAL (FEEL-05): Explain the GAME, not the PROBLEM. Do NOT mention: "time blindness", "ADHD", "difficulty with time", "your parent set this up", "this will help you". The player should feel like she discovered a cool game, not that she was prescribed a tool.

    Screen 2 -- "Guess, do, discover":
    - Visual showing the three steps
    - Title: "How it works"
    - Body: "Pick a quest. Guess how long each step takes. Do it. Then see how close you were."
    - Keep it simple. One sentence per concept. (FEEL-06 progressive disclosure)

    Screen 3 -- "Your first sessions":
    - Visual (calibration/tuning metaphor)
    - Title: "Calibration mode"
    - Body: "Your first few sessions are calibration -- the game is learning YOUR patterns. Every guess teaches it something new."
    - Frame calibration as the game learning the player (not the player being tested). (PROG-07)
    - "Let's go" button that sets UserDefaults "onboardingComplete" = true and dismisses

    Implementation:
    - TabView with .tabViewStyle(.page) for swipe navigation between screens
    - Page indicator dots
    - "Skip" button available on all screens
    - "Next" button on screens 1-2, "Let's go" on screen 3
    - Clean, modern design matching the visual direction from Task 1

    **AccuracyRevealScene.swift -- SpriteKit celebration (minimal Phase 1):**
    An SKScene used via SpriteView in AccuracyRevealView for .spot_on results.

    - Scene background: clear (overlay on top of SwiftUI)
    - On scene load: burst of particles from center
    - Particle effect: small glowing dots/circles that expand outward and fade. Use SKEmitterNode programmatically (no .sks file needed for v1 -- keep it simple).
    - Duration: ~1.5 seconds, then scene goes idle
    - Colors: match the accent/gold color from the accuracy meter
    - Performance: minimal particles (30-50), short lifetime, auto-remove
    - Alternative if SpriteKit adds too much friction: use SwiftUI's built-in animations (.transition, .scaleEffect, .opacity) for the celebration effect and skip SpriteKit entirely for Phase 1. The research recommends minimal SpriteKit, and a SwiftUI-only approach is acceptable if it achieves the "moment of delight" for spot-on accuracy.

    **Integration notes:**
    - OnboardingView is shown by PlayerHomeView when UserDefaults "onboardingComplete" is false. Use a .fullScreenCover presentation.
    - AccuracyRevealScene is embedded in AccuracyRevealView via SpriteView(scene: AccuracyRevealScene()) only when the result rating is .spot_on. For other ratings, the SwiftUI animation in AccuracyRevealView is sufficient.
    - Calibration framing should be visible in: EstimationInputView (banner), AccuracyRevealView (sessions remaining text), SessionSummaryView (calibration session message). The GameSessionViewModel provides the isCalibration flag.
  </action>
  <verify>
    Build: `xcodebuild build -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' 2>&1 | tail -10`. Must succeed.

    Verify onboarding language: grep OnboardingView.swift for "time blindness", "ADHD", "parent", "problem", "difficulty", "help you" -- none should appear. Grep for "game", "quest", "discover" -- should find these.

    Verify calibration framing: grep for "calibration" or "Calibration" across player views -- should appear in OnboardingView, EstimationInputView, AccuracyRevealView, SessionSummaryView.

    Verify SpriteKit is minimal: only AccuracyRevealScene.swift should import SpriteKit. No other player view should import SpriteKit directly.
  </verify>
  <done>
    Onboarding explains the game in 3 screens without mentioning the problem (FEEL-05). Progressive disclosure: first session teaches one routine, one estimate, one result (FEEL-06). First 3 sessions per routine are framed as calibration with "game is learning YOUR patterns" messaging (PROG-07). SpriteKit particle effect fires on spot-on accuracy results. Visual design across all player views feels modern and age-appropriate for 13 (FEEL-04).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete gameplay loop on simulator</name>
  <files>none -- verification only</files>
  <action>
    Human verifies the complete TimeQuest Phase 1 experience on iOS Simulator. This checkpoint covers the FULL end-to-end flow across all three plans: app launch, onboarding, parent setup via hidden gesture + PIN, routine creation, quest selection, estimation, silent task execution, accuracy feedback, and session completion.

    Steps to verify:
    1. Launch the app in iOS Simulator (iPhone 16, iOS 17+)
    2. Verify onboarding appears on first launch -- read each screen: does it explain the game or lecture about a problem?
    3. Complete onboarding. Verify player home shows "No quests today" (no routines yet)
    4. Triple-tap the title area. Verify PIN entry appears with no "parent" language.
    5. Set a PIN. Verify you enter parent dashboard.
    6. Create a routine: set name ("School Morning"), display name ("Morning Quest"), schedule (Mon-Fri), add 3 tasks with display names. Time yourself -- should take under 5 minutes.
    7. Tap "Done" to return to player mode.
    8. Verify the quest appears on the home screen with its display name (NOT the internal name).
    9. Start the quest. Estimate the first task's duration using the picker. Tap "Lock It In."
    10. Verify the task-active screen shows NO clock, timer, or time information -- just the task name and a done button.
    11. Wait ~30 seconds, then tap "Done."
    12. Verify accuracy feedback: does it show estimated vs actual? Is the language curiosity-framed (not judgmental)?
    13. Complete all tasks in the routine.
    14. Verify session summary: shows all tasks, over/under estimates, average accuracy.
    15. Verify calibration messaging appears (e.g., "Calibration session" or "X sessions to go").
    16. Force-quit and relaunch. Verify data persists (the routine still exists, session history is preserved).
    17. Overall feel: does this look like a teen's game app or a clinical tool?
  </action>
  <verify>Human completes all 17 verification steps above and reports results.</verify>
  <done>Human types "approved" or describes issues that need fixing.</done>
</task>

</tasks>

<verification>
1. `xcodebuild build` succeeds with zero errors
2. Full quest flow: select -> estimate -> do (no clock) -> reveal -> next task -> summary (GAME-01 through GAME-08)
3. No timer/clock on TaskActiveView (GAME-02, GAME-03, success criterion 4)
4. Accuracy feedback is curiosity-framed with no judgment language (GAME-05, GAME-06)
5. Both over and underestimation tracked and shown (GAME-08)
6. Session completes when all tasks done (GAME-07)
7. Calibration framing on first 3 sessions per routine (PROG-07, success criterion 5)
8. Onboarding explains game, not problem (FEEL-05)
9. Progressive disclosure -- first session is simple (FEEL-06)
10. Age-appropriate visual design (FEEL-04)
11. Data persists across launches (FOUN-04, success criterion 5)
12. Zero parent language in player views (FOUN-03)
</verification>

<success_criteria>
- Player can select a quest from today's active routines (GAME-01)
- Player estimates each task duration before doing it (GAME-02)
- No visible timer during task execution (GAME-03, success criterion 4)
- Accuracy feedback shown with estimated vs actual and rating (GAME-04)
- Feedback is non-punitive, curiosity-framed (GAME-05)
- Large gaps are discoveries (GAME-06)
- Session completes after all tasks (GAME-07)
- Over/underestimation tracked separately (GAME-08)
- Onboarding explains game, not problem (FEEL-05)
- Progressive disclosure in first session (FEEL-06)
- Age-appropriate visual design (FEEL-04)
- First 3 sessions are calibration (PROG-07)
- All estimation data persists locally (FOUN-04)
</success_criteria>

<output>
After completion, create `.planning/phases/01-playable-foundation/01-03-SUMMARY.md`
</output>
