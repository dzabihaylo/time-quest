---
phase: 10-ui-brand-refresh
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - TimeQuest/Features/Player/Views/EstimationInputView.swift
  - TimeQuest/Features/Player/Views/TaskActiveView.swift
  - TimeQuest/Features/Player/Views/OnboardingView.swift
  - TimeQuest/Features/Player/Views/QuestView.swift
  - TimeQuest/Features/Player/Views/WeeklyReflectionCardView.swift
  - TimeQuest/Features/Player/Views/MyPatternsView.swift
  - TimeQuest/Features/Player/Views/NotificationSettingsView.swift
  - TimeQuest/Features/Player/Views/AccuracyTrendChartView.swift
  - TimeQuest/Features/Shared/Views/PINEntryView.swift
  - TimeQuest/Features/Shared/Components/NowPlayingIndicator.swift
  - TimeQuest/Game/CelebrationScene.swift
  - TimeQuest/Game/AccuracyRevealScene.swift
  - TimeQuest/Features/Parent/Views/RoutineEditorView.swift
  - TimeQuest/Features/Parent/Views/RoutineListView.swift
  - TimeQuest/Features/Parent/Views/ParentDashboardView.swift
  - TimeQuest/Features/Parent/Views/SchedulePickerView.swift
  - TimeQuest/Features/Parent/Views/CalendarSettingsView.swift
  - TimeQuest/Features/Parent/Views/SpotifySettingsView.swift
  - TimeQuest/Features/Parent/Views/PlaylistPickerView.swift
  - TimeQuest/Features/Parent/Views/TaskEditorView.swift
autonomous: true

must_haves:
  truths:
    - "Every remaining player-facing view uses tokens.font() for all typography"
    - "SpriteKit celebration scenes use token-derived color palettes instead of hardcoded SKColor literals"
    - "Parent views use design tokens for typography and colors while keeping Form-based layouts"
    - "Zero hardcoded Color(.systemGray*) references remain anywhere in the codebase"
    - "Zero bare .font(.headline) (non-token) calls remain in any view file"
  artifacts:
    - path: "TimeQuest/Game/CelebrationScene.swift"
      provides: "Token-palette-derived celebration particle colors"
      contains: "DesignTokens"
    - path: "TimeQuest/Game/AccuracyRevealScene.swift"
      provides: "Token-palette-derived accuracy reveal particle colors"
      contains: "DesignTokens"
    - path: "TimeQuest/Features/Player/Views/EstimationInputView.swift"
      provides: "Token-migrated estimation input"
      contains: "@Environment(\\.designTokens)"
  key_links:
    - from: "TimeQuest/Game/CelebrationScene.swift"
      to: "TimeQuest/App/DesignSystem/DesignTokens.swift"
      via: "DesignTokens() instance for color palette"
      pattern: "DesignTokens\\(\\)"
    - from: "TimeQuest/Features/Player/Views/EstimationInputView.swift"
      to: "TimeQuest/App/DesignSystem/DesignTokens.swift"
      via: "@Environment(\\.designTokens)"
      pattern: "tokens\\.font\\("
---

<objective>
Migrate all remaining views (8 player views, 1 shared view, 1 shared component, 8 parent views) and update SpriteKit celebration scenes to use token-derived color palettes. This completes the full-codebase migration.

Purpose: After Plans 01 and 02, the design system exists and the highest-traffic screens are migrated. This plan covers every remaining file to ensure zero hardcoded style values remain anywhere in the codebase.
Output: 20 files updated. Full codebase consistency achieved.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-ui-brand-refresh/10-RESEARCH.md
@.planning/phases/10-ui-brand-refresh/10-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate remaining player views, PINEntryView, and NowPlayingIndicator</name>
  <files>
    TimeQuest/Features/Player/Views/EstimationInputView.swift
    TimeQuest/Features/Player/Views/TaskActiveView.swift
    TimeQuest/Features/Player/Views/OnboardingView.swift
    TimeQuest/Features/Player/Views/QuestView.swift
    TimeQuest/Features/Player/Views/WeeklyReflectionCardView.swift
    TimeQuest/Features/Player/Views/MyPatternsView.swift
    TimeQuest/Features/Player/Views/NotificationSettingsView.swift
    TimeQuest/Features/Player/Views/AccuracyTrendChartView.swift
    TimeQuest/Features/Shared/Views/PINEntryView.swift
    TimeQuest/Features/Shared/Components/NowPlayingIndicator.swift
  </files>
  <action>
Apply the standard token migration pattern to each file:
1. Add `@Environment(\.designTokens) private var tokens`
2. Replace all `.font()` -> `tokens.font()` with appropriate weights
3. Replace all `Color(.systemGray*)` -> appropriate token (surfaceSecondary, surfaceTertiary, textTertiary)
4. Replace all inline colors (.teal, .orange, .purple, .blue, .red, .green) -> token references
5. Replace hardcoded cornerRadius values -> token constants
6. Replace card background patterns with `.tqCard()` where appropriate

**Specific per-file guidance:**

**EstimationInputView.swift** (MEDIUM -- 8 font calls, 2 hardcoded colors, 2 card backgrounds):
- Hint capsule: Check if it uses manual capsule styling and replace with `.tqChip(color: tokens.accent)` if appropriate
- All `.font()` -> `tokens.font()`
- Card backgrounds -> `tokens.surfaceSecondary` or `.tqCard()`

**TaskActiveView.swift** (MEDIUM -- 3 font calls, minimal colors):
- Simple migration -- just fonts and any stray colors

**OnboardingView.swift** (MEDIUM -- 4 font calls):
- Fonts only migration -- use `tokens.font()` for all text styles

**QuestView.swift** (LOW -- 1 font call, wrapper view):
- Minimal changes -- just migrate the single font call if present

**WeeklyReflectionCardView.swift** (MEDIUM -- 7 font calls, 2 hardcoded colors, 1 card background):
- Stat pills: Replace manual backgrounds with tokens
- Highlight chips: Replace `color.opacity(0.1)` background pattern -- these already follow chip-like styling, migrate to `.tqChip(color:)` OR update to use `tokens` colors directly if the chip modifier does not fit (some may be more complex than simple capsules)
- Card background -> `.tqCard()`

**MyPatternsView.swift** (LOW -- 4 font calls):
- Simple font migration

**NotificationSettingsView.swift** (LOW -- 4 font calls):
- Simple font migration. This uses Form/Toggle which have system styling -- only update explicit `.font()` calls and any manually styled sections.

**AccuracyTrendChartView.swift** (LOW -- 1 font call, 2 hardcoded colors):
- Replace chart-related colors (.teal for line marks) with `tokens.accent`
- Replace font calls with `tokens.font()`

**PINEntryView.swift** (MEDIUM -- 4 font calls, 1 hardcoded color):
- Replace `.red` error color with `tokens.negative`
- Replace all fonts with `tokens.font()`
- Replace any card/button backgrounds with tokens

**NowPlayingIndicator.swift** (LOW -- 3 font calls, already uses Material):
- This component already uses `.ultraThinMaterial` which is good. Just migrate font calls to `tokens.font()` and any stray inline colors to tokens.

**CRITICAL: Do NOT change view structure, conditional logic, @State variables, or animation blocks.** Styling-only migration.

After all 10 files are migrated, run the build.
  </action>
  <verify>
`xcodebuild -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5` shows BUILD SUCCEEDED. `grep -rn "Color(.systemGray" TimeQuest/Features/Player/ TimeQuest/Features/Shared/` returns zero matches.
  </verify>
  <done>
All 8 remaining player views, PINEntryView, and NowPlayingIndicator use design tokens exclusively. No hardcoded style values remain in any player-facing or shared view file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SpriteKit scenes and migrate parent views to design tokens</name>
  <files>
    TimeQuest/Game/CelebrationScene.swift
    TimeQuest/Game/AccuracyRevealScene.swift
    TimeQuest/Features/Parent/Views/RoutineEditorView.swift
    TimeQuest/Features/Parent/Views/RoutineListView.swift
    TimeQuest/Features/Parent/Views/ParentDashboardView.swift
    TimeQuest/Features/Parent/Views/SchedulePickerView.swift
    TimeQuest/Features/Parent/Views/CalendarSettingsView.swift
    TimeQuest/Features/Parent/Views/SpotifySettingsView.swift
    TimeQuest/Features/Parent/Views/PlaylistPickerView.swift
    TimeQuest/Features/Parent/Views/TaskEditorView.swift
  </files>
  <action>
**SpriteKit Scenes (2 files):**

**CelebrationScene.swift:**
SpriteKit scenes cannot use `@Environment` -- they are not SwiftUI views. Instead:
- Create a `private let tokens = DesignTokens()` instance in the class (since DesignTokens is a simple value container, this is fine)
- Replace the hardcoded SKColor arrays in `burstConfig(for:)`:
  - `.levelUp` colors: use `tokens.celebrationGolds`
  - `.personalBest` colors: use `tokens.celebrationTeals`
  - `.streak` colors: use `tokens.celebrationStreaks`
- This ensures celebration particles derive from the same color palette as the rest of the app

**AccuracyRevealScene.swift:**
- Same pattern: `private let tokens = DesignTokens()`
- Replace `randomGoldColor()` method to return from `tokens.celebrationGolds.randomElement() ?? .yellow`
- Alternatively, simplify by inlining: replace the hardcoded colors array in `randomGoldColor()` with `tokens.celebrationGolds`

**Parent Views (8 files):**

Parent views use Form-based layouts. Per research recommendation: apply design tokens (colors, typography) but keep Form-based layouts as-is since they are admin tools, not player-facing.

For each parent view:
1. Add `@Environment(\.designTokens) private var tokens`
2. Replace all `.font()` calls with `tokens.font()` equivalents
3. Replace any `Color(.systemGray*)` references with appropriate tokens
4. Replace any inline color names (.teal, .orange, etc.) with token references
5. Do NOT convert Form sections to card layouts -- keep the Form structure
6. For `Section` headers or footers that use explicit fonts, migrate to `tokens.font()`

**RoutineEditorView.swift** (MEDIUM -- 5 font calls, Form-based):
- Migrate fonts inside Form sections to `tokens.font()`
- Replace any stray color references with tokens
- Keep Form/Section structure intact

**RoutineListView.swift** (LOW -- 4 font calls):
- Simple font migration within List/ForEach

**ParentDashboardView.swift** (LOW -- navigation shell):
- Minimal changes -- migrate any explicit fonts

**SchedulePickerView.swift** (LOW -- 2 font calls, 1 color):
- Migrate fonts and the one color reference

**CalendarSettingsView.swift** (LOW -- 1 font call, 1 color):
- Migrate font and color

**SpotifySettingsView.swift** (LOW -- 1 font call, 1 color):
- Migrate font and color (connected status likely uses `.green` -> `tokens.positive`)

**PlaylistPickerView.swift** (LOW -- 4 font calls, 1 color):
- Migrate fonts and color

**TaskEditorView.swift** (LOW -- Form-based):
- Migrate any explicit fonts

After all files are migrated, run full build verification.

Then run a comprehensive audit:
```bash
# Verify zero hardcoded style values remain in ALL view files
grep -rn "Color(.systemGray" TimeQuest/Features/ TimeQuest/Game/ TimeQuest/App/RoleRouter.swift
grep -rn '\.font(\.\(headline\|title\|body\|caption\|subheadline\|largeTitle\|callout\|footnote\))' TimeQuest/Features/ --include="*.swift"
```

If any matches found, fix them before completing.
  </action>
  <verify>
`xcodebuild -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5` shows BUILD SUCCEEDED. `grep -rn "Color(.systemGray" TimeQuest/` returns zero matches (excluding any DesignTokens.swift system color wrappers). `grep -rn "SKColor(red:" TimeQuest/Game/` returns zero matches (all replaced with token references).
  </verify>
  <done>
All SpriteKit scenes use token-derived color palettes. All 8 parent views use design tokens for typography and colors. Zero hardcoded Color(.systemGray*) or SKColor literal values remain anywhere in the codebase. Full migration complete.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild build` succeeds with zero errors
2. `grep -rn "Color(.systemGray" TimeQuest/Features/ TimeQuest/Game/` returns zero matches
3. SpriteKit scenes reference DesignTokens for color palettes
4. Parent views maintain Form layouts but use design token typography and colors
5. Every `.swift` file under Features/ and Game/ that previously had hardcoded styles now uses tokens
</verification>

<success_criteria>
- All 20 remaining files migrated to design tokens
- SpriteKit celebration particles use token-derived colors matching the new palette
- Parent views use tokens while preserving Form-based admin layout
- Full codebase audit shows zero hardcoded style values in any view file
- Project compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-ui-brand-refresh/10-03-SUMMARY.md`
</output>
