---
phase: 08-calendar-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TimeQuest/Models/Schemas/TimeQuestSchemaV5.swift
  - TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift
  - TimeQuest/Models/Routine.swift
  - TimeQuest/Models/RoutineTask.swift
  - TimeQuest/Models/GameSession.swift
  - TimeQuest/Models/TaskEstimation.swift
  - TimeQuest/Models/PlayerProfile.swift
  - TimeQuest/Models/TaskDifficultyState.swift
  - TimeQuest/App/TimeQuestApp.swift
  - TimeQuest/Domain/DayContext.swift
  - TimeQuest/Domain/CalendarContextEngine.swift
  - generate-xcodeproj.js
autonomous: true

must_haves:
  truths:
    - "Routine model has a calendarModeRaw field that defaults to 'always' so all existing routines continue to appear on their scheduled days"
    - "CalendarContextEngine produces the correct DayContext given a set of calendar events and a date"
    - "When DayContext is .unknown, all routines show regardless of calendarMode (backward compatibility)"
    - "App launches and builds successfully with V5 schema and V4-to-V5 migration"
  artifacts:
    - path: "TimeQuest/Models/Schemas/TimeQuestSchemaV5.swift"
      provides: "V5 schema with calendarModeRaw on Routine"
      contains: "calendarModeRaw"
    - path: "TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift"
      provides: "V4-to-V5 lightweight migration"
      contains: "v4ToV5"
    - path: "TimeQuest/Domain/DayContext.swift"
      provides: "DayContext enum (.schoolDay, .freeDay, .unknown)"
      contains: "enum DayContext"
    - path: "TimeQuest/Domain/CalendarContextEngine.swift"
      provides: "Pure engine determining day context from calendar events"
      contains: "determineContext"
  key_links:
    - from: "TimeQuest/Models/Schemas/TimeQuestSchemaV5.swift"
      to: "TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift"
      via: "V5 added to schemas array and v4ToV5 migration stage"
      pattern: "TimeQuestSchemaV5"
    - from: "TimeQuest/Models/Routine.swift"
      to: "TimeQuest/Models/Schemas/TimeQuestSchemaV5.swift"
      via: "typealias updated to V5"
      pattern: "TimeQuestSchemaV5\\.Routine"
    - from: "TimeQuest/App/TimeQuestApp.swift"
      to: "TimeQuest/Models/Schemas/TimeQuestSchemaV5.swift"
      via: "ModelContainer references V5 schema types"
      pattern: "TimeQuestSchemaV5"
---

<objective>
Create SchemaV5 with calendarModeRaw field on Routine and build the pure CalendarContextEngine domain logic.

Purpose: Establishes the data model for calendar-aware routine filtering and the core heuristic engine that determines whether today is a school day, free day, or unknown. This foundation is needed before any EventKit integration or UI work.

Output: SchemaV5 with lightweight migration, DayContext enum, CalendarContextEngine pure struct, all typealiases updated, build passing.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-calendar-intelligence/08-RESEARCH.md
@.planning/phases/07-schema-evolution-adaptive-difficulty/07-01-SUMMARY.md

Key references (read these during execution):
@TimeQuest/Models/Schemas/TimeQuestSchemaV4.swift - Current schema to copy and extend
@TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift - Current migration chain to extend
@TimeQuest/Models/Routine.swift - Current typealias to update
@TimeQuest/App/TimeQuestApp.swift - ModelContainer to update
@TimeQuest/Domain/DifficultyConfiguration.swift - Pattern for pure Foundation domain structs
@generate-xcodeproj.js - File registration
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SchemaV5 with calendarModeRaw on Routine, update migration chain and typealiases</name>
  <files>
    TimeQuest/Models/Schemas/TimeQuestSchemaV5.swift
    TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift
    TimeQuest/Models/Routine.swift
    TimeQuest/Models/RoutineTask.swift
    TimeQuest/Models/GameSession.swift
    TimeQuest/Models/TaskEstimation.swift
    TimeQuest/Models/PlayerProfile.swift
    TimeQuest/Models/TaskDifficultyState.swift
    TimeQuest/App/TimeQuestApp.swift
    generate-xcodeproj.js
  </files>
  <action>
    1. Create TimeQuest/Models/Schemas/TimeQuestSchemaV5.swift:
       - Copy the full V4 schema structure (all 6 model classes: Routine, RoutineTask, GameSession, TaskEstimation, PlayerProfile, TaskDifficultyState)
       - Change enum name to TimeQuestSchemaV5, version to Schema.Version(5, 0, 0)
       - Add `var calendarModeRaw: String = "always"` to the Routine model (after updatedAt, before relationships)
       - Add calendarModeRaw to Routine's init parameters with default value "always"
       - Follow the exact same patterns from V4: @preconcurrency import SwiftData, nonisolated(unsafe) for versionIdentifier, fully qualified inverse keypaths using TimeQuestSchemaV5
       - All other models remain identical to V4 but with TimeQuestSchemaV5 qualifier on inverse keypaths

    2. Update TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift:
       - Add TimeQuestSchemaV5.self to the schemas array
       - Add v4ToV5 migration stage: MigrationStage.lightweight(fromVersion: TimeQuestSchemaV4.self, toVersion: TimeQuestSchemaV5.self)
       - Add v4ToV5 to the stages array

    3. Update all 6 typealias files to point to V5:
       - Routine.swift: typealias Routine = TimeQuestSchemaV5.Routine
       - RoutineTask.swift: typealias RoutineTask = TimeQuestSchemaV5.RoutineTask
       - GameSession.swift: typealias GameSession = TimeQuestSchemaV5.GameSession
       - TaskEstimation.swift: typealias TaskEstimation = TimeQuestSchemaV5.TaskEstimation
       - PlayerProfile.swift: typealias PlayerProfile = TimeQuestSchemaV5.PlayerProfile
       - TaskDifficultyState.swift: typealias TaskDifficultyState = TimeQuestSchemaV5.TaskDifficultyState

    4. Update TimeQuestApp.swift:
       - Change all TimeQuestSchemaV4 references to TimeQuestSchemaV5 in both ModelContainer init paths (CloudKit and local-only)

    5. Register TimeQuestSchemaV5.swift in generate-xcodeproj.js:
       - Add to sourceFiles array: { name: 'TimeQuestSchemaV5.swift', path: 'Models/Schemas/TimeQuestSchemaV5.swift' }
       - Add to Schemas group files array: 'TimeQuestSchemaV5.swift'

    IMPORTANT: The calendarModeRaw field must have a default value of "always" so existing routines continue to work without any data migration beyond the lightweight schema change. This is the same pattern used for all prior schema additions (cloudID, difficultyLevel, xpMultiplier).
  </action>
  <verify>
    Run: cd /Users/davezabihaylo/Projects/GSD && node generate-xcodeproj.js && xcodebuild -project TimeQuest.xcodeproj/project.pbxproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
    Build must succeed with 0 errors.
  </verify>
  <done>
    SchemaV5 exists with calendarModeRaw on Routine (default "always"). V4-to-V5 lightweight migration in chain. All typealiases point to V5. TimeQuestApp references V5. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DayContext enum and CalendarContextEngine pure domain logic</name>
  <files>
    TimeQuest/Domain/DayContext.swift
    TimeQuest/Domain/CalendarContextEngine.swift
    generate-xcodeproj.js
  </files>
  <action>
    1. Create TimeQuest/Domain/DayContext.swift:
       - Import Foundation only (no SwiftData, no EventKit)
       - Define enum DayContext: Sendable, Equatable with cases:
         - .schoolDay (school events present, no "no school" markers)
         - .freeDay(reason: String?) (holiday, break, summer, weekend, or no school events found)
         - .unknown (calendar access denied or no data -- show everything)
       - Add Equatable conformance (auto-synthesized works for simple enums but freeDay has associated value, so implement == manually: .schoolDay == .schoolDay, .freeDay == .freeDay regardless of reason, .unknown == .unknown)

    2. Create TimeQuest/Domain/CalendarContextEngine.swift:
       - Import Foundation only (pure domain engine, no EventKit dependency)
       - Define CalendarEvent struct (Sendable): title: String, isAllDay: Bool, startDate: Date, endDate: Date, calendarTitle: String
       - Define CalendarContextEngine struct (Sendable) with:
         - Static let noSchoolKeywords: [String] = ["no school", "school closed", "holiday", "break", "vacation", "teacher workday", "professional day", "snow day", "day off", "inservice", "in-service", "early release", "conference day", "pd day"]
         - func determineContext(events: [CalendarEvent], date: Date) -> DayContext:
           a. If events is empty: check weekday -- weekends (Sun=1, Sat=7) return .freeDay(reason: nil), weekdays return .unknown
           b. Check all event titles (lowercased) against noSchoolKeywords. If any match, return .freeDay(reason: matchedTitle)
           c. If events exist but none match no-school keywords, return .schoolDay
         - func filterRoutines(_ routines: [RoutineFilterable], for context: DayContext) -> [RoutineFilterable] where RoutineFilterable is a protocol with calendarModeRaw: String
           Actually, simpler approach: func shouldShow(calendarMode: String, in context: DayContext) -> Bool:
           - "always" -> true
           - "schoolDayOnly" -> context == .schoolDay || context == .unknown
           - "freeDayOnly" -> context is .freeDay || context == .unknown
           - default -> true

    3. Register both files in generate-xcodeproj.js:
       - sourceFiles: { name: 'DayContext.swift', path: 'Domain/DayContext.swift' } and { name: 'CalendarContextEngine.swift', path: 'Domain/CalendarContextEngine.swift' }
       - Domain group files array: add 'DayContext.swift' and 'CalendarContextEngine.swift'

    Pattern notes: This follows the exact same pattern as InsightEngine and AdaptiveDifficultyEngine -- pure Foundation struct, Sendable, no framework dependencies, testable with fabricated data. The CalendarEvent struct is the value-type bridge (like EstimationSnapshot and DifficultySnapshot) but lives here because it is not a SwiftData bridge -- it bridges EventKit, which Plan 02 will handle.
  </action>
  <verify>
    Run: cd /Users/davezabihaylo/Projects/GSD && node generate-xcodeproj.js && xcodebuild -project TimeQuest.xcodeproj/project.pbxproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
    Build must succeed. DayContext.swift and CalendarContextEngine.swift must exist on disk.
  </verify>
  <done>
    DayContext enum with .schoolDay, .freeDay(reason:), .unknown exists. CalendarContextEngine with determineContext() and shouldShow() exists. Both are pure Foundation, Sendable, with no EventKit dependency. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild build` succeeds with zero errors
2. SchemaV5 has calendarModeRaw field on Routine with default "always"
3. Migration chain includes V4-to-V5 lightweight stage
4. All typealiases point to V5
5. CalendarContextEngine.determineContext() handles: empty events + weekend, empty events + weekday, no-school keyword match, school events present
6. CalendarContextEngine.shouldShow() correctly handles "always", "schoolDayOnly", "freeDayOnly" modes
7. No EventKit import anywhere in Plan 01 files
</verification>

<success_criteria>
- Build passes with V5 schema
- CalendarContextEngine is pure Foundation (no EventKit, no SwiftData imports)
- DayContext enum is Sendable and Equatable
- Routine model has calendarModeRaw defaulting to "always"
- All 6 model typealiases updated to V5
</success_criteria>

<output>
After completion, create `.planning/phases/08-calendar-intelligence/08-01-SUMMARY.md`
</output>
