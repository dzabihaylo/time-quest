---
phase: 08-calendar-intelligence
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - TimeQuest/Features/Parent/Views/CalendarSettingsView.swift
  - TimeQuest/Features/Parent/Views/CalendarChooserView.swift
  - TimeQuest/Features/Parent/Views/ParentDashboardView.swift
  - TimeQuest/Features/Parent/Views/RoutineEditorView.swift
  - TimeQuest/Features/Player/Views/PlayerHomeView.swift
  - generate-xcodeproj.js
autonomous: true

must_haves:
  truths:
    - "On a school day, the player sees school morning routines surfaced automatically"
    - "On a holiday or free day, school-specific routines (calendarMode=schoolDayOnly) are hidden"
    - "A player who denies calendar permission sees the app identically to v2.0 -- no broken screens, no nagging"
    - "Parent can enable calendar access and select school calendars from parent settings"
    - "Parent can set a routine's calendar mode to schoolDayOnly, freeDayOnly, or always in the routine editor"
    - "A passive context chip above the quest list shows 'School day' or 'Free day' when calendar is active"
  artifacts:
    - path: "TimeQuest/Features/Parent/Views/CalendarSettingsView.swift"
      provides: "Parent UI for calendar permission and calendar selection"
      contains: "CalendarSettingsView"
    - path: "TimeQuest/Features/Parent/Views/CalendarChooserView.swift"
      provides: "UIViewControllerRepresentable wrapper for EKCalendarChooser"
      contains: "EKCalendarChooser"
    - path: "TimeQuest/Features/Player/Views/PlayerHomeView.swift"
      provides: "Calendar-filtered quest list with context chip"
      contains: "CalendarContextEngine"
  key_links:
    - from: "TimeQuest/Features/Player/Views/PlayerHomeView.swift"
      to: "TimeQuest/Services/CalendarService.swift"
      via: "dependencies.calendarService for event fetching"
      pattern: "calendarService"
    - from: "TimeQuest/Features/Player/Views/PlayerHomeView.swift"
      to: "TimeQuest/Domain/CalendarContextEngine.swift"
      via: "CalendarContextEngine().determineContext() for day classification and shouldShow() for filtering"
      pattern: "determineContext|shouldShow"
    - from: "TimeQuest/Features/Parent/Views/CalendarSettingsView.swift"
      to: "TimeQuest/Services/CalendarService.swift"
      via: "Uses CalendarService for permission request, access check, and calendar selection persistence"
      pattern: "calendarService"
    - from: "TimeQuest/Features/Parent/Views/RoutineEditorView.swift"
      to: "TimeQuest/Models/Schemas/TimeQuestSchemaV5.swift"
      via: "Routine.calendarModeRaw picker in editor"
      pattern: "calendarModeRaw"
---

<objective>
Wire calendar intelligence into parent and player UI: calendar settings for parents, calendarMode picker in routine editor, filtered quest list with context chip for players.

Purpose: This is the user-facing payoff of the calendar intelligence feature. Parents get a settings screen to enable calendar access and select school calendars, plus a calendarMode picker per routine. Players see their quest list automatically filtered by day context with a passive context chip. Without calendar permission, the app works identically to v2.0.

Output: CalendarSettingsView, CalendarChooserView, calendarMode picker in RoutineEditorView, calendar-filtered PlayerHomeView with context chip, navigation wiring in ParentDashboardView.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-calendar-intelligence/08-RESEARCH.md
@.planning/phases/08-calendar-intelligence/08-01-SUMMARY.md
@.planning/phases/08-calendar-intelligence/08-02-SUMMARY.md

Key references (read these during execution):
@TimeQuest/Services/CalendarService.swift - CalendarService from Plan 02
@TimeQuest/App/AppDependencies.swift - CalendarService registered here (from Plan 02)
@TimeQuest/Features/Player/Views/PlayerHomeView.swift - Where to wire calendar filtering
@TimeQuest/Features/Parent/Views/RoutineEditorView.swift - Where to add calendarMode picker
@TimeQuest/Features/Parent/Views/ParentDashboardView.swift - Where to add calendar settings nav
@TimeQuest/Domain/CalendarContextEngine.swift - Pure engine to wire to real data (from Plan 01)
@TimeQuest/Domain/DayContext.swift - DayContext enum (from Plan 01)
@generate-xcodeproj.js - File registration
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CalendarSettingsView, CalendarChooserView, and add navigation from ParentDashboard</name>
  <files>
    TimeQuest/Features/Parent/Views/CalendarSettingsView.swift
    TimeQuest/Features/Parent/Views/CalendarChooserView.swift
    TimeQuest/Features/Parent/Views/ParentDashboardView.swift
    generate-xcodeproj.js
  </files>
  <action>
    1. Create TimeQuest/Features/Parent/Views/CalendarChooserView.swift:
       - Import SwiftUI and EventKitUI
       - UIViewControllerRepresentable wrapping EKCalendarChooser
       - Init takes: @Binding var selectedCalendarIDs: [String], eventStore: EKEventStore
       - makeUIViewController: create EKCalendarChooser(selectionStyle: .multiple, displayStyle: .allCalendars, entityType: .event, eventStore: eventStore), set showsDoneButton = true, showsCancelButton = true
       - Pre-select calendars from selectedCalendarIDs via eventStore.calendar(withIdentifier:)
       - Coordinator implements EKCalendarChooserDelegate:
         - calendarChooserDidFinish: update binding with selected calendar identifiers, dismiss
         - calendarChooserDidCancel: dismiss
       - Wrap in UINavigationController for done/cancel buttons to work

    2. Create TimeQuest/Features/Parent/Views/CalendarSettingsView.swift:
       - Import SwiftUI and EventKit
       - @Environment(AppDependencies.self) private var dependencies
       - @State private var hasAccess: Bool (initialized from calendarService.hasAccess)
       - @State private var selectedCalendarIDs: [String] (initialized from calendarService.selectedCalendarIDs() ?? [])
       - @State private var selectedCalendarNames: [String] (from UserDefaults)
       - @State private var showingCalendarChooser = false
       - Body: Form with sections:
         a. "Calendar Access" section:
            - If hasAccess: green checkmark + "Calendar access granted"
            - If !hasAccess: Button "Enable Calendar Access" that calls requestAccess()
            - Footer: "TimeQuest reads your calendar to detect school days and holidays. Calendar data is never stored."
         b. "School Calendars" section (only if hasAccess):
            - If selectedCalendarIDs not empty: list selected calendar names
            - Button "Select Calendars" that shows CalendarChooserView sheet
            - Footer: "Select the calendars that contain your school schedule. If none selected, all calendars are scanned."
         c. "How It Works" section:
            - Static text explaining: "TimeQuest looks for events like 'No School', 'Holiday', or 'Break' in your calendar. On those days, school-only routines are hidden automatically."
       - requestAccess() method: let granted = await dependencies.calendarService.requestAccess(); hasAccess = granted
       - On calendar chooser dismiss: save selected IDs and names via calendarService

    3. Update TimeQuest/Features/Parent/Views/ParentDashboardView.swift:
       - Add a NavigationLink to CalendarSettingsView
       - Since ParentDashboardView uses NavigationStack, add: .toolbar { ToolbarItem(placement: .bottomBar) { NavigationLink { CalendarSettingsView() } label: { Label("Calendar", systemImage: "calendar.badge.clock") } } }
       - Read ParentDashboardView first to find the best insertion point -- if toolbar already has items, add to existing toolbar modifier

    4. Register new files in generate-xcodeproj.js:
       - sourceFiles: CalendarSettingsView.swift (path: Features/Parent/Views/CalendarSettingsView.swift), CalendarChooserView.swift (path: Features/Parent/Views/CalendarChooserView.swift)
       - ParentViews group: add 'CalendarSettingsView.swift' and 'CalendarChooserView.swift'
  </action>
  <verify>
    Run: cd /Users/davezabihaylo/Projects/GSD && node generate-xcodeproj.js && xcodebuild -project TimeQuest.xcodeproj/project.pbxproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
    Build must succeed. CalendarSettingsView.swift and CalendarChooserView.swift must exist on disk. ParentDashboardView must have navigation to CalendarSettingsView.
  </verify>
  <done>
    CalendarSettingsView with permission toggle, calendar chooser, and explainer text exists. CalendarChooserView wraps EKCalendarChooser. ParentDashboardView navigates to CalendarSettingsView. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add calendarMode picker to RoutineEditor and wire PlayerHomeView calendar filtering with context chip</name>
  <files>
    TimeQuest/Features/Parent/Views/RoutineEditorView.swift
    TimeQuest/Features/Player/Views/PlayerHomeView.swift
  </files>
  <action>
    1. Update TimeQuest/Features/Parent/Views/RoutineEditorView.swift:
       - Add a new section "Calendar Mode" between scheduleSection and tasksSection
       - Section contains a Picker bound to viewModel.editState calendarModeRaw (or a new @State property if editState doesn't have it yet)
       - Since editState is a value type used by RoutineEditorViewModel, and Routine now has calendarModeRaw, the editState should already carry it. Read RoutineEditorViewModel to confirm.
       - If editState does not include calendarModeRaw yet: add it to the edit state struct in RoutineEditorViewModel, populate from routine.calendarModeRaw in init, and write back to routine on save.
       - Picker options: "Always" (value "always"), "School Days Only" (value "schoolDayOnly"), "Free Days Only" (value "freeDayOnly")
       - Section footer: "Controls when this routine appears based on calendar context"
       - IMPORTANT: Read RoutineEditorViewModel.swift first to understand the edit state pattern before modifying.

    2. Update TimeQuest/Features/Player/Views/PlayerHomeView.swift:
       - Add @State private var dayContext: DayContext = .unknown
       - Modify loadTodayQuests() (or equivalent quest-loading function):
         a. Fetch routines as before: let repo = SwiftDataRoutineRepository(...); let allToday = repo.fetchActiveForToday()
         b. Check if calendar service has access: if dependencies.calendarService.hasAccess
         c. If yes: let calendarIDs = dependencies.calendarService.selectedCalendarIDs(); let events = dependencies.calendarService.fetchTodayEvents(from: calendarIDs); let context = CalendarContextEngine().determineContext(events: events, date: .now); dayContext = context
         d. Filter: todayQuests = allToday.filter { CalendarContextEngine().shouldShow(calendarMode: $0.calendarModeRaw, in: dayContext) }
         e. If no calendar access: dayContext = .unknown; todayQuests = allToday (no filtering -- CAL-03)
       - Add a context chip above the quest list (between any existing header content and the quest list):
         - Only show when dayContext != .unknown AND calendar has access
         - For .schoolDay: HStack with Image(systemName: "backpack.fill") + Text("School day") in a capsule with blue tint
         - For .freeDay(let reason): HStack with Image(systemName: "sun.max.fill") + Text(reason ?? "Free day") in a capsule with orange tint. Truncate reason with lineLimit(1)
         - Style: .font(.caption), .padding(.horizontal, 12), .padding(.vertical, 6), .background(Color.tint.opacity(0.1)), .clipShape(Capsule())
         - CAL-05: passive language only -- "School day", "Free day", "Holiday break" -- NEVER directive ("Time for homework!")

    CRITICAL: When calendar access is denied, the app MUST work identically to v2.0. dayContext defaults to .unknown, shouldShow() returns true for all modes when context is .unknown. No error messages, no nag prompts, no broken UI.

    CRITICAL: Calendar data is NEVER persisted. CalendarService.fetchTodayEvents() reads fresh from EventKit each time. Only the calendar IDENTIFIERS (which calendars to scan) are stored in UserDefaults -- not events.

    CRITICAL: Context chip uses passive language per CAL-05. "School day" and "Free day" are observations, not directives.
  </action>
  <verify>
    Run: cd /Users/davezabihaylo/Projects/GSD && node generate-xcodeproj.js && xcodebuild -project TimeQuest.xcodeproj/project.pbxproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
    Build must succeed. RoutineEditorView must contain a calendarMode picker. PlayerHomeView must reference CalendarContextEngine and CalendarService.
  </verify>
  <done>
    Routine editor has calendarMode picker (always/schoolDayOnly/freeDayOnly). PlayerHomeView filters routines by DayContext and shows passive context chip. Calendar-denied users see no change from v2.0. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild build` succeeds with zero errors
2. CalendarSettingsView provides permission toggle, calendar chooser, and how-it-works explainer
3. CalendarChooserView wraps EKCalendarChooser with proper done/cancel handling
4. ParentDashboardView navigates to CalendarSettingsView
5. Routine editor includes calendarMode picker with three options
6. PlayerHomeView applies calendar filtering when access is granted, skips when denied
7. Context chip shows passive language ("School day", "Free day") -- no directive language
8. App with no calendar access works identically to pre-Phase-8
</verification>

<success_criteria>
- Build passes with all calendar UI features
- Parent can enable calendar access and select calendars from CalendarSettingsView
- Parent can set calendarMode per routine in RoutineEditorView
- PlayerHomeView filters routines by calendar context
- Context chip shows passive day context above quest list
- No directive language in UI (CAL-05)
- Calendar denial = identical experience to v2.0 (CAL-03)
</success_criteria>

<output>
After completion, create `.planning/phases/08-calendar-intelligence/08-03-SUMMARY.md`
</output>
