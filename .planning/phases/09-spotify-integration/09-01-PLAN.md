---
phase: 09-spotify-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TimeQuest/Models/Schemas/TimeQuestSchemaV6.swift
  - TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift
  - TimeQuest/Models/Routine.swift
  - TimeQuest/Models/RoutineTask.swift
  - TimeQuest/Models/GameSession.swift
  - TimeQuest/Models/TaskEstimation.swift
  - TimeQuest/Models/PlayerProfile.swift
  - TimeQuest/Models/TaskDifficultyState.swift
  - TimeQuest/Models/SpotifyModels.swift
  - TimeQuest/Domain/SpotifyPlaylistMatcher.swift
  - TimeQuest/App/TimeQuestApp.swift
  - generate-xcodeproj.js
autonomous: true

must_haves:
  truths:
    - "SchemaV6 adds spotifyPlaylistID and spotifyPlaylistName to Routine with nil defaults (lightweight migration)"
    - "SchemaV6 adds spotifySongCount to GameSession with nil default (lightweight migration)"
    - "All Codable model types decode Spotify Web API JSON responses without error"
    - "SpotifyPlaylistMatcher computes fractional song count from track durations and target duration"
    - "Project builds successfully with V5-to-V6 migration in the chain"
  artifacts:
    - path: "TimeQuest/Models/Schemas/TimeQuestSchemaV6.swift"
      provides: "V6 schema with Spotify fields on Routine and GameSession"
      contains: "spotifyPlaylistID"
    - path: "TimeQuest/Models/SpotifyModels.swift"
      provides: "Codable structs for Spotify Web API responses"
      contains: "PagingObject"
    - path: "TimeQuest/Domain/SpotifyPlaylistMatcher.swift"
      provides: "Pure domain engine for duration matching and song count formatting"
      contains: "matchDuration"
    - path: "TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift"
      provides: "V5-to-V6 migration stage"
      contains: "v5ToV6"
  key_links:
    - from: "TimeQuest/Models/Routine.swift"
      to: "TimeQuestSchemaV6.Routine"
      via: "typealias"
      pattern: "typealias Routine = TimeQuestSchemaV6"
    - from: "TimeQuest/App/TimeQuestApp.swift"
      to: "TimeQuestSchemaV6"
      via: "ModelContainer schema reference"
      pattern: "TimeQuestSchemaV6"
---

<objective>
Create the data foundation for Spotify integration: SchemaV6 with Spotify fields on Routine and GameSession, Codable model types for Spotify Web API responses, and SpotifyPlaylistMatcher pure domain engine for duration-based song counting.

Purpose: All subsequent plans (auth, UI, playback) depend on these types existing. The schema must migrate cleanly from V5, the Codable models must match the Spotify Web API response shapes, and the matcher must produce human-readable song count labels.
Output: SchemaV6.swift, SpotifyModels.swift, SpotifyPlaylistMatcher.swift, updated migration chain, updated typealiases.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-spotify-integration/09-RESEARCH.md

@TimeQuest/Models/Schemas/TimeQuestSchemaV5.swift
@TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift
@TimeQuest/Models/Routine.swift
@TimeQuest/Models/GameSession.swift
@TimeQuest/App/TimeQuestApp.swift
@generate-xcodeproj.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SchemaV6 with Spotify fields, update migration chain and typealiases</name>
  <files>
    TimeQuest/Models/Schemas/TimeQuestSchemaV6.swift
    TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift
    TimeQuest/Models/Routine.swift
    TimeQuest/Models/RoutineTask.swift
    TimeQuest/Models/GameSession.swift
    TimeQuest/Models/TaskEstimation.swift
    TimeQuest/Models/PlayerProfile.swift
    TimeQuest/Models/TaskDifficultyState.swift
    TimeQuest/App/TimeQuestApp.swift
  </files>
  <action>
    Create TimeQuestSchemaV6.swift by copying V5 and adding three new optional fields to Routine:
    - `var spotifyPlaylistID: String? = nil` (Spotify playlist ID for linked playlist)
    - `var spotifyPlaylistName: String? = nil` (cached display name to avoid API call)

    Add one new optional field to GameSession:
    - `var spotifySongCount: String? = nil` (formatted song count label like "4.5 songs", stored at session completion)

    All new fields MUST have nil defaults for lightweight migration compatibility (CloudKit constraint -- no custom migration blocks).

    Update the Routine init to include spotifyPlaylistID and spotifyPlaylistName parameters with nil defaults.
    Update the GameSession init to include spotifySongCount parameter with nil default.

    In TimeQuestMigrationPlan.swift:
    - Add TimeQuestSchemaV6.self to the schemas array
    - Add v5ToV6 lightweight migration stage
    - Add to stages array

    Update ALL 6 model typealias files to point to V6:
    - Routine.swift: `typealias Routine = TimeQuestSchemaV6.Routine`
    - RoutineTask.swift: `typealias RoutineTask = TimeQuestSchemaV6.RoutineTask`
    - GameSession.swift: `typealias GameSession = TimeQuestSchemaV6.GameSession`
    - TaskEstimation.swift: `typealias TaskEstimation = TimeQuestSchemaV6.TaskEstimation`
    - PlayerProfile.swift: `typealias PlayerProfile = TimeQuestSchemaV6.PlayerProfile`
    - TaskDifficultyState.swift: `typealias TaskDifficultyState = TimeQuestSchemaV6.TaskDifficultyState`

    Update TimeQuestApp.swift ModelContainer to reference V6 schema types.

    Follow exact patterns from V4->V5 migration (see 08-01-SUMMARY.md):
    - `@preconcurrency import SwiftData`
    - `nonisolated(unsafe) static var versionIdentifier`
    - Fully qualified relationship inverse keypaths (`\TimeQuestSchemaV6.RoutineTask.routine`)
  </action>
  <verify>Run `node generate-xcodeproj.js && xcodebuild -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5` -- build succeeds with no errors.</verify>
  <done>SchemaV6 compiles, all typealiases point to V6, migration chain includes V5-to-V6, app builds with no schema errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create SpotifyModels Codable types and SpotifyPlaylistMatcher domain engine</name>
  <files>
    TimeQuest/Models/SpotifyModels.swift
    TimeQuest/Domain/SpotifyPlaylistMatcher.swift
  </files>
  <action>
    Create SpotifyModels.swift with Codable structs matching Spotify Web API response shapes. All types must be Sendable. Use CodingKeys for snake_case to camelCase mapping.

    Types to create:
    - `PagingObject<T: Codable & Sendable>: Codable, Sendable` -- `items: [T]`, `next: String?`, `total: Int`
    - `SpotifyPlaylist: Codable, Sendable, Identifiable` -- `id: String`, `name: String`, `images: [SpotifyImage]`, `tracks: PlaylistTracksRef` (nested struct with `total: Int`)
    - `SpotifyImage: Codable, Sendable` -- `url: String`, `height: Int?`, `width: Int?`
    - `PlaylistTrackItem: Codable, Sendable` -- `track: SpotifyTrack?` (track can be nil for local/unavailable tracks)
    - `SpotifyTrack: Codable, Sendable` -- `name: String`, `durationMs: Int` (CodingKey: "duration_ms"), `artists: [SpotifyArtist]`, `album: SpotifyAlbum?`
    - `SpotifyArtist: Codable, Sendable` -- `name: String`
    - `SpotifyAlbum: Codable, Sendable` -- `images: [SpotifyImage]`
    - `CurrentlyPlayingResponse: Codable, Sendable` -- `isPlaying: Bool` (CodingKey: "is_playing"), `item: SpotifyTrack?`, `progressMs: Int?` (CodingKey: "progress_ms")
    - `NowPlayingInfo: Sendable` (NOT Codable -- derived from CurrentlyPlayingResponse) -- `trackName: String`, `artistName: String`, `albumArtURL: String?`, `durationMs: Int`, `progressMs: Int`
    - Add `func toNowPlayingInfo() -> NowPlayingInfo?` on CurrentlyPlayingResponse that returns nil when not playing or no item
    - `SpotifyUserProfile: Codable, Sendable` -- `id: String`, `displayName: String?` (CodingKey: "display_name")
    - `SpotifyError: Error, Sendable` -- cases: `notConnected`, `authCancelled`, `tokenExpired`, `httpError(statusCode: Int)`, `invalidResponse`, `keychainError(OSStatus)`, `rateLimited`

    Create SpotifyPlaylistMatcher.swift as a pure Foundation-only Sendable struct (same pattern as TimeEstimationScorer, InsightEngine). NO SwiftData, NO UIKit imports.

    The matcher:
    - `struct PlaylistMatchResult: Sendable` with `trackCount: Int`, `totalDurationSeconds: Double`, `songCountLabel: String`
    - `struct SpotifyPlaylistMatcher: Sendable` with:
      - `func matchDuration(trackDurationsMs: [Int], targetDurationSeconds: Double) -> PlaylistMatchResult` -- iterates tracks in order, accumulates duration until >= target. Calculates fractional song count = targetMs / averageTrackMs. Returns formatted label.
      - `func formatSongCount(_ count: Double) -> String` -- rounds to nearest 0.5. Returns "less than 1 song" for < 0.5, "1 song" for 1.0, "N songs" for whole numbers, "N.5 songs" for halves.

    Both files: Foundation import only.
  </action>
  <verify>Run `node generate-xcodeproj.js && xcodebuild -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5` -- build succeeds.</verify>
  <done>SpotifyModels.swift contains all Codable types matching Spotify Web API response JSON. SpotifyPlaylistMatcher.swift computes song count labels from track durations. Both compile without errors.</done>
</task>

<task type="auto">
  <name>Task 3: Register new files in generate-xcodeproj.js</name>
  <files>generate-xcodeproj.js</files>
  <action>
    Register all files created in Tasks 1-2 in generate-xcodeproj.js:

    In the sourceFiles array:
    - `{ name: 'TimeQuestSchemaV6.swift', path: 'Models/Schemas/TimeQuestSchemaV6.swift' }` (add after SchemaV5 entry)
    - `{ name: 'SpotifyModels.swift', path: 'Models/SpotifyModels.swift' }` (add to Models section)
    - `{ name: 'SpotifyPlaylistMatcher.swift', path: 'Domain/SpotifyPlaylistMatcher.swift' }` (add to Domain section)

    In the groups structure:
    - Add 'TimeQuestSchemaV6.swift' to the Schemas subgroup files array
    - Add 'SpotifyModels.swift' to the Models group files array
    - Add 'SpotifyPlaylistMatcher.swift' to the Domain group files array

    Run `node generate-xcodeproj.js` to regenerate the Xcode project and verify build.
  </action>
  <verify>Run `node generate-xcodeproj.js && xcodebuild -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5` -- build succeeds with all new files included.</verify>
  <done>All 3 new source files registered in generate-xcodeproj.js. Xcode project includes them. Clean build succeeds.</done>
</task>

</tasks>

<verification>
- SchemaV6 exists with spotifyPlaylistID, spotifyPlaylistName on Routine and spotifySongCount on GameSession
- All 6 model typealiases point to V6
- Migration chain: V1->V2->V3->V4->V5->V6 (all lightweight)
- SpotifyModels.swift decodes all 4 Spotify API response types (playlists, tracks, currently-playing, user profile)
- SpotifyPlaylistMatcher.formatSongCount produces correct labels: "less than 1 song", "1 song", "3 songs", "4.5 songs"
- Project builds with `xcodebuild`
</verification>

<success_criteria>
- Clean build with SchemaV6 active
- No SwiftData migration errors
- All Spotify Codable types compile with Sendable conformance
- SpotifyPlaylistMatcher is Foundation-only with no external dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/09-spotify-integration/09-01-SUMMARY.md`
</output>
