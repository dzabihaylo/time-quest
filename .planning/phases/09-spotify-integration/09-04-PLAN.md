---
phase: 09-spotify-integration
plan: 04
type: execute
wave: 4
depends_on: ["09-01", "09-02", "09-03"]
files_modified:
  - TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift
  - TimeQuest/Features/Player/Views/QuestView.swift
  - TimeQuest/Features/Player/Views/SessionSummaryView.swift
  - TimeQuest/Features/Shared/Components/NowPlayingIndicator.swift
  - generate-xcodeproj.js
autonomous: false

must_haves:
  truths:
    - "Starting a routine with a linked playlist opens the Spotify app to that playlist via Universal Link"
    - "During an active quest, a Now Playing indicator shows current track name and artist"
    - "Now Playing indicator polls every 10 seconds and updates when the track changes"
    - "Now Playing indicator disappears gracefully when nothing is playing or Spotify is not connected"
    - "Post-routine summary shows song count as time unit (e.g. 'You got through 4.5 songs')"
    - "Routines without a linked playlist show no Spotify UI at all (SPOT-06)"
    - "Now Playing polling stops when the quest ends or the app backgrounds"
    - "Song count is persisted on the GameSession for historical display"
  artifacts:
    - path: "TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift"
      provides: "Spotify playback launch, Now Playing polling, song count calculation"
      contains: "openPlaylistInSpotify"
    - path: "TimeQuest/Features/Shared/Components/NowPlayingIndicator.swift"
      provides: "Minimal Now Playing overlay component"
      contains: "NowPlayingIndicator"
    - path: "TimeQuest/Features/Player/Views/SessionSummaryView.swift"
      provides: "Song count display in session summary"
      contains: "spotifySongCount"
    - path: "TimeQuest/Features/Player/Views/QuestView.swift"
      provides: "NowPlayingIndicator wired into quest flow"
      contains: "NowPlayingIndicator"
  key_links:
    - from: "TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift"
      to: "TimeQuest/Services/SpotifyAPIClient.swift"
      via: "Polling getCurrentlyPlaying() during active quest"
      pattern: "spotifyAPIClient\\.getCurrentlyPlaying"
    - from: "TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift"
      to: "TimeQuest/Domain/SpotifyPlaylistMatcher.swift"
      via: "Computing song count from tracked song transitions"
      pattern: "SpotifyPlaylistMatcher"
    - from: "TimeQuest/Features/Player/Views/QuestView.swift"
      to: "TimeQuest/Features/Shared/Components/NowPlayingIndicator.swift"
      via: "Conditional rendering when nowPlayingInfo is non-nil"
      pattern: "NowPlayingIndicator"
    - from: "TimeQuest/Features/Player/Views/SessionSummaryView.swift"
      to: "GameSession.spotifySongCount"
      via: "Display song count label from session data"
      pattern: "spotifySongCount"
---

<objective>
Build the player-facing Spotify experience: launch Spotify with the linked playlist when a routine starts, poll "Now Playing" during active quests, and show song count as a time unit in the post-routine summary.

Purpose: This is the payoff of the Spotify integration -- the player experiences music as an intuitive time cue during routines (SPOT-03, SPOT-04, SPOT-05). The "how many songs" mental model helps her develop a feel for duration without watching a clock.
Output: Updated GameSessionViewModel, NowPlayingIndicator component, updated QuestView and SessionSummaryView.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-spotify-integration/09-RESEARCH.md
@.planning/phases/09-spotify-integration/09-01-SUMMARY.md
@.planning/phases/09-spotify-integration/09-02-SUMMARY.md
@.planning/phases/09-spotify-integration/09-03-SUMMARY.md

@TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift
@TimeQuest/Features/Player/Views/QuestView.swift
@TimeQuest/Features/Player/Views/SessionSummaryView.swift
@TimeQuest/Domain/SpotifyPlaylistMatcher.swift
@TimeQuest/Models/SpotifyModels.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend GameSessionViewModel with Spotify playback launch, Now Playing polling, and song count tracking</name>
  <files>
    TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift
    TimeQuest/Features/Shared/Components/NowPlayingIndicator.swift
  </files>
  <action>
    Create NowPlayingIndicator.swift in Features/Shared/Components/:
    - A simple SwiftUI view taking `NowPlayingInfo` (from SpotifyModels.swift)
    - Layout: compact horizontal bar at the bottom of the quest view
      - Small music note icon (systemName: "music.note")
      - Track name (font: .caption, lineLimit: 1)
      - Artist name (font: .caption2, foregroundStyle: .secondary, lineLimit: 1)
    - Style: rounded rectangle background with .ultraThinMaterial, padding, max width
    - No album art (keep it minimal -- Phase 10 can enhance)
    - Must handle nil gracefully (caller conditionally shows it)

    Extend GameSessionViewModel with Spotify functionality:
    - Add properties:
      - `var nowPlayingInfo: NowPlayingInfo?` (observable, drives NowPlayingIndicator)
      - `private var nowPlayingPollingTask: Task<Void, Never>?` (cancellable polling loop)
      - `private var trackedSongIDs: [String] = []` (unique track IDs seen during quest)
      - `private var spotifyAPIClient: SpotifyAPIClient?` (injected from AppDependencies)
      - `private var spotifyAuthManager: SpotifyAuthManager?` (to check isConnected)

    - Add init parameter or setter for Spotify dependencies. The cleanest approach: add `func configureSpotify(authManager: SpotifyAuthManager, apiClient: SpotifyAPIClient)` that the view can call after init (to avoid breaking existing init signature).

    - In the startQuest() method (or wherever the quest begins its active phase):
      - Guard: routine has spotifyPlaylistID AND spotifyAuthManager?.isConnected == true
      - If both true:
        1. Open Spotify via Universal Link: `UIApplication.shared.open(URL(string: "https://open.spotify.com/playlist/\(playlistID)")!)` -- use Universal Links (NOT spotify: URI) to avoid iOS confirmation dialog (see research)
        2. Start polling loop via startNowPlayingPolling()
      - If either false: skip silently (SPOT-06: no Spotify = no difference)

    - `private func startNowPlayingPolling()`:
      - Cancel any existing polling task
      - Create new Task that loops:
        - `try await Task.sleep(for: .seconds(10))` (10-second interval per research -- avoids rate limiting)
        - Call `spotifyAPIClient?.getCurrentlyPlaying()`
        - If result is non-nil:
          - Update nowPlayingInfo on MainActor
          - Track the song ID: if item.name not in trackedSongIDs, append it
        - If result is nil: set nowPlayingInfo = nil (nothing playing)
        - If error (including CancellationError): break the loop
      - Check Task.isCancelled between iterations

    - `private func stopNowPlayingPolling()`:
      - Cancel nowPlayingPollingTask
      - Set nowPlayingInfo = nil

    - When the quest ends (completeSession or wherever GameSession gets completed):
      - Call stopNowPlayingPolling()
      - Calculate song count:
        - Use trackedSongIDs.count as the integer count of unique songs heard
        - Use SpotifyPlaylistMatcher().formatSongCount(Double(trackedSongIDs.count)) for the label
        - Save to GameSession: `session.spotifySongCount = songCountLabel`
      - Only do this if trackedSongIDs is not empty

    - When the view disappears or quest is cancelled:
      - Call stopNowPlayingPolling()

    IMPORTANT (SPOT-06): All Spotify code paths must be guarded by `spotifyAuthManager?.isConnected == true && routine.spotifyPlaylistID != nil`. If either condition is false, the quest flow is IDENTICAL to before this plan. No changes to the non-Spotify path.

    IMPORTANT (SPOT-07): The Now Playing polling and Universal Link approach work identically for Free and Premium tiers. Free tier users may see nowPlayingInfo = nil more often (Free mobile doesn't always report currently-playing), which just means the indicator doesn't show. That's acceptable graceful degradation.
  </action>
  <verify>Run `node generate-xcodeproj.js && xcodebuild -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5` -- build succeeds.</verify>
  <done>GameSessionViewModel launches Spotify via Universal Link at quest start, polls Now Playing every 10s, tracks song transitions, and saves song count label to GameSession.spotifySongCount on completion. NowPlayingIndicator component renders current track info. All Spotify paths are no-ops when not connected or no playlist linked.</done>
</task>

<task type="auto">
  <name>Task 2: Wire NowPlayingIndicator into QuestView and song count into SessionSummaryView, register files</name>
  <files>
    TimeQuest/Features/Player/Views/QuestView.swift
    TimeQuest/Features/Player/Views/SessionSummaryView.swift
    generate-xcodeproj.js
  </files>
  <action>
    Update QuestView.swift:
    - Add `@Environment(AppDependencies.self) private var dependencies` (if not already present)
    - When the view appears or the quest starts, call `viewModel.configureSpotify(authManager: dependencies.spotifyAuthManager, apiClient: dependencies.spotifyAPIClient)` (do this early, before startQuest)
    - Add NowPlayingIndicator to the quest view layout:
      - Position: at the bottom of the active quest view, above any existing bottom controls
      - Conditionally rendered: `if let nowPlaying = viewModel.nowPlayingInfo { NowPlayingIndicator(info: nowPlaying) }`
      - No "else" branch -- when there's nothing playing, the space is simply empty (SPOT-06: invisible when not active)
      - Add a subtle enter/exit transition: `.transition(.move(edge: .bottom).combined(with: .opacity))`

    Update SessionSummaryView.swift:
    - Add a song count section BELOW the existing stats (XP, accuracy, etc.) and ABOVE the "Done" button
    - Conditionally rendered based on the viewModel's session having a spotifySongCount:
      ```
      if let songCount = viewModel.currentSession?.spotifySongCount {
          HStack(spacing: 4) {
              Image(systemName: "music.note")
                  .font(.caption)
                  .foregroundStyle(.secondary)
              Text("You got through \(songCount)")
                  .font(.callout)
                  .foregroundStyle(.secondary)
          }
          .padding(.top, 8)
      }
      ```
    - No "else" branch (SPOT-06: invisible without Spotify data)
    - The framing "You got through X songs" reinforces the time-as-songs mental model

    Register in generate-xcodeproj.js:
    - Add to sourceFiles: NowPlayingIndicator.swift (Features/Shared/Components/)
    - Add to the Shared/Components group: 'NowPlayingIndicator.swift'
    - Verify the Shared Components subgroup exists in the groups structure. If it exists as a 'subgroups' entry under Shared, add the file to the appropriate subgroup's files array. If the Components subgroup has an existing files array, append to it.
  </action>
  <verify>Run `node generate-xcodeproj.js && xcodebuild -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5` -- build succeeds.</verify>
  <done>QuestView shows NowPlayingIndicator when Spotify is playing during a quest. SessionSummaryView shows "You got through X songs" when Spotify data is available. Both are invisible when Spotify is not connected or no playlist is linked. NowPlayingIndicator registered in build system.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Spotify integration end-to-end</name>
  <files>None -- verification only</files>
  <action>
    Human verifies the complete Spotify integration built across Plans 01-04:
    - OAuth connect/disconnect flow
    - Playlist browsing and selection
    - Playback launch via Universal Link
    - Now Playing indicator during active quest
    - Song count in post-routine summary
    - Graceful degradation without Spotify (SPOT-06)
  </action>
  <verify>
    1. Open the app in Simulator or on device
    2. Enter parent mode (tap and hold the title)
    3. Verify "Spotify" button appears in bottom toolbar next to "Calendar"
    4. Tap "Spotify" -- should see SpotifySettingsView with "Connect Spotify" button
    5. If you have a Spotify Developer app configured:
       a. Tap "Connect Spotify" -- OAuth flow should open in-app browser
       b. After authorizing, should return to app showing "Connected as [your name]"
       c. Go to any routine's editor -- should see "Spotify Playlist" section
       d. Tap "Link a Playlist" -- should see your Spotify playlists
       e. Select a playlist -- name should appear in the editor
       f. Save the routine
       g. Switch to player mode and start a quest for that routine
       h. Spotify app should open to the playlist
       i. Return to TimeQuest -- Now Playing indicator should appear at bottom
       j. Complete the quest -- summary should show "You got through X songs"
    6. If you do NOT have Spotify configured:
       a. Verify no Spotify UI appears in the player flow at all (SPOT-06)
       b. Verify the parent dashboard shows the Spotify button (it's always there as an option)
       c. Verify routines without playlists work exactly as before
    7. Verify build succeeds: `node generate-xcodeproj.js && xcodebuild build`
  </verify>
  <done>User confirms Spotify integration works end-to-end or provides specific issues to address. Type "approved" or describe issues.</done>
</task>

</tasks>

<verification>
- Quest with linked playlist opens Spotify via Universal Link on start
- NowPlayingIndicator shows during active quest when Spotify is playing
- NowPlayingIndicator is absent when Spotify is not connected or nothing is playing
- SessionSummaryView shows "You got through X songs" when Spotify data available
- SessionSummaryView shows no Spotify section without Spotify data
- GameSession.spotifySongCount is persisted after quest completion
- Quest without linked playlist is identical to pre-Spotify behavior
- Project builds clean
</verification>

<success_criteria>
- Spotify playback launches via Universal Link at quest start (SPOT-03)
- Now Playing indicator visible during active quests (SPOT-04)
- Song count shown in post-routine summary (SPOT-05)
- Zero Spotify UI when not connected or no playlist linked (SPOT-06)
- Works identically for Free and Premium tiers (SPOT-07)
</success_criteria>

<output>
After completion, create `.planning/phases/09-spotify-integration/09-04-SUMMARY.md`
</output>
