---
phase: 09-spotify-integration
plan: 03
type: execute
wave: 3
depends_on: ["09-01", "09-02"]
files_modified:
  - TimeQuest/Features/Parent/Views/SpotifySettingsView.swift
  - TimeQuest/Features/Parent/Views/PlaylistPickerView.swift
  - TimeQuest/Features/Parent/Views/RoutineEditorView.swift
  - TimeQuest/Features/Parent/ViewModels/RoutineEditorViewModel.swift
  - TimeQuest/Features/Parent/Views/ParentDashboardView.swift
  - generate-xcodeproj.js
autonomous: true

must_haves:
  truths:
    - "Parent can navigate to Spotify settings from the parent dashboard bottom toolbar"
    - "Parent can tap Connect to initiate Spotify OAuth and see confirmation with display name after success"
    - "Parent can disconnect Spotify from the settings view"
    - "Parent can browse their Spotify playlists and select one for a routine"
    - "Selected playlist name is visible in the routine editor"
    - "Parent can remove a linked playlist from a routine"
    - "Playlist selection persists across save/reload of the routine"
  artifacts:
    - path: "TimeQuest/Features/Parent/Views/SpotifySettingsView.swift"
      provides: "Connect/disconnect Spotify UI"
      contains: "spotifyAuthManager"
    - path: "TimeQuest/Features/Parent/Views/PlaylistPickerView.swift"
      provides: "Playlist browsing and selection UI"
      contains: "getUserPlaylists"
    - path: "TimeQuest/Features/Parent/Views/RoutineEditorView.swift"
      provides: "Playlist section in routine editor"
      contains: "spotifyPlaylistName"
    - path: "TimeQuest/Features/Parent/ViewModels/RoutineEditorViewModel.swift"
      provides: "Playlist fields in RoutineEditState and save/load"
      contains: "spotifyPlaylistID"
  key_links:
    - from: "TimeQuest/Features/Parent/Views/SpotifySettingsView.swift"
      to: "TimeQuest/Services/SpotifyAuthManager.swift"
      via: "Environment-injected AppDependencies.spotifyAuthManager"
      pattern: "spotifyAuthManager\\.authorize"
    - from: "TimeQuest/Features/Parent/Views/PlaylistPickerView.swift"
      to: "TimeQuest/Services/SpotifyAPIClient.swift"
      via: "API call to fetch playlists"
      pattern: "spotifyAPIClient\\.getUserPlaylists"
    - from: "TimeQuest/Features/Parent/ViewModels/RoutineEditorViewModel.swift"
      to: "TimeQuest/Models/Schemas/TimeQuestSchemaV6.swift"
      via: "Routine.spotifyPlaylistID/Name read/write in save()"
      pattern: "spotifyPlaylistID"
    - from: "TimeQuest/Features/Parent/Views/ParentDashboardView.swift"
      to: "TimeQuest/Features/Parent/Views/SpotifySettingsView.swift"
      via: "NavigationLink in bottom toolbar"
      pattern: "SpotifySettingsView"
---

<objective>
Build the parent-facing Spotify UI: a settings view to connect/disconnect Spotify, a playlist picker for browsing and selecting playlists, and integration into the routine editor so parents can associate a playlist with any routine.

Purpose: Parents must be able to connect Spotify (SPOT-01) and select playlists for routines (SPOT-02) before any player-facing features work. This plan completes the parent side of the Spotify integration.
Output: SpotifySettingsView.swift, PlaylistPickerView.swift, updated RoutineEditorView/ViewModel, updated ParentDashboardView.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-spotify-integration/09-RESEARCH.md
@.planning/phases/09-spotify-integration/09-01-SUMMARY.md
@.planning/phases/09-spotify-integration/09-02-SUMMARY.md

@TimeQuest/Features/Parent/Views/ParentDashboardView.swift
@TimeQuest/Features/Parent/Views/RoutineEditorView.swift
@TimeQuest/Features/Parent/ViewModels/RoutineEditorViewModel.swift
@TimeQuest/Features/Parent/Views/CalendarSettingsView.swift
@TimeQuest/App/AppDependencies.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SpotifySettingsView and PlaylistPickerView</name>
  <files>
    TimeQuest/Features/Parent/Views/SpotifySettingsView.swift
    TimeQuest/Features/Parent/Views/PlaylistPickerView.swift
  </files>
  <action>
    Create SpotifySettingsView.swift following CalendarSettingsView as a pattern:
    - `@Environment(AppDependencies.self) private var dependencies`
    - Access spotifyAuthManager from dependencies

    Layout:
    - NavigationStack with title "Spotify"
    - If NOT connected:
      - Brief explanation text: "Connect Spotify to pair playlists with routines. Music plays in the Spotify app during quests."
      - "Connect Spotify" button that calls `try await dependencies.spotifyAuthManager.authorize()`
      - Wrap in Task, show error alert on failure
      - Show loading indicator while isAuthenticating is true
    - If connected:
      - Section showing "Connected as [displayName]" with a green checkmark
      - "Disconnect" button (destructive role) that calls `dependencies.spotifyAuthManager.disconnect()`
    - No "Spotify required" messaging anywhere. Pure opt-in. (SPOT-06)

    Create PlaylistPickerView.swift:
    - Takes a binding for selected playlist: `@Binding var selectedPlaylistID: String?` and `@Binding var selectedPlaylistName: String?`
    - `@Environment(AppDependencies.self) private var dependencies`
    - `@State private var playlists: [SpotifyPlaylist] = []`
    - `@State private var isLoading = true`
    - `@State private var errorMessage: String?`
    - `@Environment(\.dismiss) private var dismiss`

    On `.task`, fetch playlists via `dependencies.spotifyAPIClient.getUserPlaylists()`. Handle errors gracefully (show message, don't crash).

    Layout:
    - List of playlists, each row showing:
      - Playlist image thumbnail (AsyncImage from first image URL, 44x44, rounded corners)
      - Playlist name (font: .body)
      - Track count subtitle (font: .caption, secondary color)
      - Checkmark if this playlist is currently selected
    - Tapping a row:
      - Sets selectedPlaylistID = playlist.id
      - Sets selectedPlaylistName = playlist.name
      - Calls dismiss()
    - NavigationStack with title "Choose Playlist"
    - Toolbar cancel button to dismiss without selection
    - If Spotify not connected, show a message directing to Spotify Settings (but do NOT show this view if not connected -- the caller should guard)
    - Loading state: ProgressView while fetching
    - Empty state: "No playlists found" if results are empty
    - Error state: Show error message with retry button
  </action>
  <verify>Run `node generate-xcodeproj.js && xcodebuild -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5` -- build succeeds.</verify>
  <done>SpotifySettingsView shows connect/disconnect UI based on auth state. PlaylistPickerView fetches and displays playlists from Spotify API with selection support.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate playlist selection into RoutineEditor and wire ParentDashboard navigation</name>
  <files>
    TimeQuest/Features/Parent/ViewModels/RoutineEditorViewModel.swift
    TimeQuest/Features/Parent/Views/RoutineEditorView.swift
    TimeQuest/Features/Parent/Views/ParentDashboardView.swift
    generate-xcodeproj.js
  </files>
  <action>
    Update RoutineEditState in RoutineEditorViewModel.swift:
    - Add `var spotifyPlaylistID: String?` and `var spotifyPlaylistName: String?` fields
    - Update `static var default` to include both as nil
    - Update init from existing routine: read `routine.spotifyPlaylistID` and `routine.spotifyPlaylistName`
    - Update createNew(): set `routine.spotifyPlaylistID = editState.spotifyPlaylistID` and `routine.spotifyPlaylistName = editState.spotifyPlaylistName` after creating the Routine
    - Update updateExisting(): set `routine.spotifyPlaylistID = editState.spotifyPlaylistID` and `routine.spotifyPlaylistName = editState.spotifyPlaylistName`

    Update RoutineEditorView.swift:
    - Add `@Environment(AppDependencies.self) private var dependencies`
    - Add `@State private var showingPlaylistPicker = false`
    - Add a new Section after the existing sections (after calendar mode section), only visible when Spotify is connected (`dependencies.spotifyAuthManager.isConnected`):
      - Section header: "Spotify Playlist"
      - If playlist linked (editState.spotifyPlaylistName != nil):
        - Row showing playlist name with music.note icon
        - "Change Playlist" button opening PlaylistPickerView
        - "Remove Playlist" button (destructive) that sets both fields to nil
      - If no playlist linked:
        - "Link a Playlist" button opening PlaylistPickerView
    - Present PlaylistPickerView in a .sheet, passing bindings to viewModel.editState.spotifyPlaylistID and viewModel.editState.spotifyPlaylistName
    - When Spotify is NOT connected, the entire section is hidden (SPOT-06: invisible until parent opts in)

    Update ParentDashboardView.swift:
    - Add a second ToolbarItem in .bottomBar for Spotify settings, next to the existing Calendar button
    - Use NavigationLink to SpotifySettingsView with label `Label("Spotify", systemImage: "music.note")`
    - Follow exact pattern of existing Calendar toolbar button

    Register in generate-xcodeproj.js:
    - Add to sourceFiles: SpotifySettingsView.swift (Features/Parent/Views/), PlaylistPickerView.swift (Features/Parent/Views/)
    - Add to ParentViews group files array: 'SpotifySettingsView.swift', 'PlaylistPickerView.swift'
  </action>
  <verify>Run `node generate-xcodeproj.js && xcodebuild -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5` -- build succeeds.</verify>
  <done>RoutineEditorViewModel saves/loads Spotify playlist fields. RoutineEditorView shows playlist section when Spotify is connected. ParentDashboardView has Spotify settings button in toolbar. All files registered and building.</done>
</task>

</tasks>

<verification>
- ParentDashboardView has a "Spotify" toolbar button navigating to SpotifySettingsView
- SpotifySettingsView shows "Connect Spotify" when disconnected, "Connected as ..." when connected
- PlaylistPickerView loads and displays playlist list from Spotify API
- RoutineEditorView shows playlist section only when Spotify is connected (hidden otherwise -- SPOT-06)
- Saving a routine with a linked playlist persists spotifyPlaylistID and spotifyPlaylistName
- Removing a linked playlist sets both fields to nil
- Project builds with xcodebuild
</verification>

<success_criteria>
- Parent can navigate to Spotify settings from dashboard toolbar
- Connect/disconnect OAuth flow works end-to-end
- Playlist picker shows real playlists from user's Spotify account
- Selected playlist persists on routine save/reload
- Spotify UI is completely invisible when not connected (SPOT-06)
</success_criteria>

<output>
After completion, create `.planning/phases/09-spotify-integration/09-03-SUMMARY.md`
</output>
