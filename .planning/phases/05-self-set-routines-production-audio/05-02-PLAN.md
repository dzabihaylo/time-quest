---
phase: 05-self-set-routines-production-audio
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - TimeQuest/Services/SoundManager.swift
  - TimeQuest/Domain/XPConfiguration.swift
  - TimeQuest/Domain/XPEngine.swift
  - TimeQuest/Domain/LevelCalculator.swift
  - TimeQuest/Resources/Sounds/estimate_lock.wav
  - TimeQuest/Resources/Sounds/reveal.wav
  - TimeQuest/Resources/Sounds/level_up.wav
  - TimeQuest/Resources/Sounds/personal_best.wav
  - TimeQuest/Resources/Sounds/session_complete.wav
  - generate-xcodeproj.js
  - TimeQuest/project.yml
autonomous: true

must_haves:
  truths:
    - "All 5 game sounds play audible production-quality audio (not silence)"
    - "Sounds mix with background music without interrupting it"
    - "Sounds respect the iOS silent switch (no sound in silent mode)"
    - "XP curve constants are exposed in a single XPConfiguration struct"
    - "XPEngine and LevelCalculator read from XPConfiguration instead of hardcoded values"
    - "Changing XPConfiguration.default values changes game behavior without touching XPEngine/LevelCalculator"
  artifacts:
    - path: "TimeQuest/Domain/XPConfiguration.swift"
      provides: "Tunable XP constants struct"
      contains: "XPConfiguration"
    - path: "TimeQuest/Services/SoundManager.swift"
      provides: "AVAudioSession.ambient configuration"
      contains: "setCategory.*ambient"
    - path: "TimeQuest/Resources/Sounds/estimate_lock.wav"
      provides: "Production-quality estimate lock sound effect"
    - path: "TimeQuest/Resources/Sounds/reveal.wav"
      provides: "Production-quality accuracy reveal sound effect"
    - path: "TimeQuest/Resources/Sounds/level_up.wav"
      provides: "Production-quality level up sound effect"
    - path: "TimeQuest/Resources/Sounds/personal_best.wav"
      provides: "Production-quality personal best sound effect"
    - path: "TimeQuest/Resources/Sounds/session_complete.wav"
      provides: "Production-quality session complete sound effect"
  key_links:
    - from: "TimeQuest/Services/SoundManager.swift"
      to: "AVAudioSession.sharedInstance()"
      via: "configureAudioSession() called in init()"
      pattern: "setCategory.*\\.ambient"
    - from: "TimeQuest/Domain/XPEngine.swift"
      to: "XPConfiguration"
      via: "Reads XP values from configuration instead of hardcoded switch cases"
      pattern: "configuration\\.spotOnXP"
    - from: "TimeQuest/Domain/LevelCalculator.swift"
      to: "XPConfiguration"
      via: "Reads level curve from configuration instead of hardcoded constants"
      pattern: "configuration\\.levelBaseXP"
---

<objective>
Configure AVAudioSession for proper audio mixing and silent switch behavior, generate production-quality game sound effects to replace the silent placeholders, and extract all XP/level constants into a tunable XPConfiguration struct.

Purpose: Polish the audio experience so game sounds feel real and don't fight with the player's music, and expose XP tuning knobs for post-playtesting adjustment without code changes throughout the codebase.

Output: SoundManager with AVAudioSession.ambient config, 5 production .wav files, XPConfiguration struct, refactored XPEngine and LevelCalculator.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-self-set-routines-production-audio/05-RESEARCH.md

# Key source files to read before implementing
@TimeQuest/Services/SoundManager.swift
@TimeQuest/Domain/XPEngine.swift
@TimeQuest/Domain/LevelCalculator.swift
@generate-xcodeproj.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: AVAudioSession configuration and production sound effects</name>
  <files>
    TimeQuest/Services/SoundManager.swift
    TimeQuest/Resources/Sounds/estimate_lock.wav
    TimeQuest/Resources/Sounds/reveal.wav
    TimeQuest/Resources/Sounds/level_up.wav
    TimeQuest/Resources/Sounds/personal_best.wav
    TimeQuest/Resources/Sounds/session_complete.wav
    generate-xcodeproj.js
  </files>
  <action>
**SoundManager.swift** updates:

Add `import AVFAudio` at the top (for AVAudioSession). The existing `import AVFoundation` covers AVAudioPlayer but adding AVFAudio explicitly is cleaner -- actually, AVFoundation already includes AVFAudio, so just use the existing import.

Add a `configureAudioSession()` private method and call it in init() before preloadAll():

```swift
init() {
    self.isMuted = UserDefaults.standard.bool(forKey: "soundMuted")
    configureAudioSession()
    preloadAll()
}

private func configureAudioSession() {
    do {
        try AVAudioSession.sharedInstance().setCategory(.ambient, mode: .default)
        try AVAudioSession.sharedInstance().setActive(true)
    } catch {
        // Audio session config failed -- sounds will still play but may
        // interrupt other audio or ignore silent switch
    }
}
```

The `.ambient` category:
- Mixes with background music (player can listen to their playlist while playing)
- Respects the hardware silent switch (no sounds in silent mode)
- Does NOT need to activate audio session for each play (once at init is sufficient)

**Sound Effects Generation:**

The current sound files are 0.1s of silence (generated by generate-xcodeproj.js). Replace them with real, audible game sounds using a Python script. Create a temporary Python script that generates production-quality WAV files using sine wave synthesis with envelope shaping:

Run a Python script to generate 5 distinct sounds:

1. **estimate_lock.wav** -- Short confirmation "click" sound: 0.15s, 880Hz tone with fast attack/decay envelope. Think of a satisfying "lock in" click.

2. **reveal.wav** -- Dramatic reveal: 0.5s, ascending sweep from 440Hz to 880Hz with crescendo envelope. The moment of truth when accuracy is shown.

3. **level_up.wav** -- Celebratory ascending arpeggio: 0.8s, rapid ascending notes (C5-E5-G5-C6) each 0.2s with overlap. Triumphant feel.

4. **personal_best.wav** -- Achievement sparkle: 0.6s, high-pitched descending shimmer effect. Two quick tones (1047Hz then 1319Hz) with reverb-like tail.

5. **session_complete.wav** -- Completion fanfare: 1.0s, chord resolution (C4+E4+G4 played together) with gentle fade. Satisfying "done" feeling.

All files: 44100Hz, 16-bit, mono, WAV format. Total size target: <200KB combined.

Use Python with the `struct` and `math` modules (no external deps) to generate these. Write a temporary script `/tmp/generate_sounds.py`, run it to create the files directly in `TimeQuest/Resources/Sounds/`, then delete the script.

The Python script should:
- Generate each sound using sine wave synthesis with amplitude envelopes
- Apply simple ADSR (attack/decay/sustain/release) envelope shaping for natural feel
- Write proper WAV headers (RIFF/WAVE format)
- Output files to the exact paths: TimeQuest/Resources/Sounds/{name}.wav

Also update `generate-xcodeproj.js` so the `createSilentWav` function is replaced with a check: if the sound file already exists (and is larger than 100 bytes), skip generation. This prevents the script from overwriting real sounds with silence when regenerating the project:

Change the sound generation loop at the bottom from:
```javascript
for (const sf of [...]) {
  const filePath = path.join(soundsDir, sf);
  createSilentWav(filePath);
  ...
}
```
to:
```javascript
for (const sf of [...]) {
  const filePath = path.join(soundsDir, sf);
  if (!fs.existsSync(filePath)) {
    createSilentWav(filePath);
    console.log(`Generated placeholder: ${filePath}`);
  } else {
    console.log(`Sound exists, skipping: ${filePath}`);
  }
}
```

This way running `node generate-xcodeproj.js` won't overwrite real production sounds with silence.
  </action>
  <verify>
- Check file sizes: `ls -la TimeQuest/Resources/Sounds/` -- each file should be >1KB (not 8.8KB placeholder silence)
- Check SoundManager has AVAudioSession config: grep "setCategory.*ambient" in SoundManager.swift
- Check generate-xcodeproj.js preserves existing sounds: grep "existsSync" in generate-xcodeproj.js
- Play one sound to verify it's audible: `afplay TimeQuest/Resources/Sounds/level_up.wav` (should produce actual sound)
  </verify>
  <done>
SoundManager configures AVAudioSession with .ambient category on init. All 5 sound files are real audible WAV sounds (not silence). generate-xcodeproj.js preserves existing sound files instead of overwriting with silence.
  </done>
</task>

<task type="auto">
  <name>Task 2: XPConfiguration struct and refactor XPEngine + LevelCalculator to use it</name>
  <files>
    TimeQuest/Domain/XPConfiguration.swift
    TimeQuest/Domain/XPEngine.swift
    TimeQuest/Domain/LevelCalculator.swift
    generate-xcodeproj.js
    TimeQuest/project.yml
  </files>
  <action>
**XPConfiguration.swift** (new file in Domain/):

Create a Sendable struct that extracts all tunable XP and level constants:

```swift
import Foundation

struct XPConfiguration: Sendable {
    // XP awarded per estimation accuracy
    var spotOnXP: Int = 100
    var closeXP: Int = 60
    var offXP: Int = 25
    var wayOffXP: Int = 10

    // Session completion bonus
    var completionBonus: Int = 20

    // Level curve parameters
    var levelBaseXP: Double = 100
    var levelExponent: Double = 1.5

    static let `default` = XPConfiguration()
}
```

**XPEngine.swift** refactor:

Replace hardcoded values with reads from a static configuration property:

```swift
import Foundation

struct XPEngine: Sendable {
    static var configuration = XPConfiguration.default

    static func xpForEstimation(rating: AccuracyRating) -> Int {
        switch rating {
        case .spot_on: configuration.spotOnXP
        case .close:   configuration.closeXP
        case .off:     configuration.offXP
        case .way_off: configuration.wayOffXP
        }
    }

    static func xpForSession(estimations: [TaskEstimation]) -> Int {
        let taskXP = estimations.reduce(0) { $0 + xpForEstimation(rating: $1.rating) }
        return taskXP + configuration.completionBonus
    }
}
```

Note: Adding `static var configuration` to a struct makes it mutable global state. For Swift 6 strict concurrency, this needs careful handling. Since XPEngine is already a struct with static functions (no actor isolation), and `XPConfiguration` is Sendable, use `nonisolated(unsafe) static var configuration` to satisfy the compiler -- same pattern used for `versionIdentifier` in VersionedSchema files. The configuration is set once at app launch and read-only thereafter, so this is safe in practice.

**LevelCalculator.swift** refactor:

Replace private hardcoded constants with reads from XPConfiguration:

```swift
import Foundation

struct LevelCalculator: Sendable {
    static var configuration: XPConfiguration { XPEngine.configuration }

    static func xpRequired(forLevel level: Int) -> Int {
        Int(configuration.levelBaseXP * pow(Double(level), configuration.levelExponent))
    }

    static func level(fromTotalXP xp: Int) -> Int {
        guard xp > 0 else { return 0 }
        return max(1, Int(floor(pow(Double(xp) / configuration.levelBaseXP, 1.0 / configuration.levelExponent))))
    }

    static func progressToNextLevel(totalXP: Int) -> Double {
        let currentLevel = level(fromTotalXP: totalXP)
        let currentLevelXP = xpRequired(forLevel: currentLevel)
        let nextLevelXP = xpRequired(forLevel: currentLevel + 1)
        let range = nextLevelXP - currentLevelXP
        guard range > 0 else { return 0.0 }
        let progress = Double(totalXP - currentLevelXP) / Double(range)
        return min(1.0, max(0.0, progress))
    }
}
```

LevelCalculator gets its configuration from `XPEngine.configuration` rather than having its own copy -- single source of truth. Remove the `private static let baseXP` and `private static let exponent` constants.

**generate-xcodeproj.js** update:

Add the new source file to the sourceFiles array (in alphabetical order within the Domain files):
```javascript
{ name: 'XPConfiguration.swift', path: 'Domain/XPConfiguration.swift' },
```

Add it to the Domain group's files array as well:
In the groups array, find the Domain group entry and add 'XPConfiguration.swift' to its files array.

**project.yml** -- No changes needed since the Domain/ folder is already listed as a source path and XcodeGen includes all .swift files in listed source paths.

Also add the new files from Plan 05-01 to generate-xcodeproj.js at the same time (since both plans are Wave 1 and this script is a shared file). Add to sourceFiles array:
```javascript
{ name: 'TimeQuestSchemaV3.swift', path: 'Models/Schemas/TimeQuestSchemaV3.swift' },
{ name: 'RoutineTemplateProvider.swift', path: 'Domain/RoutineTemplateProvider.swift' },
{ name: 'PlayerRoutineCreationViewModel.swift', path: 'Features/Player/ViewModels/PlayerRoutineCreationViewModel.swift' },
{ name: 'PlayerRoutineCreationView.swift', path: 'Features/Player/Views/PlayerRoutineCreationView.swift' },
```

Add these to the appropriate groups:
- 'TimeQuestSchemaV3.swift' to the Schemas group files array
- 'RoutineTemplateProvider.swift' to the Domain group files array
- 'PlayerRoutineCreationViewModel.swift' to the PlayerViewModels group files array
- 'PlayerRoutineCreationView.swift' to the PlayerViews group files array

Then regenerate the project: `cd /Users/davezabihaylo/Desktop/Claude\ Cowork/GSD && node generate-xcodeproj.js`

Also update project.yml to include Services/ as a source path (it's currently missing but the generate-xcodeproj.js handles it directly). Actually, project.yml is only used by XcodeGen which isn't the primary build system here -- the generate-xcodeproj.js IS the build system. Add `Services` to project.yml sources for consistency:

```yaml
sources:
  - path: App
  - path: Models
  - path: Repositories
  - path: Domain
  - path: Features
  - path: Game
  - path: Services
```
  </action>
  <verify>
- grep "XPConfiguration" in XPConfiguration.swift, XPEngine.swift, and LevelCalculator.swift to confirm wiring
- grep "configuration\\.spotOnXP" in XPEngine.swift to confirm hardcoded values removed
- grep "baseXP.*100" in LevelCalculator.swift should NOT match (hardcoded constants removed)
- grep "XPConfiguration.swift" in generate-xcodeproj.js to confirm build system registration
- grep "TimeQuestSchemaV3.swift\|RoutineTemplateProvider.swift\|PlayerRoutineCreationView" in generate-xcodeproj.js to confirm all Plan 05-01 files are registered too
- Run `node generate-xcodeproj.js` to regenerate project
- Verify build: `cd /Users/davezabihaylo/Desktop/Claude\ Cowork/GSD/TimeQuest && xcodebuild build -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' -quiet 2>&1 | tail -5`
  </verify>
  <done>
XPConfiguration struct has 7 tunable constants (spotOnXP, closeXP, offXP, wayOffXP, completionBonus, levelBaseXP, levelExponent). XPEngine reads from XPConfiguration instead of hardcoded switch values. LevelCalculator reads from XPConfiguration instead of private static lets. All new files from both plans are registered in generate-xcodeproj.js. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. AVAudioSession configured as .ambient -- grep "setCategory.*ambient" in SoundManager.swift
2. All 5 sounds are audible -- `afplay TimeQuest/Resources/Sounds/level_up.wav` produces sound
3. Sound files are not silence -- `ls -la TimeQuest/Resources/Sounds/` shows files >1KB
4. generate-xcodeproj.js doesn't overwrite sounds -- grep "existsSync" in the sound loop
5. XPConfiguration struct exists -- grep "struct XPConfiguration" in XPConfiguration.swift
6. XPEngine uses configuration -- grep "configuration\\.spotOnXP" in XPEngine.swift
7. LevelCalculator uses configuration -- grep "configuration\\.levelBaseXP" in LevelCalculator.swift
8. All new Phase 5 files registered in generate-xcodeproj.js
9. Build compiles without errors
</verification>

<success_criteria>
- SoundManager initializes AVAudioSession with .ambient category (mixes with music, respects silent switch)
- All 5 sound effects are audible, distinct, and appropriate for their game moment
- Sound files are real WAV audio, not placeholder silence
- XPConfiguration struct centralizes all 7 tunable constants
- XPEngine and LevelCalculator read from XPConfiguration, not hardcoded values
- Changing XPConfiguration.default values would change gameplay without touching other files
- generate-xcodeproj.js includes all new Phase 5 source files and preserves existing sounds
- Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-self-set-routines-production-audio/05-02-SUMMARY.md`
</output>
