---
phase: 05-self-set-routines-production-audio
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TimeQuest/Models/Schemas/TimeQuestSchemaV3.swift
  - TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift
  - TimeQuest/Models/Routine.swift
  - TimeQuest/App/TimeQuestApp.swift
  - TimeQuest/Domain/RoutineTemplateProvider.swift
  - TimeQuest/Repositories/RoutineRepository.swift
  - TimeQuest/Features/Player/ViewModels/PlayerRoutineCreationViewModel.swift
  - TimeQuest/Features/Player/Views/PlayerRoutineCreationView.swift
  - TimeQuest/Features/Player/Views/PlayerHomeView.swift
  - TimeQuest/Features/Parent/Views/RoutineListView.swift
autonomous: true

must_haves:
  truths:
    - "Player taps 'Create Quest' on home screen and enters a guided multi-step creation flow"
    - "Player can start from a template (Homework, Friend's House, Activity Prep) or create from scratch"
    - "Player can customize name, tasks (add/remove/reorder), and active days during creation"
    - "Player-created quests appear in quest list with a star badge visual distinction"
    - "Parent routines do NOT show any 'assigned' or 'parent-created' label"
    - "Parent dashboard shows only parent-created routines (player quests are filtered out)"
    - "Parent cannot edit or delete player-created routines"
    - "Validation prevents quests with 0 tasks, empty names, >10 tasks, or no active days"
    - "Existing parent routines survive V2->V3 migration with createdBy defaulting to 'parent'"
  artifacts:
    - path: "TimeQuest/Models/Schemas/TimeQuestSchemaV3.swift"
      provides: "V3 schema with createdBy field on Routine"
      contains: "createdBy"
    - path: "TimeQuest/Domain/RoutineTemplateProvider.swift"
      provides: "3+ starter templates for player routine creation"
      contains: "RoutineTemplate"
    - path: "TimeQuest/Features/Player/ViewModels/PlayerRoutineCreationViewModel.swift"
      provides: "Guided creation flow ViewModel with template init, step navigation, validation"
      contains: "PlayerRoutineCreationViewModel"
    - path: "TimeQuest/Features/Player/Views/PlayerRoutineCreationView.swift"
      provides: "Multi-step guided routine creation UI"
      contains: "PlayerRoutineCreationView"
  key_links:
    - from: "TimeQuest/Features/Player/Views/PlayerHomeView.swift"
      to: "PlayerRoutineCreationView"
      via: "'Create Quest' button triggers sheet presentation"
      pattern: "showingCreateQuest"
    - from: "TimeQuest/Features/Player/ViewModels/PlayerRoutineCreationViewModel.swift"
      to: "RoutineTemplateProvider"
      via: "Templates populate initial RoutineEditState"
      pattern: "RoutineTemplateProvider\\.templates"
    - from: "TimeQuest/Features/Player/ViewModels/PlayerRoutineCreationViewModel.swift"
      to: "createdBy = \"player\""
      via: "Sets createdBy on save"
      pattern: "createdBy.*player"
    - from: "TimeQuest/Features/Parent/Views/RoutineListView.swift"
      to: "createdBy == \"parent\""
      via: "@Query predicate filters to parent routines only"
      pattern: "createdBy.*parent"
---

<objective>
Add the createdBy field to Routine via SchemaV3, build a player-facing guided routine creation flow with templates, integrate a "Create Quest" entry point on PlayerHomeView with visual distinction for player quests, and filter the parent dashboard to exclude player-created routines.

Purpose: Transfer ownership from "parent's tool" to "my tool" -- the player can create and manage her own quests, which is the core empowerment feature of Phase 5.

Output: SchemaV3 with migration, RoutineTemplateProvider, PlayerRoutineCreationView/ViewModel, updated PlayerHomeView with Create Quest button and star badge, filtered RoutineListView.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-self-set-routines-production-audio/05-RESEARCH.md

# Key source files to read before implementing
@TimeQuest/Models/Schemas/TimeQuestSchemaV2.swift
@TimeQuest/Models/Schemas/TimeQuestSchemaV1.swift
@TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift
@TimeQuest/Models/Routine.swift
@TimeQuest/App/TimeQuestApp.swift
@TimeQuest/Features/Parent/ViewModels/RoutineEditorViewModel.swift
@TimeQuest/Repositories/RoutineRepository.swift
@TimeQuest/Features/Player/Views/PlayerHomeView.swift
@TimeQuest/Features/Parent/Views/RoutineListView.swift
@TimeQuest/Features/Parent/Views/ParentDashboardView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: SchemaV3 with createdBy field, migration plan update, and model/container updates</name>
  <files>
    TimeQuest/Models/Schemas/TimeQuestSchemaV3.swift
    TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift
    TimeQuest/Models/Routine.swift
    TimeQuest/App/TimeQuestApp.swift
  </files>
  <action>
Create TimeQuestSchemaV3.swift following the exact pattern from TimeQuestSchemaV2.swift:
- Copy all 5 model classes from V2 (Routine, RoutineTask, GameSession, TaskEstimation, PlayerProfile) -- they must ALL be present in V3
- Add `var createdBy: String = "parent"` to the Routine class (after isActive, before createdAt)
- Update the Routine init() to include `createdBy: String = "parent"` parameter
- Use `nonisolated(unsafe) static var versionIdentifier = Schema.Version(3, 0, 0)`
- Use `@preconcurrency import SwiftData` (same as V2)
- All relationship inverse keypaths must be fully qualified to `TimeQuestSchemaV3.X` (NOT V2)

Update TimeQuestMigrationPlan.swift:
- Add TimeQuestSchemaV3.self to the schemas array (after V2)
- Add `static let v2ToV3 = MigrationStage.lightweight(fromVersion: TimeQuestSchemaV2.self, toVersion: TimeQuestSchemaV3.self)`
- Add v2ToV3 to the stages array

Update Routine.swift:
- Change typealias from `TimeQuestSchemaV2.Routine` to `TimeQuestSchemaV3.Routine`

Update TimeQuestApp.swift:
- Change all `TimeQuestSchemaV2.X` references to `TimeQuestSchemaV3.X` in both ModelContainer inits (cloudContainer and fallback)
- There are 5 model type references in each init block (Routine, RoutineTask, GameSession, TaskEstimation, PlayerProfile) -- update all 10

Also update the other typealias files if they exist (RoutineTask.swift, GameSession.swift, TaskEstimation.swift, PlayerProfile.swift) from V2 to V3. Check each model file -- if it has `typealias X = TimeQuestSchemaV2.X`, change to V3.
  </action>
  <verify>
Run `cd TimeQuest && python3 ../generate-xcodeproj.js 2>/dev/null; xcodegen generate 2>/dev/null` or just verify file syntax:
- grep "SchemaV3" across all modified files to confirm references are consistent
- grep "createdBy" in TimeQuestSchemaV3.swift to confirm field exists
- grep "v2ToV3" in TimeQuestMigrationPlan.swift to confirm migration stage exists
- grep "TimeQuestSchemaV3" in TimeQuestApp.swift to confirm container uses V3
- Verify no remaining references to TimeQuestSchemaV2 in typealias files
  </verify>
  <done>
SchemaV3 exists with createdBy: String = "parent" on Routine, lightweight V2->V3 migration is registered, all typealiases point to V3, and TimeQuestApp ModelContainer references V3 model types.
  </done>
</task>

<task type="auto">
  <name>Task 2: RoutineTemplateProvider, PlayerRoutineCreationViewModel, and PlayerRoutineCreationView</name>
  <files>
    TimeQuest/Domain/RoutineTemplateProvider.swift
    TimeQuest/Repositories/RoutineRepository.swift
    TimeQuest/Features/Player/ViewModels/PlayerRoutineCreationViewModel.swift
    TimeQuest/Features/Player/Views/PlayerRoutineCreationView.swift
  </files>
  <action>
**RoutineTemplateProvider.swift** (new file in Domain/):
Create a pure value-type template provider. No SwiftData dependency.

```swift
struct RoutineTemplate: Identifiable, Sendable {
    let id = UUID()
    let name: String           // Internal identifier
    let displayName: String    // What player sees
    let suggestedTasks: [String]  // Task display names
    let suggestedDays: [Int]   // Default active days (1=Sun..7=Sat)
}

struct RoutineTemplateProvider: Sendable {
    static let templates: [RoutineTemplate] = [
        RoutineTemplate(name: "homework", displayName: "Homework Quest",
            suggestedTasks: ["Get supplies ready", "Work on assignment", "Pack up"],
            suggestedDays: [2, 3, 4, 5, 6]),
        RoutineTemplate(name: "friends_house", displayName: "Friend's House Prep",
            suggestedTasks: ["Pick what to bring", "Get dressed", "Pack bag"],
            suggestedDays: Array(1...7)),
        RoutineTemplate(name: "activity_prep", displayName: "Activity Prep",
            suggestedTasks: ["Gather gear", "Get changed", "Fill water bottle"],
            suggestedDays: [2, 3, 4, 5, 6]),
    ]
}
```

**RoutineRepository.swift** update:
Add `fetchParentRoutines()` and `fetchPlayerRoutines()` to `RoutineRepositoryProtocol` and `SwiftDataRoutineRepository`:
- `fetchParentRoutines()`: Uses `#Predicate { $0.createdBy == "parent" }`, sorted by createdAt
- `fetchPlayerRoutines()`: Uses `#Predicate { $0.createdBy == "player" }`, sorted by createdAt
- Keep all existing methods unchanged

**PlayerRoutineCreationViewModel.swift** (new file):
@MainActor @Observable class. Reuses RoutineEditState and TaskEditState from RoutineEditorViewModel.swift (they are top-level structs, not nested).

Properties:
- `var editState: RoutineEditState` -- current routine being built
- `var currentStep: CreationStep` -- enum: .chooseTemplate, .nameQuest, .addTasks, .chooseDays, .review
- `var selectedTemplate: RoutineTemplate?` -- nil means "Custom Quest"
- `private let modelContext: ModelContext`

CreationStep enum (nested): chooseTemplate, nameQuest, addTasks, chooseDays, review (with CaseIterable, Sendable)

Init: Takes `modelContext: ModelContext`. Sets editState to .default, currentStep to .chooseTemplate.

Key methods:
- `selectTemplate(_ template: RoutineTemplate?)` -- if template, populates editState with template's displayName, suggestedTasks (as TaskEditState array with ordered indices), suggestedDays. If nil, sets editState to .default with displayName "My Quest". Advances to .nameQuest.
- `startFromScratch()` -- calls selectTemplate(nil)
- `nextStep()` / `previousStep()` -- navigate through CreationStep cases sequentially
- `addTask()` -- same as RoutineEditorViewModel (append TaskEditState with next orderIndex). Guard against >10 tasks.
- `removeTask(at:)` -- remove + reindex. Guard against <1 task (disable if only 1 task).
- `moveTask(from:to:)` -- move + reindex (same as parent editor)
- `canProceed: Bool` computed -- per-step validation:
  - .chooseTemplate: always true (template selection handles advancement)
  - .nameQuest: displayName trimmed is not empty
  - .addTasks: at least 1 task with non-empty displayName, max 10 tasks
  - .chooseDays: at least 1 active day
  - .review: all above pass
- `var canSave: Bool` -- all validations pass (name non-empty, 1-10 valid tasks, 1+ active days)
- `func saveQuest() throws` -- creates Routine with createdBy = "player", inserts into modelContext with tasks (same pattern as RoutineEditorViewModel.createNew() but sets `routine.createdBy = "player"`). Task name = task displayName lowercased (matching parent convention). referenceDurationSeconds = nil for player tasks.

For player routine tasks: set both `name` and `displayName` from the player's input. The player enters a display name, and `name` = `displayName.lowercased()`. This matches how parent routines work (name is internal, displayName is shown).

**PlayerRoutineCreationView.swift** (new file):
A multi-step guided flow presented as a sheet. Uses NavigationStack internally.

Structure:
- Switch on viewModel.currentStep to show the appropriate step view
- Step 1 (.chooseTemplate): Grid of template cards (3 templates) + "Custom Quest" option. Each card shows displayName and task count. Tapping calls selectTemplate().
- Step 2 (.nameQuest): TextField for displayName with prompt "Name your quest". Show character guidance (not hard error). Back button, Next button (disabled if displayName empty).
- Step 3 (.addTasks): List of task fields (TextField per task displayName). "Add Step" button (disabled if >=10 tasks). Swipe to delete (disabled if only 1 task). Drag to reorder. Back/Next buttons.
- Step 4 (.chooseDays): Day picker (reuse the same toggle-per-day pattern from SchedulePickerView -- read that file for the exact UI pattern). Back/Next buttons.
- Step 5 (.review): Summary showing quest name, task list, active days. "Create Quest!" button that calls saveQuest().

Styling: Keep consistent with existing app style (system colors, RoundedRectangle(cornerRadius: 12), .systemGray6 backgrounds). This is a child-facing flow so make it feel inviting -- use encouraging language like "Name your quest", "Add your steps", "Pick your days".

Navigation: Use a toolbar with Back button (when not on step 1) and dismiss button (X). Bottom area has a prominent "Next" / "Create Quest!" button.

Environment dismissal: Use @Environment(\.dismiss) to close the sheet after successful save.
  </action>
  <verify>
- grep "RoutineTemplateProvider" to confirm the file exists and has 3+ templates
- grep "PlayerRoutineCreationViewModel" to confirm the ViewModel exists with saveQuest method
- grep "PlayerRoutineCreationView" to confirm the View exists
- grep "createdBy.*player" in PlayerRoutineCreationViewModel.swift to confirm player attribution
- grep "fetchParentRoutines\|fetchPlayerRoutines" in RoutineRepository.swift to confirm filtering methods
- Verify TaskEditState/RoutineEditState are imported correctly (they're in RoutineEditorViewModel.swift as top-level structs)
  </verify>
  <done>
RoutineTemplateProvider has 3 templates (Homework, Friend's House, Activity Prep). PlayerRoutineCreationViewModel manages a multi-step creation flow with template selection, validation (1-10 tasks, non-empty names, 1+ active days), and saves with createdBy="player". PlayerRoutineCreationView renders 5 guided steps. RoutineRepository has fetchParentRoutines() and fetchPlayerRoutines() methods.
  </done>
</task>

<task type="auto">
  <name>Task 3: PlayerHomeView Create Quest button + star badge + RoutineListView parent filtering</name>
  <files>
    TimeQuest/Features/Player/Views/PlayerHomeView.swift
    TimeQuest/Features/Parent/Views/RoutineListView.swift
  </files>
  <action>
**PlayerHomeView.swift** updates:

1. Add state: `@State private var showingCreateQuest = false`

2. Add a "Create Quest" button in the quest list area, below the existing quest cards (after the questList or emptyState). Style it as an inviting card-style button:
```swift
Button { showingCreateQuest = true } label: {
    HStack {
        Image(systemName: "plus.circle.fill")
            .font(.title3)
            .foregroundStyle(.tint)
        Text("Create Quest")
            .font(.headline)
            .foregroundStyle(.tint)
        Spacer()
    }
    .padding(16)
    .background(Color(.systemGray6))
    .clipShape(RoundedRectangle(cornerRadius: 12))
}
.buttonStyle(.plain)
```
Place this button in the questList VStack (inside the `.padding(.horizontal, 24)` container), so it appears below existing quests. Also show it in the emptyState area.

3. Add sheet presentation:
```swift
.sheet(isPresented: $showingCreateQuest) {
    PlayerRoutineCreationView(modelContext: modelContext)
}
```
Add this modifier to the NavigationStack, and refresh todayQuests when the sheet dismisses:
```swift
.sheet(isPresented: $showingCreateQuest, onDismiss: { loadTodayQuests() }) {
    PlayerRoutineCreationView(modelContext: modelContext)
}
```

4. Add star badge to questCard() for player-created quests. Inside the existing HStack(spacing: 6) that contains the displayName text, add AFTER the displayName Text (and BEFORE the calibrating check):
```swift
if routine.createdBy == "player" {
    Image(systemName: "star.fill")
        .font(.caption2)
        .foregroundStyle(.orange)
}
```
This adds a small orange star next to player-created quest names. Parent routines get NO indicator -- the star is additive only for player quests (REQ-029).

**RoutineListView.swift** updates:

Change the @Query to filter to parent-created routines only:
```swift
@Query(filter: #Predicate<Routine> { $0.createdBy == "parent" }, sort: \Routine.createdAt)
private var routines: [Routine]
```

This ensures the parent dashboard (which embeds RoutineListView) only shows parent routines. The parent never sees player-created quests, and the delete/edit actions in RoutineListView only affect parent routines (REQ-030, REQ-031).

Also in the deleteRoutines function, add a safety check (belt and suspenders):
```swift
private func deleteRoutines(at offsets: IndexSet) {
    for index in offsets {
        let routine = routines[index]
        guard routine.createdBy == "parent" else { continue }
        modelContext.delete(routine)
    }
    try? modelContext.save()
}
```
  </action>
  <verify>
- grep "showingCreateQuest" in PlayerHomeView.swift to confirm Create Quest button state exists
- grep "Create Quest" in PlayerHomeView.swift to confirm button text
- grep "star.fill" in PlayerHomeView.swift to confirm visual distinction badge
- grep "createdBy.*parent" in RoutineListView.swift to confirm @Query predicate filters parent routines only
- grep "PlayerRoutineCreationView" in PlayerHomeView.swift to confirm sheet presentation
- Note: generate-xcodeproj.js registration of new files is handled by Plan 05-02. The xcodebuild verification happens after both plans complete.
  </verify>
  <done>
PlayerHomeView has a "Create Quest" button that opens the guided creation flow as a sheet. Player-created quests display an orange star badge. Parent routines show no creator label. RoutineListView @Query filters to createdBy=="parent", so the parent dashboard excludes player quests. Parent cannot edit/delete player routines (filtered out + safety guard).
  </done>
</task>

</tasks>

<verification>
1. SchemaV3 has createdBy field with "parent" default -- grep "createdBy.*parent" in TimeQuestSchemaV3.swift
2. Migration plan includes V2->V3 lightweight stage -- grep "v2ToV3" in TimeQuestMigrationPlan.swift
3. All typealiases point to V3 -- grep "TimeQuestSchemaV3" in model typealias files
4. TimeQuestApp references V3 types -- grep "TimeQuestSchemaV3" in TimeQuestApp.swift
5. RoutineTemplateProvider has 3+ templates -- grep "RoutineTemplate(" in RoutineTemplateProvider.swift
6. PlayerRoutineCreationViewModel saves with createdBy="player" -- grep "createdBy.*player"
7. Validation: 1-10 tasks, non-empty names, 1+ active days -- inspect canProceed/canSave computed properties
8. Create Quest button on PlayerHomeView -- grep "Create Quest"
9. Star badge for player quests -- grep "star.fill" in PlayerHomeView.swift
10. Parent dashboard filtered -- grep "createdBy.*parent" in RoutineListView.swift
11. Build succeeds -- xcodebuild
</verification>

<success_criteria>
- Player can tap "Create Quest" on home screen and build a routine from template or scratch
- Player-created quests have orange star badge; parent routines have no creator label
- Parent dashboard shows only parent routines
- Validation prevents empty names, 0 tasks, >10 tasks, no active days
- V2->V3 migration preserves existing routines as createdBy="parent"
- Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-self-set-routines-production-audio/05-01-SUMMARY.md`
</output>
