---
phase: 02-engagement-layer
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - TimeQuest/Features/Player/ViewModels/ProgressionViewModel.swift
  - TimeQuest/Features/Shared/Components/XPBarView.swift
  - TimeQuest/Features/Shared/Components/StreakBadgeView.swift
  - TimeQuest/Features/Shared/Components/LevelBadgeView.swift
  - TimeQuest/Features/Player/Views/PlayerHomeView.swift
  - TimeQuest/Features/Player/Views/SessionSummaryView.swift
  - TimeQuest/Features/Player/Views/AccuracyTrendChartView.swift
  - TimeQuest/Features/Player/Views/PlayerStatsView.swift
  - generate-xcodeproj.js
autonomous: true

must_haves:
  truths:
    - "Player sees their current Time Sense level and XP progress bar on the home screen"
    - "Player sees their current participation streak on the home screen"
    - "Session summary shows XP earned and level progress after completing a quest"
    - "Player can view estimation accuracy trends over time via a line chart"
    - "Player can see personal bests per task with closest-ever estimate difference"
  artifacts:
    - path: "TimeQuest/Features/Player/ViewModels/ProgressionViewModel.swift"
      provides: "Drives all progression UI: level, XP, streak, personal bests, chart data"
      contains: "class ProgressionViewModel"
    - path: "TimeQuest/Features/Shared/Components/XPBarView.swift"
      provides: "Animated XP progress bar toward next level"
      contains: "struct XPBarView"
    - path: "TimeQuest/Features/Shared/Components/StreakBadgeView.swift"
      provides: "Streak count display with flame icon"
      contains: "struct StreakBadgeView"
    - path: "TimeQuest/Features/Shared/Components/LevelBadgeView.swift"
      provides: "Time Sense Lv. X display"
      contains: "struct LevelBadgeView"
    - path: "TimeQuest/Features/Player/Views/AccuracyTrendChartView.swift"
      provides: "Swift Charts LineMark for accuracy over time"
      contains: "import Charts"
    - path: "TimeQuest/Features/Player/Views/PlayerStatsView.swift"
      provides: "Personal bests list and chart host"
      contains: "struct PlayerStatsView"
    - path: "TimeQuest/Features/Player/Views/PlayerHomeView.swift"
      provides: "Shows level badge, streak badge, XP bar, and stats navigation"
      contains: "LevelBadgeView"
    - path: "TimeQuest/Features/Player/Views/SessionSummaryView.swift"
      provides: "Shows XP earned and level progress after quest completion"
      contains: "XPBarView"
  key_links:
    - from: "TimeQuest/Features/Player/ViewModels/ProgressionViewModel.swift"
      to: "TimeQuest/Repositories/PlayerProfileRepository.swift"
      via: "Fetches PlayerProfile for current XP, level, streak"
      pattern: "playerProfileRepository"
    - from: "TimeQuest/Features/Player/ViewModels/ProgressionViewModel.swift"
      to: "TimeQuest/Domain/LevelCalculator.swift"
      via: "Computes level and progress from totalXP"
      pattern: "LevelCalculator\\."
    - from: "TimeQuest/Features/Player/Views/PlayerHomeView.swift"
      to: "TimeQuest/Features/Shared/Components/LevelBadgeView.swift"
      via: "Renders level badge in header"
      pattern: "LevelBadgeView"
    - from: "TimeQuest/Features/Player/Views/AccuracyTrendChartView.swift"
      to: "TimeQuest/Features/Player/ViewModels/ProgressionViewModel.swift"
      via: "Receives pre-aggregated chart data points"
      pattern: "dataPoints"
---

<objective>
Build the progression UI layer: a ProgressionViewModel that drives all stats, reusable badge/bar components for level and streak, an accuracy trend chart using Swift Charts, a player stats screen with personal bests, and integrate everything into the existing PlayerHomeView and SessionSummaryView.

Purpose: The player needs to SEE their progress to stay motivated past the week-3 novelty cliff. Level, streak, XP bar, personal bests, and accuracy trends provide visible evidence that their time sense is improving.

Output: One new ViewModel, three reusable UI components, two new view screens, two modified existing views, and an updated build script. After this plan, the player home screen shows level/streak/XP and the player can access stats and charts.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-engagement-layer/02-RESEARCH.md
@.planning/phases/02-engagement-layer/02-01-SUMMARY.md

@TimeQuest/Features/Player/Views/PlayerHomeView.swift
@TimeQuest/Features/Player/Views/SessionSummaryView.swift
@TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift
@TimeQuest/Models/PlayerProfile.swift
@TimeQuest/Models/TaskEstimation.swift
@TimeQuest/Domain/LevelCalculator.swift
@TimeQuest/Domain/PersonalBestTracker.swift
@TimeQuest/Repositories/PlayerProfileRepository.swift
@TimeQuest/Repositories/SessionRepository.swift
@TimeQuest/App/AppDependencies.swift
@generate-xcodeproj.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProgressionViewModel and reusable UI components</name>
  <files>
    TimeQuest/Features/Player/ViewModels/ProgressionViewModel.swift
    TimeQuest/Features/Shared/Components/XPBarView.swift
    TimeQuest/Features/Shared/Components/StreakBadgeView.swift
    TimeQuest/Features/Shared/Components/LevelBadgeView.swift
    TimeQuest/Features/Player/Views/AccuracyTrendChartView.swift
    TimeQuest/Features/Player/Views/PlayerStatsView.swift
  </files>
  <action>
**ProgressionViewModel.swift** -- @MainActor @Observable class:
- Dependencies: `playerProfileRepository: PlayerProfileRepositoryProtocol`, `sessionRepository: SessionRepositoryProtocol`, `modelContext: ModelContext`
- Published state: `currentLevel: Int = 0`, `totalXP: Int = 0`, `xpProgress: Double = 0.0` (0-1 toward next level), `xpForNextLevel: Int = 0`, `currentStreak: Int = 0`, `isStreakActive: Bool = false` (played today), `personalBests: [PersonalBestTracker.PersonalBest] = []`, `chartDataPoints: [AccuracyDataPoint] = []`
- Define `struct AccuracyDataPoint: Identifiable` with `id = UUID()`, `date: Date`, `averageAccuracy: Double`
- `func loadProfile()` -- fetches PlayerProfile via repository, computes level/progress/streak using LevelCalculator and the profile's stored values
- `func loadPersonalBests()` -- fetches ALL TaskEstimation objects from modelContext (FetchDescriptor with no predicate, sorted by recordedAt), passes to PersonalBestTracker.findPersonalBests
- `func loadChartData()` -- fetches all completed GameSessions (completedAt != nil), groups by calendar day, computes average accuracyPercent per day across all estimations in sessions for that day, limits to last 30 days, populates chartDataPoints sorted by date ascending
- `func refresh()` -- calls all three load methods

**XPBarView.swift** -- SwiftUI View:
- Props: `currentXP: Int`, `xpForNextLevel: Int`, `progress: Double` (0-1)
- Renders: Horizontal capsule-shaped progress bar, teal fill color, shows "XP: {current}/{next}" text below
- Use `.animation(.easeInOut(duration: 0.5), value: progress)` for smooth fill changes
- Height: 8pt bar, compact design suitable for embedding in cards

**StreakBadgeView.swift** -- SwiftUI View:
- Props: `streak: Int`, `isActive: Bool`
- Renders: HStack with flame icon (SF Symbol "flame.fill"), streak count text
- When `isActive` (played today): flame is orange, text is primary
- When not active: flame is gray, text is secondary
- Font: .callout weight .medium
- NEVER show "streak lost" or "broken" messaging -- just show the number quietly

**LevelBadgeView.swift** -- SwiftUI View:
- Props: `level: Int`
- Renders: "Time Sense Lv. {level}" text with a small clock icon
- Uses SF Symbol "brain.head.profile" or "clock.badge.checkmark"
- Font: .headline, tint color
- If level is 0 (no sessions yet), show "Time Sense -- New" instead

**AccuracyTrendChartView.swift** -- SwiftUI View using Swift Charts:
- `import Charts`
- Props: `dataPoints: [AccuracyDataPoint]`
- Renders LineMark + PointMark chart:
  - X axis: date, stride by 7 days, formatted as abbreviated month + day
  - Y axis: 0-100 range (accuracy percent), leading position, formatted as "N%"
  - Line: .catmullRom interpolation, teal foreground
  - Points: teal, small circle
- Frame height: 200pt
- If dataPoints is empty, show a Text placeholder: "Complete a few quests to see your accuracy trend"
- See research code example for exact Swift Charts API usage

**PlayerStatsView.swift** -- SwiftUI View:
- Takes `ProgressionViewModel` as dependency
- NavigationStack with title "Your Stats"
- Section 1: "Accuracy Trend" header, embeds AccuracyTrendChartView with viewModel.chartDataPoints
- Section 2: "Personal Bests" header, ForEach over viewModel.personalBests showing:
  - Task display name
  - Closest difference formatted as "0:XX off" using TimeFormatting.formatDuration(abs(closestDifferenceSeconds))
  - Date of the personal best formatted as relative ("2 days ago") or short date
- If personalBests is empty: "Complete some quests to see your personal bests here"
- Call viewModel.refresh() in .onAppear

All views must use the existing app design language: Color(.systemGray6) backgrounds for cards, RoundedRectangle(cornerRadius: 12) clip shapes, .headline/.subheadline/.caption font hierarchy. Match the style of PlayerHomeView.swift and SessionSummaryView.swift.
  </action>
  <verify>
Build after adding files: `cd "/Users/davezabihaylo/Desktop/Claude Cowork/GSD/TimeQuest" && xcodebuild -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.2' build 2>&1 | tail -20`

Note: This will fail until generate-xcodeproj.js is updated in Task 2. That's expected. The verify for this task is that all Swift files have valid syntax and proper imports. If desired, run a syntax check: `swiftc -typecheck` on individual files.
  </verify>
  <done>
ProgressionViewModel loads profile, personal bests, and chart data. XPBarView renders animated progress bar. StreakBadgeView shows streak with flame icon (no guilt messaging). LevelBadgeView shows "Time Sense Lv. X". AccuracyTrendChartView renders LineMark chart via Swift Charts. PlayerStatsView hosts chart and personal bests list.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate progression UI into existing views and update build system</name>
  <files>
    TimeQuest/Features/Player/Views/PlayerHomeView.swift
    TimeQuest/Features/Player/Views/SessionSummaryView.swift
    generate-xcodeproj.js
  </files>
  <action>
**PlayerHomeView.swift** -- Add progression display above quest list:
- Add `@State private var progressionVM: ProgressionViewModel?` property
- In `.onAppear`, after loadTodayQuests(), create ProgressionViewModel (using modelContext and repositories from AppDependencies -- you may need to access AppDependencies from environment or create repositories directly like the existing view does with SwiftDataRoutineRepository). Call progressionVM.refresh().
- Add a progression header section between the app logo and quest list:
  ```
  VStack(spacing: 12) {
      // Level badge centered
      LevelBadgeView(level: progressionVM.currentLevel)

      // XP bar
      XPBarView(currentXP: progressionVM.totalXP, xpForNextLevel: progressionVM.xpForNextLevel, progress: progressionVM.xpProgress)
          .padding(.horizontal, 24)

      // Streak badge
      StreakBadgeView(streak: progressionVM.currentStreak, isActive: progressionVM.isStreakActive)
  }
  ```
- Add a NavigationLink or Button at the bottom to navigate to PlayerStatsView. Place it below the quest list. Style as a subtle text link: "View Your Stats" with a chevron.right icon, .caption font, .secondary color.
- The NavigationLink destination should create PlayerStatsView with its own ProgressionViewModel instance (or pass the same one).
- Keep the existing triple-tap gesture for parent access on the logo area -- do NOT remove it.
- Keep the onboarding fullScreenCover -- do NOT remove it.

**SessionSummaryView.swift** -- Add XP earned display:
- The view already receives `viewModel: GameSessionViewModel` which now has `sessionXPEarned`, `didLevelUp`, `previousLevel` properties (from Plan 02-01)
- Add an XP section between the calibration message and summary stats:
  ```
  // XP earned this session
  VStack(spacing: 8) {
      Text("+\(viewModel.sessionXPEarned) XP")
          .font(.title2)
          .fontWeight(.bold)
          .foregroundStyle(.teal)

      if viewModel.didLevelUp {
          Text("Level Up!")
              .font(.headline)
              .foregroundStyle(.orange)
      }
  }
  .padding()
  .frame(maxWidth: .infinity)
  .background(Color(.systemGray6))
  .clipShape(RoundedRectangle(cornerRadius: 12))
  ```
- Only show the XP section if `viewModel.sessionXPEarned > 0` (handles edge case where session has no estimations)

**generate-xcodeproj.js** -- Add ALL new files from this plan:
- Add to sourceFiles array:
  - `{ name: 'ProgressionViewModel.swift', path: 'Features/Player/ViewModels/ProgressionViewModel.swift' }`
  - `{ name: 'XPBarView.swift', path: 'Features/Shared/Components/XPBarView.swift' }`
  - `{ name: 'StreakBadgeView.swift', path: 'Features/Shared/Components/StreakBadgeView.swift' }`
  - `{ name: 'LevelBadgeView.swift', path: 'Features/Shared/Components/LevelBadgeView.swift' }`
  - `{ name: 'AccuracyTrendChartView.swift', path: 'Features/Player/Views/AccuracyTrendChartView.swift' }`
  - `{ name: 'PlayerStatsView.swift', path: 'Features/Player/Views/PlayerStatsView.swift' }`
- Add file names to the correct groups:
  - 'ProgressionViewModel.swift' to PlayerViewModels group's files array
  - 'XPBarView.swift', 'StreakBadgeView.swift', 'LevelBadgeView.swift' to Components group's files array
  - 'AccuracyTrendChartView.swift', 'PlayerStatsView.swift' to PlayerViews group's files array
- Run `node generate-xcodeproj.js` to regenerate

IMPORTANT: The generate-xcodeproj.js already has files from Plan 02-01 added. Make sure to ADD to the existing arrays, not overwrite.
  </action>
  <verify>
1. Run `node "/Users/davezabihaylo/Desktop/Claude Cowork/GSD/generate-xcodeproj.js"` -- should succeed
2. Build: `cd "/Users/davezabihaylo/Desktop/Claude Cowork/GSD/TimeQuest" && xcodebuild -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.2' build 2>&1 | tail -30`
3. Build succeeds with zero errors
4. Verify integration: `grep -r "LevelBadgeView\|XPBarView\|StreakBadgeView" TimeQuest/Features/Player/Views/PlayerHomeView.swift` finds the component references
5. Verify chart import: `grep "import Charts" TimeQuest/Features/Player/Views/AccuracyTrendChartView.swift` succeeds
  </verify>
  <done>
PlayerHomeView shows level badge, XP progress bar, and streak badge. A "View Your Stats" link navigates to PlayerStatsView with accuracy trend chart and personal bests. SessionSummaryView shows XP earned and level-up celebration text. All views use existing design language. Build succeeds. No Phase 1 regressions.
  </done>
</task>

</tasks>

<verification>
1. Project builds cleanly: zero errors, zero warnings from new code
2. PlayerHomeView contains LevelBadgeView, XPBarView, StreakBadgeView references
3. SessionSummaryView contains XP earned display
4. AccuracyTrendChartView imports Charts framework and uses LineMark
5. PlayerStatsView shows personal bests from PersonalBestTracker
6. ProgressionViewModel correctly wires to PlayerProfileRepository and LevelCalculator
7. No Phase 1 regressions: existing quest flow, estimation, feedback all unchanged
</verification>

<success_criteria>
- Player home screen shows current level, XP bar, and streak count
- Session summary shows XP earned and level-up indication
- Player can navigate to stats view with accuracy trend chart
- Personal bests display closest-ever estimate per task
- Chart uses Swift Charts LineMark with 30-day window
- Streak display never shows guilt/punishment messaging
- All components match existing visual design language
</success_criteria>

<output>
After completion, create `.planning/phases/02-engagement-layer/02-02-SUMMARY.md`
</output>
