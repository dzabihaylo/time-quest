---
phase: 02-engagement-layer
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - TimeQuest/Services/SoundManager.swift
  - TimeQuest/Services/NotificationManager.swift
  - TimeQuest/Game/CelebrationScene.swift
  - TimeQuest/Game/AccuracyRevealScene.swift
  - TimeQuest/Features/Player/Views/AccuracyRevealView.swift
  - TimeQuest/Features/Player/Views/SessionSummaryView.swift
  - TimeQuest/Features/Player/Views/NotificationSettingsView.swift
  - TimeQuest/Features/Player/Views/PlayerHomeView.swift
  - TimeQuest/App/AppDependencies.swift
  - TimeQuest/App/TimeQuestApp.swift
  - generate-xcodeproj.js
autonomous: false

must_haves:
  truths:
    - "Player feels haptic feedback when locking in an estimate and when accuracy is revealed"
    - "Player hears sound effects on key game events (can be muted)"
    - "Player sees celebratory particle animations on milestones (level up, personal best, streak)"
    - "Player receives a single game-framed notification per routine on scheduled days"
    - "Player can toggle notifications on/off and sound on/off from the app"
  artifacts:
    - path: "TimeQuest/Services/SoundManager.swift"
      provides: "AVAudioPlayer wrapper with preload, play, mute toggle"
      contains: "class SoundManager"
    - path: "TimeQuest/Services/NotificationManager.swift"
      provides: "Schedule/cancel local notifications with deterministic IDs"
      contains: "class NotificationManager"
    - path: "TimeQuest/Game/CelebrationScene.swift"
      provides: "SpriteKit particle scene for milestone celebrations"
      contains: "class CelebrationScene"
    - path: "TimeQuest/Features/Player/Views/NotificationSettingsView.swift"
      provides: "Player-facing notification and sound toggle UI"
      contains: "struct NotificationSettingsView"
    - path: "TimeQuest/Features/Player/Views/AccuracyRevealView.swift"
      provides: "Haptic feedback on accuracy reveal, sound on reveal, celebration on milestones"
      contains: "sensoryFeedback"
  key_links:
    - from: "TimeQuest/Features/Player/Views/AccuracyRevealView.swift"
      to: "TimeQuest/Services/SoundManager.swift"
      via: "Plays reveal sound effect on accuracy show"
      pattern: "soundManager.*play"
    - from: "TimeQuest/Features/Player/Views/AccuracyRevealView.swift"
      to: "SwiftUI sensoryFeedback"
      via: ".sensoryFeedback modifier triggered on reveal"
      pattern: "\\.sensoryFeedback"
    - from: "TimeQuest/Services/NotificationManager.swift"
      to: "UNUserNotificationCenter"
      via: "Schedules UNCalendarNotificationTrigger per routine per weekday"
      pattern: "UNCalendarNotificationTrigger"
    - from: "TimeQuest/Features/Player/Views/NotificationSettingsView.swift"
      to: "TimeQuest/Services/NotificationManager.swift"
      via: "Calls scheduleRoutineReminder or cancelAllReminders based on toggle"
      pattern: "notificationManager"
---

<objective>
Add sensory polish (haptics, sounds, milestone celebrations) and game-framed local notifications with player-controlled preferences. This is the final plan in Phase 2 -- after this, the engagement layer is complete.

Purpose: Sensory feedback makes the game FEEL alive. Haptics on estimate lock-in, sounds on reveals, and particle celebrations on milestones create the dopamine loop that sustains daily engagement. Notifications bring the player back on scheduled days without nagging.

Output: SoundManager and NotificationManager services, a CelebrationScene for milestones, haptic/sound integration in AccuracyRevealView, a notification settings view, and a human verification checkpoint for the complete Phase 2 experience.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-engagement-layer/02-RESEARCH.md
@.planning/phases/02-engagement-layer/02-01-SUMMARY.md
@.planning/phases/02-engagement-layer/02-02-SUMMARY.md

@TimeQuest/Features/Player/Views/AccuracyRevealView.swift
@TimeQuest/Features/Player/Views/SessionSummaryView.swift
@TimeQuest/Features/Player/Views/PlayerHomeView.swift
@TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift
@TimeQuest/Game/AccuracyRevealScene.swift
@TimeQuest/Models/PlayerProfile.swift
@TimeQuest/Models/Routine.swift
@TimeQuest/Repositories/PlayerProfileRepository.swift
@TimeQuest/App/AppDependencies.swift
@TimeQuest/App/TimeQuestApp.swift
@generate-xcodeproj.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SoundManager, NotificationManager, CelebrationScene, and notification settings</name>
  <files>
    TimeQuest/Services/SoundManager.swift
    TimeQuest/Services/NotificationManager.swift
    TimeQuest/Game/CelebrationScene.swift
    TimeQuest/Features/Player/Views/NotificationSettingsView.swift
  </files>
  <action>
Create the Services/ directory under TimeQuest/ (it doesn't exist yet).

**SoundManager.swift** -- @MainActor @Observable class:
- `var isMuted: Bool` -- initialized from `UserDefaults.standard.bool(forKey: "soundMuted")`
- `private var players: [String: AVAudioPlayer] = [:]`
- `func preload(_ soundName: String, ext: String = "wav")` -- loads from Bundle.main, calls prepareToPlay(). Silently fails if file not found (sound is optional).
- `func play(_ soundName: String)` -- if not muted and player exists, reset currentTime to 0 and play. AVAudioPlayer MUST be stored as strong property (research pitfall 3 -- prevents deallocation).
- `func toggleMute()` -- toggles isMuted, persists to UserDefaults
- Preload these sound names in an `init()` or `preloadAll()` method: "estimate_lock", "reveal", "level_up", "personal_best", "session_complete"
- NOTE: The actual .wav sound files may not exist yet. That's OK -- the preload method silently handles missing files. The executor should create placeholder .wav files (even empty ones) or note them as a content task. For now, create the code infrastructure.
- Import AVFoundation

**NotificationManager.swift** -- @MainActor final class:
- `func requestAuthorization() async -> Bool` -- calls UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .sound, .badge]). Returns true if granted. Wraps in do/catch, returns false on error.
- `func scheduleRoutineReminder(routine: Routine, hour: Int, minute: Int)` -- creates UNMutableNotificationContent with:
  - title: "Quest Available!" (game-framed, not task-framed per NOTF-02)
  - body: "Your \(routine.displayName) quest is ready to play"
  - sound: .default
  - For each weekday in routine.activeDays: creates UNCalendarNotificationTrigger with DateComponents(weekday, hour, minute), repeats: true
  - Uses deterministic identifier: "routine-\(routine.name)-day\(weekday)" (prevents duplicates per research pitfall 6)
- `func cancelRoutineReminders(routineName: String, activeDays: [Int])` -- removes by deterministic IDs
- `func cancelAllReminders()` -- removeAllPendingNotificationRequests
- `func rescheduleAll(routines: [Routine], hour: Int, minute: Int)` -- cancels all, then schedules for each active routine
- `func checkAuthorizationStatus() async -> UNAuthorizationStatus` -- returns current setting via getNotificationSettings()
- Import UserNotifications

**CelebrationScene.swift** -- SKScene for milestone celebrations (extends the AccuracyRevealScene pattern):
- `enum CelebrationType { case levelUp, personalBest, streak(Int) }`
- `var celebrationType: CelebrationType = .levelUp`
- Override `didMove(to:)`: set clear background, resizeFill, spawn particles based on type
- Level up: large burst of gold+teal particles (60 particles, larger radius 60-150, longer duration 1.0-2.0)
- Personal best: medium burst of teal particles (40 particles, star shapes if possible, or circles)
- Streak: orange flame-colored burst (30 particles, warm colors)
- Follow the exact code pattern of AccuracyRevealScene -- SKShapeNode circles with moveBy, fadeOut, scale actions in a sequence
- Different color palettes per type:
  - levelUp: gold, teal, white
  - personalBest: teal, cyan, white
  - streak: orange, red-orange, yellow

**NotificationSettingsView.swift** -- SwiftUI View:
- Dependencies: Bindings or observed state for notification and sound preferences
- Takes `playerProfileRepository: PlayerProfileRepositoryProtocol` and `notificationManager: NotificationManager`
- Loads PlayerProfile on appear
- Toggle: "Quest Reminders" -- bound to profile.notificationsEnabled
  - When toggled ON: request authorization, if granted, reschedule all routine notifications using profile.notificationHour/minute
  - When toggled OFF: cancel all reminders
  - If authorization denied: show inline text "Notifications are disabled in Settings" with a button to open Settings (UIApplication.shared.open(URL(string: UIApplication.openSettingsURLString)!))
- Toggle: "Sound Effects" -- bound to profile.soundEnabled (also syncs to SoundManager.isMuted)
- Time picker: "Reminder Time" -- DatePicker with .hourAndMinute style, bound to profile notification hour/minute. Only visible when notifications are enabled.
- Save changes to profile via repository when toggles change
- Design: List/Form style with sections, matching iOS system settings appearance
  </action>
  <verify>
Verify files exist and have correct imports:
- `ls TimeQuest/Services/SoundManager.swift TimeQuest/Services/NotificationManager.swift TimeQuest/Game/CelebrationScene.swift TimeQuest/Features/Player/Views/NotificationSettingsView.swift`
- `grep "import AVFoundation" TimeQuest/Services/SoundManager.swift`
- `grep "import UserNotifications" TimeQuest/Services/NotificationManager.swift`
- `grep "import SpriteKit" TimeQuest/Game/CelebrationScene.swift`
  </verify>
  <done>
SoundManager wraps AVAudioPlayer with preload/play/mute. NotificationManager schedules weekly UNCalendarNotificationTrigger with deterministic IDs and game-framed messaging. CelebrationScene renders type-specific particle bursts. NotificationSettingsView provides player-controlled toggles for notifications and sound.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate sensory feedback into views and update build system</name>
  <files>
    TimeQuest/Features/Player/Views/AccuracyRevealView.swift
    TimeQuest/Features/Player/Views/SessionSummaryView.swift
    TimeQuest/Features/Player/Views/PlayerHomeView.swift
    TimeQuest/Game/AccuracyRevealScene.swift
    TimeQuest/App/AppDependencies.swift
    TimeQuest/App/TimeQuestApp.swift
    generate-xcodeproj.js
  </files>
  <action>
**AccuracyRevealView.swift** -- Add haptics, sounds, and milestone celebrations:
- Add `@State private var hapticTrigger = false` for .sensoryFeedback
- Add `.sensoryFeedback(.impact(weight: .medium, intensity: 0.8), trigger: hapticTrigger)` modifier on the main VStack
- When `showActual` becomes true (the accuracy reveal moment): toggle hapticTrigger to fire haptic
- Access SoundManager from environment (add as @Environment or accept as parameter). Play "reveal" sound when showActual fires.
- Add milestone celebration support:
  - If `viewModel.isNewPersonalBest` is true: show CelebrationScene(celebrationType: .personalBest) in a SpriteView overlay (similar to existing spot_on celebration)
  - Modify the existing spot_on celebration to ALSO check for personal best -- if both, prioritize personal best visual
  - Play "personal_best" sound for personal bests, "reveal" for standard reveals
- Keep all existing functionality (staggered reveal, feedback card, calibration info) -- only ADD, do not remove

**SessionSummaryView.swift** -- Add level-up celebration and sound:
- If `viewModel.didLevelUp` is true: show CelebrationScene(celebrationType: .levelUp) as a SpriteView overlay at the top of the summary
- Play "level_up" sound on appear if didLevelUp is true
- Play "session_complete" sound on appear for all completions
- Add `.sensoryFeedback(.success, trigger: summaryAppearTrigger)` -- fire a success haptic when the summary appears
- Access SoundManager from environment or accept as parameter

**PlayerHomeView.swift** -- Add navigation to notification settings:
- Add a gear icon button in the navigation bar (toolbar) that navigates to NotificationSettingsView
- Pass appropriate dependencies (playerProfileRepository from environment/AppDependencies, notificationManager)
- Keep existing triple-tap parent access on the logo

**AccuracyRevealScene.swift** -- No changes needed (existing scene handles spot_on). Keep as-is.

**AppDependencies.swift** -- Add SoundManager and NotificationManager:
- Add `let soundManager: SoundManager` property
- Add `let notificationManager: NotificationManager` property
- Initialize in init: `self.soundManager = SoundManager()`, `self.notificationManager = NotificationManager()`
- Call `soundManager.preloadAll()` (or preload individual sounds) in init

**TimeQuestApp.swift** -- Ensure SoundManager and NotificationManager are available in environment:
- If using @Environment pattern: inject soundManager and notificationManager into the view hierarchy via `.environment()` modifiers on RoleRouter
- Alternative: since AppDependencies is already @Observable, adding the properties there may be sufficient if views can access AppDependencies from environment. Choose whichever pattern Phase 1 uses for passing dependencies.

**generate-xcodeproj.js** -- Add all new files:
- Add to sourceFiles:
  - `{ name: 'SoundManager.swift', path: 'Services/SoundManager.swift' }`
  - `{ name: 'NotificationManager.swift', path: 'Services/NotificationManager.swift' }`
  - `{ name: 'CelebrationScene.swift', path: 'Game/CelebrationScene.swift' }`
  - `{ name: 'NotificationSettingsView.swift', path: 'Features/Player/Views/NotificationSettingsView.swift' }`
- Add a new 'Services' group to the groups array:
  - `{ name: 'Services', path: 'Services', files: ['SoundManager.swift', 'NotificationManager.swift'] }`
- Add 'Services' to the mainGroup children (in the groupSections main group builder, add `${id('group_Services')} /* Services */` alongside App, Models, etc.)
- Add 'CelebrationScene.swift' to the Game group's files array
- Add 'NotificationSettingsView.swift' to the PlayerViews group's files array
- ALSO: Create the Resources/Sounds/ directory and add placeholder sound files. Create minimal valid .wav files (can be silent 0.1s files) for: estimate_lock.wav, reveal.wav, level_up.wav, personal_best.wav, session_complete.wav. These can be replaced with real sound effects later. Add the Sounds directory to the Resources group and add the .wav files as resource build files (not source files). Update the resourcesBuildPhase to include them.
  - For placeholder .wav files: generate a minimal WAV header (44 bytes header + a few bytes of silence). A simple approach is to use Node.js Buffer to write a valid WAV file with 0.1s of silence at 44100Hz 16-bit mono.
- Run `node generate-xcodeproj.js` to regenerate

CRITICAL: Ensure haptics use `.sensoryFeedback()` modifier (iOS 17+, declarative) NOT UIKit UIFeedbackGenerator. The research explicitly recommends this approach.

CRITICAL: Sound effects must be OPTIONAL. If .wav files are missing or fail to load, the app must not crash. SoundManager.preload() silently handles missing files.
  </action>
  <verify>
1. Run `node "/Users/davezabihaylo/Desktop/Claude Cowork/GSD/generate-xcodeproj.js"` -- succeeds
2. Build: `cd "/Users/davezabihaylo/Desktop/Claude Cowork/GSD/TimeQuest" && xcodebuild -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.2' build 2>&1 | tail -30`
3. Build succeeds with zero errors
4. Verify haptic integration: `grep "sensoryFeedback" TimeQuest/Features/Player/Views/AccuracyRevealView.swift` finds the modifier
5. Verify notification scheduling: `grep "UNCalendarNotificationTrigger" TimeQuest/Services/NotificationManager.swift` finds the trigger
6. Verify sound manager: `grep "AVAudioPlayer" TimeQuest/Services/SoundManager.swift` finds the player
7. Verify Services group in pbxproj: `grep "Services" TimeQuest/TimeQuest.xcodeproj/project.pbxproj` finds the group reference
  </verify>
  <done>
AccuracyRevealView fires haptic on reveal and plays sound. SessionSummaryView shows level-up celebration particles and plays completion sound. PlayerHomeView has settings gear navigating to NotificationSettingsView. CelebrationScene renders type-specific particles. SoundManager and NotificationManager are wired through AppDependencies. Placeholder sound files exist in Resources/Sounds/. Project builds cleanly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 2 engagement layer</name>
  <what-built>
Complete Phase 2 engagement layer: XP/level progression system, participation streaks, personal bests, accuracy trend charts, haptic feedback, sound effects, milestone celebrations, and game-framed notifications with player-controlled preferences.
  </what-built>
  <how-to-verify>
**SETUP: Launch the app in iOS Simulator (iPhone 16, iOS 18.2)**

Open Xcode, select the TimeQuest scheme, choose iPhone 16 simulator, and press Cmd+R to build and run.

**If this is a fresh install (no data from Phase 1 testing), you need to create a routine first:**

1. On the player home screen, TRIPLE-TAP the TimeQuest logo (clock icon area) to trigger hidden parent access
2. Enter PIN: 0000 (the default PIN)
3. In Parent Dashboard, tap "Add Routine"
4. Set display name to "Morning Routine"
5. Add 2-3 tasks (e.g., "Shower" with 5 min reference, "Brush Teeth" with 2 min reference, "Get Dressed" with 3 min reference)
6. Set schedule to include today's day of the week
7. Save the routine
8. Tap "Switch to Player" or restart the app to return to player mode

**TEST 1: Progression display on home screen**
- Expected: Player home screen shows "Time Sense -- New" (or "Time Sense Lv. 1" if you've played before), an XP progress bar, and a streak count with a flame icon
- The streak flame should be gray if you haven't played today, orange if you have

**TEST 2: Complete a quest and earn XP**
- Tap on the available quest (e.g., "Morning Routine")
- For each task:
  a. Set your time estimate using the picker (try to be close to the reference duration)
  b. Tap to lock in your estimate -- you should feel a subtle HAPTIC on your device (or see the debug haptic indicator in simulator)
  c. Wait approximately the estimated time, then tap "Done"
  d. Watch the accuracy reveal -- you should feel a HAPTIC when the actual time is revealed
  e. If you got a "Spot On" rating, you should see PARTICLE CELEBRATION effects
  f. Tap "Next Step" to continue
- After all tasks, the Session Summary should show:
  - "+XX XP" in teal text (should be 40-100+ depending on accuracy)
  - If this pushed you to a new level: "Level Up!" in orange with gold particle celebration
  - Normal summary stats (average accuracy, over/under counts, best task)
- Tap "Finish" to return to home

**TEST 3: Verify progression updated**
- Back on home screen, verify:
  - Level badge now shows "Time Sense Lv. 1" (or higher)
  - XP bar shows progress (partially filled)
  - Streak shows "1" with an orange flame (you played today)

**TEST 4: View stats and accuracy chart**
- Tap "View Your Stats" link below the quest list
- Expected: Player Stats screen with:
  - "Accuracy Trend" section -- may show "Complete a few quests to see your accuracy trend" if only one session, or a chart point if data exists
  - "Personal Bests" section -- shows your closest estimates per task (e.g., "Shower: 0:08 off")
- Navigate back to home

**TEST 5: Notification settings**
- Tap the gear icon in the navigation bar
- Expected: Settings screen with:
  - "Quest Reminders" toggle (should be ON by default)
  - "Reminder Time" picker (default 7:30 AM) -- only visible when reminders are ON
  - "Sound Effects" toggle (should be ON by default)
- Toggle notifications OFF -- reminders should be cancelled
- Toggle notifications ON -- should request permission (simulator will show a permission alert; tap "Allow")
- Toggle sound OFF -- sound effects should stop playing in gameplay
- Navigate back to home

**TEST 6: Personal best detection (requires 2+ sessions on same routine)**
- If you have time, complete the same quest again
- Try to be MORE accurate this time
- On the accuracy reveal for a task where you improved: you should see a personal best celebration (teal particles, different from the spot-on gold particles)

**TEST 7: Streak behavior**
- After completing at least one quest today, the streak should show "1" with orange flame
- (Cannot easily test consecutive-day or gap behavior in a single session -- this is a code-level correctness matter verified by the StreakTracker implementation)

**KNOWN LIMITATIONS:**
- Sound effects use placeholder (silent) .wav files -- you may not hear actual sounds unless real sound assets were added. The SoundManager infrastructure is what matters.
- Haptics only work on a real device or are indicated in simulator via debug output
- Notification scheduling works but won't fire visible notifications in simulator without additional setup
  </how-to-verify>
  <resume-signal>Type "approved" if the engagement layer works correctly, or describe any issues you see.</resume-signal>
</task>

</tasks>

<verification>
1. Project builds: `xcodebuild -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.2' build` succeeds
2. All new files exist in correct directories (Services/, Game/, Features/Player/Views/)
3. Haptic feedback: .sensoryFeedback modifier present in AccuracyRevealView and SessionSummaryView
4. Sound infrastructure: SoundManager with preload/play/mute toggle
5. Notifications: NotificationManager with deterministic IDs and game-framed messaging
6. CelebrationScene: Three celebration types (levelUp, personalBest, streak)
7. Settings: NotificationSettingsView with player-controlled toggles
8. No Phase 1 regressions: quest flow, estimation, feedback, calibration all still work
</verification>

<success_criteria>
- Player feels haptic feedback on estimate lock-in and accuracy reveal
- Sound effects play on key moments (when not muted)
- Milestone celebrations show type-specific particle effects
- Notifications use game framing ("Quest Available!") not task framing
- One notification per routine per scheduled day (deterministic IDs prevent duplicates)
- Player can toggle notifications and sound on/off
- All sensory features are optional and non-blocking (app works fine without them)
- Human verification confirms the complete Phase 2 experience works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/02-engagement-layer/02-03-SUMMARY.md`
</output>
