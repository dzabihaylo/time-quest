---
phase: 02-engagement-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TimeQuest/Models/PlayerProfile.swift
  - TimeQuest/Models/GameSession.swift
  - TimeQuest/Domain/XPEngine.swift
  - TimeQuest/Domain/LevelCalculator.swift
  - TimeQuest/Domain/StreakTracker.swift
  - TimeQuest/Domain/PersonalBestTracker.swift
  - TimeQuest/Repositories/PlayerProfileRepository.swift
  - TimeQuest/App/AppDependencies.swift
  - TimeQuest/App/TimeQuestApp.swift
  - TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift
  - generate-xcodeproj.js
autonomous: true

must_haves:
  truths:
    - "Completing a quest awards XP based on estimation accuracy (not speed) and persists it to PlayerProfile"
    - "Player level is calculated from accumulated XP using a concave curve (fast early levels)"
    - "Daily participation streak increments on consecutive days and pauses (not resets) on gaps"
    - "Personal best detection identifies the closest-ever estimate per task"
  artifacts:
    - path: "TimeQuest/Models/PlayerProfile.swift"
      provides: "SwiftData singleton model for XP, level, streak, preferences"
      contains: "@Model"
    - path: "TimeQuest/Domain/XPEngine.swift"
      provides: "Pure XP calculation from AccuracyRating"
      contains: "struct XPEngine"
    - path: "TimeQuest/Domain/LevelCalculator.swift"
      provides: "Level-from-XP concave curve calculation"
      contains: "struct LevelCalculator"
    - path: "TimeQuest/Domain/StreakTracker.swift"
      provides: "Graceful streak pause semantics"
      contains: "struct StreakTracker"
    - path: "TimeQuest/Domain/PersonalBestTracker.swift"
      provides: "Personal best detection per task"
      contains: "struct PersonalBestTracker"
    - path: "TimeQuest/Repositories/PlayerProfileRepository.swift"
      provides: "Fetch-or-create singleton, XP update, streak update"
      contains: "protocol PlayerProfileRepositoryProtocol"
    - path: "TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift"
      provides: "XP award and streak update on session completion"
      contains: "xpForSession"
  key_links:
    - from: "TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift"
      to: "TimeQuest/Domain/XPEngine.swift"
      via: "XPEngine.xpForSession call in advanceToNextTask/session completion"
      pattern: "XPEngine\\.xpForSession"
    - from: "TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift"
      to: "TimeQuest/Repositories/PlayerProfileRepository.swift"
      via: "playerProfileRepository.addXP and updateStreak calls"
      pattern: "playerProfileRepository"
    - from: "TimeQuest/App/TimeQuestApp.swift"
      to: "TimeQuest/Models/PlayerProfile.swift"
      via: "modelContainer includes PlayerProfile.self"
      pattern: "PlayerProfile\\.self"
    - from: "TimeQuest/App/AppDependencies.swift"
      to: "TimeQuest/Repositories/PlayerProfileRepository.swift"
      via: "AppDependencies creates playerProfileRepository"
      pattern: "playerProfileRepository"
---

<objective>
Build the progression data layer: domain engines for XP calculation, level curves, streak tracking, and personal bests; the PlayerProfile persistence model; and integration into GameSessionViewModel so that completing a quest awards XP and updates the streak.

Purpose: This is the foundation for all Phase 2 features. Every UI component (XP bar, level badge, streak badge, charts) and every sensory trigger (celebration on level-up) depends on XP being awarded and streaks being tracked when sessions complete.

Output: Five pure domain engine files, one new SwiftData model, one new repository, and three modified files (GameSession, GameSessionViewModel, AppDependencies, TimeQuestApp) that wire everything together. Updated generate-xcodeproj.js to include new files.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-engagement-layer/02-RESEARCH.md

@TimeQuest/Models/GameSession.swift
@TimeQuest/Models/TaskEstimation.swift
@TimeQuest/Domain/TimeEstimationScorer.swift
@TimeQuest/Domain/CalibrationTracker.swift
@TimeQuest/Repositories/SessionRepository.swift
@TimeQuest/App/AppDependencies.swift
@TimeQuest/App/TimeQuestApp.swift
@TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift
@generate-xcodeproj.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create domain engines and PlayerProfile model</name>
  <files>
    TimeQuest/Models/PlayerProfile.swift
    TimeQuest/Domain/XPEngine.swift
    TimeQuest/Domain/LevelCalculator.swift
    TimeQuest/Domain/StreakTracker.swift
    TimeQuest/Domain/PersonalBestTracker.swift
  </files>
  <action>
Create five new files following the Phase 1 pure-domain-engine pattern (like TimeEstimationScorer.swift):

**PlayerProfile.swift** -- SwiftData @Model singleton:
- Properties: `totalXP: Int = 0`, `currentStreak: Int = 0`, `lastPlayedDate: Date?`, `notificationsEnabled: Bool = true`, `notificationHour: Int = 7`, `notificationMinute: Int = 30`, `soundEnabled: Bool = true`, `createdAt: Date = Date.now`
- All properties MUST have default values (SwiftData lightweight migration requirement -- see research pitfall 1)
- Simple `init() {}` with no parameters (all defaults)

**XPEngine.swift** -- Pure struct, no imports except Foundation:
- `static func xpForEstimation(rating: AccuracyRating) -> Int` -- spot_on=100, close=60, off=25, way_off=10. NEVER reward speed, only accuracy.
- `static func xpForSession(estimations: [TaskEstimation]) -> Int` -- sum of task XP + 20 completion bonus
- Uses AccuracyRating enum from TimeEstimationScorer.swift (already exists)

**LevelCalculator.swift** -- Pure struct:
- Private static constants: `baseXP: Double = 100`, `exponent: Double = 1.5`
- `static func xpRequired(forLevel level: Int) -> Int` -- `Int(baseXP * pow(Double(level), exponent))`
- `static func level(fromTotalXP xp: Int) -> Int` -- inverse: `max(1, Int(floor(pow(Double(xp) / baseXP, 1.0 / exponent))))`; return 0 if xp <= 0
- `static func progressToNextLevel(totalXP: Int) -> Double` -- fraction 0.0-1.0 toward next level

**StreakTracker.swift** -- Pure struct:
- `struct StreakState` with `currentStreak: Int`, `lastPlayedDate: Date?`, `isActive: Bool`
- `static func updatedStreak(currentStreak: Int, lastPlayedDate: Date?, today: Date = .now) -> StreakState`
- Rules: same day = unchanged; next day = increment; 2+ day gap = PAUSE at current value (never reset, never punish). Use `Calendar.current.startOfDay(for:)`.
- First-ever session (lastPlayedDate nil) returns streak of 1

**PersonalBestTracker.swift** -- Pure struct:
- `struct PersonalBest` with `taskDisplayName: String`, `closestDifferenceSeconds: Double`, `date: Date`
- `static func findPersonalBests(from estimations: [TaskEstimation]) -> [PersonalBest]` -- groups by taskDisplayName, finds the estimation with minimum `abs(differenceSeconds)` for each task
- `static func isNewPersonalBest(taskDisplayName: String, differenceSeconds: Double, existingEstimations: [TaskEstimation]) -> Bool` -- returns true if this difference is smaller than all previous for this task name

All structs must be sendable-safe (pure value types, no mutable state). Match the coding style of TimeEstimationScorer.swift exactly.
  </action>
  <verify>
Build the project: `cd "/Users/davezabihaylo/Desktop/Claude Cowork/GSD/TimeQuest" && xcodebuild -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.2' build 2>&1 | tail -20`

All five files compile without errors or warnings. The new types are recognized by the Swift compiler.
  </verify>
  <done>
PlayerProfile @Model exists with all progression properties defaulted. XPEngine returns correct XP for each AccuracyRating. LevelCalculator implements concave curve. StreakTracker pauses on gaps (never resets). PersonalBestTracker finds minimum abs(differenceSeconds) per task. All compile cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire progression into GameSessionViewModel and update build system</name>
  <files>
    TimeQuest/Models/GameSession.swift
    TimeQuest/Repositories/PlayerProfileRepository.swift
    TimeQuest/App/AppDependencies.swift
    TimeQuest/App/TimeQuestApp.swift
    TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift
    generate-xcodeproj.js
  </files>
  <action>
**PlayerProfileRepository.swift** -- New file following SessionRepository.swift pattern:
- `@MainActor protocol PlayerProfileRepositoryProtocol` with methods:
  - `func fetchOrCreate() -> PlayerProfile` -- fetch first PlayerProfile; if none, create and insert one
  - `func addXP(_ amount: Int, to profile: PlayerProfile)` -- updates totalXP, calls modelContext.save()
  - `func updateStreak(for profile: PlayerProfile, on date: Date)` -- uses StreakTracker.updatedStreak, writes currentStreak and lastPlayedDate, calls save()
  - `func save() throws`
- `@MainActor final class SwiftDataPlayerProfileRepository: PlayerProfileRepositoryProtocol` implementation
- fetchOrCreate uses FetchDescriptor with no predicate, limit 1. If empty, creates new PlayerProfile, inserts, returns it. This prevents the singleton race condition (research pitfall 7).

**GameSession.swift** -- Add ONE new property:
- `var xpEarned: Int = 0` -- default value of 0 is REQUIRED for SwiftData lightweight migration. Do NOT change the existing init signature; add `xpEarned` as a defaulted parameter: `xpEarned: Int = 0`.

**AppDependencies.swift** -- Add playerProfileRepository:
- Add property: `let playerProfileRepository: PlayerProfileRepositoryProtocol`
- Initialize in init: `self.playerProfileRepository = SwiftDataPlayerProfileRepository(modelContext: modelContext)`

**TimeQuestApp.swift** -- Register PlayerProfile in modelContainer:
- Change `.modelContainer(for: [...])` to include `PlayerProfile.self` in the array. Keep all existing model types.

**GameSessionViewModel.swift** -- Integrate XP award and streak update:
- Add `private let playerProfileRepository: PlayerProfileRepositoryProtocol` property
- Update init to accept `playerProfileRepository: PlayerProfileRepositoryProtocol` parameter
- Add `private(set) var sessionXPEarned: Int = 0` observable property (for UI to read later)
- Add `private(set) var isNewPersonalBest: Bool = false` observable property
- Add `private(set) var didLevelUp: Bool = false` observable property
- Add `private(set) var previousLevel: Int = 0` observable property
- In `advanceToNextTask()`, when all tasks are done (the else branch that sets phase to .summary):
  1. Calculate XP: `let xp = XPEngine.xpForSession(estimations: session.orderedEstimations)`
  2. Store on session: `session.xpEarned = xp`
  3. Fetch profile: `let profile = playerProfileRepository.fetchOrCreate()`
  4. Record previous level: `previousLevel = LevelCalculator.level(fromTotalXP: profile.totalXP)`
  5. Add XP: `playerProfileRepository.addXP(xp, to: profile)`
  6. Check level up: `didLevelUp = LevelCalculator.level(fromTotalXP: profile.totalXP) > previousLevel`
  7. Update streak: `playerProfileRepository.updateStreak(for: profile, on: .now)`
  8. Store for UI: `sessionXPEarned = xp`
  9. Save context
- In `completeActiveTask()`, after saving the estimation, check for personal best:
  1. Fetch all estimations for this task name from the session repository (or use a predicate on TaskEstimation)
  2. Call `PersonalBestTracker.isNewPersonalBest(taskDisplayName:differenceSeconds:existingEstimations:)` -- pass all PREVIOUS estimations (excluding the one just created)
  3. Set `isNewPersonalBest` accordingly (reset to false on next task advance)
- In `advanceToNextTask()`, at the top, reset `isNewPersonalBest = false` before moving to next task
- In `finishQuest()`, reset `sessionXPEarned = 0`, `isNewPersonalBest = false`, `didLevelUp = false`

IMPORTANT: You must also find everywhere that creates a GameSessionViewModel and add the new `playerProfileRepository` parameter. Search for `GameSessionViewModel(` in all files. The QuestView.swift likely creates this -- update it to pass `playerProfileRepository` from the environment or from AppDependencies.

**generate-xcodeproj.js** -- Add all new files to the build:
- Add to sourceFiles array:
  - `{ name: 'PlayerProfile.swift', path: 'Models/PlayerProfile.swift' }`
  - `{ name: 'XPEngine.swift', path: 'Domain/XPEngine.swift' }`
  - `{ name: 'LevelCalculator.swift', path: 'Domain/LevelCalculator.swift' }`
  - `{ name: 'StreakTracker.swift', path: 'Domain/StreakTracker.swift' }`
  - `{ name: 'PersonalBestTracker.swift', path: 'Domain/PersonalBestTracker.swift' }`
  - `{ name: 'PlayerProfileRepository.swift', path: 'Repositories/PlayerProfileRepository.swift' }`
- Add 'PlayerProfile.swift' to the Models group's files array
- Add 'XPEngine.swift', 'LevelCalculator.swift', 'StreakTracker.swift', 'PersonalBestTracker.swift' to the Domain group's files array
- Add 'PlayerProfileRepository.swift' to the Repositories group's files array
- Run `node generate-xcodeproj.js` to regenerate the pbxproj

CRITICAL NOTES:
- Group paths in generate-xcodeproj.js must be RELATIVE (e.g., 'Models' not 'TimeQuest/Models') to avoid path duplication
- All new GameSession properties MUST have default values (SwiftData migration safety)
- PlayerProfile creation must happen only via fetchOrCreate pattern on @MainActor (prevents duplicates)
- Value-type editing pattern: mutate @Model properties only in explicit repository methods, then save
  </action>
  <verify>
1. Run `node "/Users/davezabihaylo/Desktop/Claude Cowork/GSD/generate-xcodeproj.js"` -- should succeed
2. Build: `cd "/Users/davezabihaylo/Desktop/Claude Cowork/GSD/TimeQuest" && xcodebuild -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.2' build 2>&1 | tail -30`
3. Build succeeds with zero errors. Grep for key wiring: `grep -r "XPEngine" TimeQuest/Features/` should find the call in GameSessionViewModel. `grep -r "PlayerProfile.self" TimeQuest/App/` should find registration in TimeQuestApp.
  </verify>
  <done>
GameSession has xpEarned property. PlayerProfileRepository provides fetch-or-create singleton access. AppDependencies exposes playerProfileRepository. TimeQuestApp registers PlayerProfile in modelContainer. GameSessionViewModel awards XP on session completion, updates streak, detects personal bests and level-ups. generate-xcodeproj.js includes all new files. Project builds cleanly.
  </done>
</task>

</tasks>

<verification>
1. Project builds: `xcodebuild -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.2' build` succeeds
2. All new files exist: PlayerProfile.swift, XPEngine.swift, LevelCalculator.swift, StreakTracker.swift, PersonalBestTracker.swift, PlayerProfileRepository.swift
3. Key integrations present: GameSessionViewModel references XPEngine and playerProfileRepository; TimeQuestApp includes PlayerProfile.self in modelContainer
4. No regressions: All Phase 1 gameplay logic still compiles and functions (estimation scoring, feedback generation, calibration tracking unchanged)
</verification>

<success_criteria>
- XP calculation is pure and accuracy-based (never speed-based)
- Level curve is concave (fast early levels, slower later)
- Streak pauses on gaps (never resets, never punishes)
- Personal best detection works across all estimations for a task
- PlayerProfile is created once via fetch-or-create pattern
- All new properties on existing models have defaults (migration safe)
- Project builds cleanly with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-engagement-layer/02-01-SUMMARY.md`
</output>
