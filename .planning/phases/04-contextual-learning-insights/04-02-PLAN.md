---
phase: 04-contextual-learning-insights
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - TimeQuest/Features/Shared/Components/InsightCardView.swift
  - TimeQuest/Features/Player/Views/MyPatternsView.swift
  - TimeQuest/Features/Player/ViewModels/MyPatternsViewModel.swift
  - TimeQuest/Features/Player/Views/PlayerHomeView.swift
  - TimeQuest/Features/Player/Views/EstimationInputView.swift
  - TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift
autonomous: true

must_haves:
  truths:
    - "Player can navigate to My Patterns from the home screen and see per-task insights grouped by routine"
    - "Each insight card shows bias direction, accuracy trend, and consistency with curiosity-framed language"
    - "During gameplay, before estimating a task with known patterns, player sees a contextual reference hint"
    - "Contextual hints show reference data (Last 5 times: ~Xm Ys) not corrections"
    - "Tasks with fewer than 5 non-calibration sessions show no insights on My Patterns or hints in gameplay"
    - "My Patterns shows a friendly empty state when no tasks have enough history"
    - "InsightCardView renders identically on My Patterns screen and could be reused in other contexts"
  artifacts:
    - path: "TimeQuest/Features/Shared/Components/InsightCardView.swift"
      provides: "Shared insight card component"
      contains: "struct InsightCardView"
    - path: "TimeQuest/Features/Player/Views/MyPatternsView.swift"
      provides: "Dedicated patterns screen grouped by routine"
      contains: "struct MyPatternsView"
    - path: "TimeQuest/Features/Player/ViewModels/MyPatternsViewModel.swift"
      provides: "Data loading and InsightEngine orchestration for patterns screen"
      contains: "final class MyPatternsViewModel"
    - path: "TimeQuest/Features/Player/Views/PlayerHomeView.swift"
      provides: "Navigation link to My Patterns"
      contains: "My Patterns"
    - path: "TimeQuest/Features/Player/Views/EstimationInputView.swift"
      provides: "Contextual hint display above estimation picker"
      contains: "contextualHint"
    - path: "TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift"
      provides: "Hint preloading for all routine tasks"
      contains: "contextualHints"
  key_links:
    - from: "TimeQuest/Features/Player/ViewModels/MyPatternsViewModel.swift"
      to: "TimeQuest/Domain/InsightEngine.swift"
      via: "calls InsightEngine.generateInsights"
      pattern: "InsightEngine\\.generateInsights"
    - from: "TimeQuest/Features/Player/ViewModels/MyPatternsViewModel.swift"
      to: "TimeQuest/Models/EstimationSnapshot.swift"
      via: "maps TaskEstimation to EstimationSnapshot"
      pattern: "EstimationSnapshot.*from"
    - from: "TimeQuest/Features/Player/Views/MyPatternsView.swift"
      to: "TimeQuest/Features/Shared/Components/InsightCardView.swift"
      via: "renders InsightCardView for each TaskInsight"
      pattern: "InsightCardView"
    - from: "TimeQuest/Features/Player/Views/PlayerHomeView.swift"
      to: "TimeQuest/Features/Player/Views/MyPatternsView.swift"
      via: "NavigationLink"
      pattern: "NavigationLink.*MyPatternsView"
    - from: "TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift"
      to: "TimeQuest/Domain/InsightEngine.swift"
      via: "calls InsightEngine.contextualHint for each task on quest start"
      pattern: "InsightEngine\\.contextualHint"
    - from: "TimeQuest/Features/Player/Views/EstimationInputView.swift"
      to: "TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift"
      via: "reads contextualHints dictionary for current task"
      pattern: "viewModel\\.contextualHint"
---

<objective>
Build the My Patterns screen, InsightCardView shared component, contextual gameplay hints, and navigation wiring.

Purpose: This plan surfaces InsightEngine's analysis to the player through two UI surfaces: (1) a dedicated "My Patterns" screen navigable from the home screen showing all per-task insights grouped by routine, and (2) contextual reference hints shown inline during the estimation phase for tasks with known patterns. Together these give the player awareness of her estimation patterns without being corrective or judgmental.

Output: Complete insight UI layer -- My Patterns screen, InsightCardView, contextual hints, and all navigation wiring.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-contextual-learning-insights/04-RESEARCH.md
@.planning/phases/04-contextual-learning-insights/04-01-SUMMARY.md

@TimeQuest/Domain/InsightEngine.swift
@TimeQuest/Models/EstimationSnapshot.swift
@TimeQuest/Features/Player/Views/PlayerHomeView.swift
@TimeQuest/Features/Player/Views/EstimationInputView.swift
@TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift
@TimeQuest/Features/Player/Views/QuestView.swift
@TimeQuest/Features/Player/Views/PlayerStatsView.swift
@TimeQuest/Features/Player/ViewModels/ProgressionViewModel.swift
@TimeQuest/Features/Shared/Components/AccuracyMeter.swift
@TimeQuest/Features/Shared/Components/TimeFormatting.swift
@TimeQuest/Repositories/SessionRepository.swift
@TimeQuest/App/AppDependencies.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InsightCardView shared component and MyPatternsViewModel</name>
  <files>
    TimeQuest/Features/Shared/Components/InsightCardView.swift
    TimeQuest/Features/Player/ViewModels/MyPatternsViewModel.swift
  </files>
  <action>
**InsightCardView.swift** -- Create in `TimeQuest/Features/Shared/Components/`:

A reusable SwiftUI view that displays a single `TaskInsight` as a card. Follow the card pattern used in PlayerHomeView (`.padding(16)`, `.background(Color(.systemGray6))`, `.clipShape(RoundedRectangle(cornerRadius: 12))`).

Structure:
- Header: task display name in `.headline` font
- Bias row (if bias exists and direction != .balanced): icon + curiosity-framed text
  - `.overestimates`: arrow.up.right icon, .orange color, "Interesting -- you tend to overestimate by ~{formatted duration}"
  - `.underestimates`: arrow.down.right icon, .teal color, "Interesting -- you tend to underestimate by ~{formatted duration}"
  - `.balanced`: checkmark.circle icon, .green color, "Your estimates are well-balanced"
- Trend row (always show if trend exists):
  - `.improving`: chart.line.uptrend.xyaxis icon, .green color, "Your estimates are getting closer over time"
  - `.declining`: chart.line.downtrend.xyaxis icon, .orange color, "This one's been harder to read lately"
  - `.stable`: equal icon, .secondary color, "Steady -- your feel for this hasn't changed much"
- Consistency row (always show if consistency exists):
  - `.veryConsistent`: waveform.path icon, .green color, "You read this one the same way each time"
  - `.moderate`: waveform.path icon, .secondary color, "Your estimates vary a bit from time to time"
  - `.variable`: waveform.path.ecg icon, .orange color, "This one's unpredictable -- your estimates vary quite a bit"
- Sample count footer: "Based on {N} sessions" in `.caption2`, `.tertiary` color

Use a private `insightRow(icon:color:text:)` helper that returns `HStack(spacing: 8)` with Image(systemName:) and Text. Format durations with `TimeFormatting.formatDuration(abs(bias.meanDifferenceSeconds))`.

All text uses curiosity framing per REQ-017. NEVER use "bad", "wrong", "failed", "inaccurate". Follow the FeedbackGenerator tone: exploratory, not judgmental.

**MyPatternsViewModel.swift** -- Create in `TimeQuest/Features/Player/ViewModels/`:

`@MainActor @Observable final class MyPatternsViewModel`:
- Property: `var insightsByRoutine: [(routineName: String, insights: [TaskInsight])] = []`
- Property: `var isLoaded: Bool = false`
- Private: `modelContext: ModelContext`
- Init takes `modelContext: ModelContext`
- `func refresh()`:
  1. Fetch all TaskEstimation with `FetchDescriptor<TaskEstimation>(sortBy: [SortDescriptor(\.recordedAt)])`
  2. Map to `[EstimationSnapshot]` using `EstimationSnapshot(from:)`
  3. Group snapshots by `routineName` using Dictionary(grouping:)
  4. For each routine group, group by `taskDisplayName`
  5. For each task group, filter `!isCalibration`, check count >= InsightEngine.minimumSessions
  6. For eligible tasks, call `InsightEngine.detectBias`, `InsightEngine.detectTrend`, `InsightEngine.computeConsistency` and build `TaskInsight` (with recentActualSeconds from last 5 sorted by date desc)
  7. Assemble into `insightsByRoutine`, filter out routines with no insights, sort by routineName
  8. Set `isLoaded = true`

Alternative (simpler): After mapping all snapshots, call `InsightEngine.generateInsights(snapshots:)` to get `[TaskInsight]`, then group the results by `routineName` for display. This uses the composite function built in Plan 01. Only use the manual approach if `generateInsights` doesn't group by routine (it groups by task only).
  </action>
  <verify>Build succeeds. InsightCardView previews render (if using #Preview). MyPatternsViewModel compiles and correctly references InsightEngine types.</verify>
  <done>InsightCardView displays all three insight types with curiosity-framed language and consistent card styling. MyPatternsViewModel fetches, maps, and computes insights grouped by routine.</done>
</task>

<task type="auto">
  <name>Task 2: Create MyPatternsView and add navigation from PlayerHomeView</name>
  <files>
    TimeQuest/Features/Player/Views/MyPatternsView.swift
    TimeQuest/Features/Player/Views/PlayerHomeView.swift
  </files>
  <action>
**MyPatternsView.swift** -- Create in `TimeQuest/Features/Player/Views/`:

Structure:
- `@Environment(\.modelContext) private var modelContext`
- `@State private var viewModel: MyPatternsViewModel?`
- NavigationStack not needed (pushed from PlayerHomeView's NavigationStack)
- `.navigationTitle("My Patterns")`
- `.navigationBarTitleDisplayMode(.large)`

Body:
- If viewModel not loaded or insightsByRoutine is empty, show **empty state**:
  - VStack centered: Image(systemName: "chart.bar.doc.horizontal") in `.system(size: 48)`, `.secondary` color
  - "Patterns appear after 5 sessions per task" in `.title3`, `.secondary`
  - "Keep playing -- every quest teaches your time sense something new" in `.subheadline`, `.tertiary`
- If insightsByRoutine has data, show a **ScrollView** with **LazyVStack(spacing: 24)**:
  - For each routine group: section header with routine name in `.title3.bold()`, then ForEach insights rendering `InsightCardView(insight:)`
  - Padding: `.padding(.horizontal, 16)`
- `.onAppear`: create MyPatternsViewModel(modelContext:), call refresh()

**PlayerHomeView.swift** -- Modify:

Add a "My Patterns" navigation link near the existing "View Your Stats" link. Place it ABOVE the stats link so the player sees the new feature prominently.

Add a new NavigationLink block (same styling as the stats link):
```swift
NavigationLink {
    MyPatternsView()
} label: {
    HStack(spacing: 4) {
        Text("My Patterns")
        Image(systemName: "chevron.right")
    }
    .font(.caption)
    .foregroundStyle(.secondary)
}
```

Place this inside the existing `if progressionVM != nil` block, above the "View Your Stats" NavigationLink. Wrap both links in a VStack(spacing: 8) for clean vertical spacing.
  </action>
  <verify>Build succeeds. PlayerHomeView shows "My Patterns" navigation link. Tapping it navigates to MyPatternsView. Empty state displays when no tasks have 5+ sessions.</verify>
  <done>My Patterns screen is navigable from the home screen, shows per-task insights grouped by routine, and displays a friendly empty state for new players.</done>
</task>

<task type="auto">
  <name>Task 3: Add contextual hints to estimation flow and update build system</name>
  <files>
    TimeQuest/Features/Player/ViewModels/GameSessionViewModel.swift
    TimeQuest/Features/Player/Views/EstimationInputView.swift
  </files>
  <action>
**GameSessionViewModel.swift** -- Modify:

Add a new property to hold preloaded contextual hints:
```swift
private(set) var contextualHints: [String: String] = [:]  // taskDisplayName -> hint text
```

In `startQuest()`, after setting `isCalibration` and creating the session, add hint preloading:
1. Fetch all TaskEstimation using a FetchDescriptor (same pattern as PersonalBestTracker usage in completeActiveTask)
2. Map all estimations to `[EstimationSnapshot]` using `EstimationSnapshot(from:)`
3. For each task in `routine.orderedTasks`, call `InsightEngine.contextualHint(taskName: task.displayName, snapshots: allSnapshots)`
4. Store non-nil results in `contextualHints` dictionary keyed by task display name
5. This preloading is synchronous and fast (filter + mean of 5-50 numbers), no async needed

Add a computed property for the current task's hint:
```swift
var currentTaskHint: String? {
    guard let task = currentTask else { return nil }
    return contextualHints[task.displayName]
}
```

Also clear `contextualHints` in `finishQuest()`.

Do NOT show hints during calibration sessions. Add a guard: if `isCalibration`, `currentTaskHint` should return nil. Simplest approach: in `startQuest()`, skip the preloading entirely if `isCalibration` is true (calibration sessions have no historical data to show anyway, and the player shouldn't see hints while the system is still learning her patterns).

**EstimationInputView.swift** -- Modify:

Add a contextual hint capsule above the task name, below the calibration banner. Only show if `viewModel.currentTaskHint` is non-nil AND `!viewModel.isCalibration`:

```swift
// Contextual hint (only for tasks with known patterns)
if let hint = viewModel.currentTaskHint {
    HStack(spacing: 6) {
        Image(systemName: "lightbulb")
            .font(.caption)
            .foregroundStyle(.orange)
        Text(hint)
            .font(.caption)
            .foregroundStyle(.secondary)
    }
    .padding(.horizontal, 12)
    .padding(.vertical, 6)
    .background(Color(.systemGray6))
    .clipShape(Capsule())
}
```

Place this after the calibration banner conditional and before the task name Text. The styling matches the calibration banner pattern exactly (same padding, background, clipShape) for visual consistency.

**Build system:** Add all new files to the Xcode project. Run the generate-xcodeproj.js script:
```bash
node generate-xcodeproj.js
```

New files to register:
- TimeQuest/Models/EstimationSnapshot.swift (from Plan 01)
- TimeQuest/Domain/InsightEngine.swift (from Plan 01)
- TimeQuest/Features/Shared/Components/InsightCardView.swift
- TimeQuest/Features/Player/Views/MyPatternsView.swift
- TimeQuest/Features/Player/ViewModels/MyPatternsViewModel.swift
- TimeQuest/Tests/InsightEngineTests.swift (test target, from Plan 01)

Verify the full project builds cleanly after all changes.
  </action>
  <verify>Build succeeds with `xcodebuild build` or equivalent. GameSessionViewModel preloads hints on quest start. EstimationInputView shows hint capsule for tasks with patterns. Hint does not appear during calibration sessions. All new files are in the Xcode project.</verify>
  <done>Contextual hints appear before estimation for tasks with 5+ non-calibration sessions, showing reference data ("Last 5 times: ~Xm Ys"). Hints are preloaded at quest start for zero latency. No hints during calibration. Build system updated with all Phase 4 files.</done>
</task>

</tasks>

<verification>
1. PlayerHomeView shows "My Patterns" navigation link
2. Tapping "My Patterns" navigates to MyPatternsView
3. MyPatternsView shows per-task insights grouped by routine with InsightCardView
4. Empty state shows friendly message when no tasks have enough history
5. InsightCardView shows bias, trend, and consistency with curiosity-framed language
6. During gameplay, contextual hint capsule appears above task name for tasks with patterns
7. Contextual hint shows "Last N times: ~Xm Ys" format
8. No hints appear during calibration sessions
9. No insights appear for tasks with fewer than 5 non-calibration sessions
10. Full project builds cleanly
</verification>

<success_criteria>
- My Patterns screen is navigable from PlayerHomeView and displays insights grouped by routine
- InsightCardView is a shared component in Features/Shared/Components (not duplicated)
- All insight text uses curiosity framing -- no judgmental language
- Contextual hints appear in EstimationInputView for eligible tasks only
- Hints are preloaded in GameSessionViewModel.startQuest() for zero-latency display
- Empty state on My Patterns is friendly and progress-oriented
- All files registered in Xcode project, full build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-contextual-learning-insights/04-02-SUMMARY.md`
</output>
