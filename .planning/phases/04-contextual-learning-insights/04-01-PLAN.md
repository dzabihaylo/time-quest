---
phase: 04-contextual-learning-insights
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - TimeQuest/Models/EstimationSnapshot.swift
  - TimeQuest/Domain/InsightEngine.swift
  - TimeQuest/Tests/InsightEngineTests.swift
autonomous: true

must_haves:
  truths:
    - "InsightEngine.detectBias returns overestimates/underestimates/balanced for a task with 5+ non-calibration snapshots"
    - "InsightEngine.detectTrend returns improving/declining/stable based on linear regression slope of accuracy"
    - "InsightEngine.computeConsistency returns veryConsistent/moderate/variable based on coefficient of variation"
    - "InsightEngine.contextualHint returns 'Last N times: ~Xm Ys' for tasks with 5+ non-calibration sessions"
    - "All InsightEngine functions return nil for tasks with fewer than 5 non-calibration snapshots"
    - "Calibration sessions are excluded from all analysis"
    - "EstimationSnapshot is a plain Swift struct with no SwiftData import"
  artifacts:
    - path: "TimeQuest/Models/EstimationSnapshot.swift"
      provides: "Value type decoupling domain from SwiftData"
      contains: "struct EstimationSnapshot"
    - path: "TimeQuest/Domain/InsightEngine.swift"
      provides: "Pure domain engine for bias, trend, consistency, and contextual hints"
      contains: "struct InsightEngine"
      exports: ["detectBias", "detectTrend", "computeConsistency", "contextualHint", "generateInsights"]
    - path: "TimeQuest/Tests/InsightEngineTests.swift"
      provides: "Unit tests for all InsightEngine functions"
      contains: "final class InsightEngineTests"
  key_links:
    - from: "TimeQuest/Domain/InsightEngine.swift"
      to: "TimeQuest/Models/EstimationSnapshot.swift"
      via: "consumes [EstimationSnapshot] parameter"
      pattern: "snapshots.*EstimationSnapshot"
    - from: "TimeQuest/Models/EstimationSnapshot.swift"
      to: "TimeQuest/Models/TaskEstimation.swift"
      via: "init(from:) mapping from SwiftData model"
      pattern: "init.*from.*TaskEstimation"
---

<objective>
Build the EstimationSnapshot value type and InsightEngine pure domain engine using TDD.

Purpose: The InsightEngine is the analytical core of Phase 4. It detects per-task bias (over/underestimation), accuracy trend (improving/declining/stable), consistency (how variable estimates are), and generates contextual reference hints. Building it with TDD ensures correctness of statistical computations and enforces the 5-session minimum threshold and calibration exclusion requirements. This engine is also a dependency for Phase 6's WeeklyReflectionEngine.

Output: Tested, pure-Swift InsightEngine with zero framework dependencies. EstimationSnapshot bridges SwiftData to the pure domain.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-contextual-learning-insights/04-RESEARCH.md

@TimeQuest/Domain/TimeEstimationScorer.swift
@TimeQuest/Domain/PersonalBestTracker.swift
@TimeQuest/Domain/FeedbackGenerator.swift
@TimeQuest/Models/TaskEstimation.swift
@TimeQuest/Models/GameSession.swift
@TimeQuest/Models/Schemas/TimeQuestSchemaV2.swift
@TimeQuest/Features/Shared/Components/TimeFormatting.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EstimationSnapshot value type and InsightEngine result types</name>
  <files>
    TimeQuest/Models/EstimationSnapshot.swift
    TimeQuest/Domain/InsightEngine.swift
  </files>
  <action>
Create `EstimationSnapshot.swift` in `TimeQuest/Models/`:
- Plain Swift struct (import Foundation only, NO SwiftData import in this file)
- Properties: `taskDisplayName: String`, `estimatedSeconds: Double`, `actualSeconds: Double`, `differenceSeconds: Double` (signed: positive = overestimate), `accuracyPercent: Double`, `recordedAt: Date`, `routineName: String`, `isCalibration: Bool`
- Add `init(from estimation: TaskEstimation)` in a separate extension at bottom of file that imports SwiftData. This extension maps from the SwiftData model: `routineName` comes from `estimation.session?.routine?.displayName ?? "Unknown"`, `isCalibration` comes from `estimation.session?.isCalibration ?? false`

Create `InsightEngine.swift` in `TimeQuest/Domain/`:
- Import Foundation only (NO SwiftData, NO SwiftUI)
- Define result enums and structs at the top of the file:
  - `BiasDirection` enum: `.overestimates`, `.underestimates`, `.balanced`
  - `BiasResult` struct: `taskDisplayName: String`, `direction: BiasDirection`, `meanDifferenceSeconds: Double`, `sampleCount: Int`
  - `TrendDirection` enum: `.improving`, `.declining`, `.stable`
  - `TrendResult` struct: `taskDisplayName: String`, `direction: TrendDirection`, `slopePerSession: Double`, `sampleCount: Int`
  - `ConsistencyLevel` enum: `.veryConsistent`, `.moderate`, `.variable`
  - `ConsistencyResult` struct: `taskDisplayName: String`, `level: ConsistencyLevel`, `coefficientOfVariation: Double`, `sampleCount: Int`
  - `TaskInsight` struct: `taskDisplayName: String`, `routineName: String`, `bias: BiasResult?`, `trend: TrendResult?`, `consistency: ConsistencyResult?`, `recentActualSeconds: [Double]`
- Define `InsightEngine` struct with `static let minimumSessions = 5`
- Add stub static functions (returning nil) for: `detectBias(snapshots:)`, `detectTrend(snapshots:)`, `computeConsistency(snapshots:)`, `contextualHint(taskName:snapshots:)`, `generateInsights(snapshots:)` (the last one returns `[TaskInsight]` by grouping snapshots by task, calling the three analysis functions, and assembling TaskInsight values)
- Stubs exist so tests can be written against the API before implementation (RED phase)
  </action>
  <verify>Both files compile with `swift build` or Xcode build. InsightEngine has no SwiftData import. EstimationSnapshot main struct has no SwiftData import (only the extension does).</verify>
  <done>EstimationSnapshot and InsightEngine type definitions exist with correct signatures. All analysis functions return nil (stubs for TDD RED phase).</done>
</task>

<task type="auto">
  <name>Task 2: TDD RED-GREEN-REFACTOR for InsightEngine analysis functions</name>
  <files>
    TimeQuest/Tests/InsightEngineTests.swift
    TimeQuest/Domain/InsightEngine.swift
  </files>
  <action>
**RED phase -- write failing tests first:**

Create `InsightEngineTests.swift` in `TimeQuest/Tests/` (or appropriate test target location matching project convention). Import XCTest. Create test helper function `makeSnapshot(taskName:estimated:actual:difference:accuracy:recordedAt:routineName:isCalibration:)` that builds EstimationSnapshot values for testing without SwiftData.

Write tests for each InsightEngine function:

1. **detectBias tests:**
   - `test_detectBias_returnsNil_whenFewerThan5NonCalibrationSnapshots` -- pass 4 non-cal + 3 cal snapshots, assert nil
   - `test_detectBias_overestimates_whenMeanDifferenceAboveThreshold` -- pass 6 snapshots with positive differenceSeconds averaging > 15s, assert `.overestimates`
   - `test_detectBias_underestimates_whenMeanDifferenceBelowNegativeThreshold` -- pass 6 snapshots with negative differenceSeconds averaging < -15s, assert `.underestimates`
   - `test_detectBias_balanced_whenMeanDifferenceWithinThreshold` -- pass 6 snapshots with small diffs, assert `.balanced`
   - `test_detectBias_excludesCalibrationSessions` -- pass 5 calibration + 4 non-calibration, assert nil (only 4 eligible)

2. **detectTrend tests:**
   - `test_detectTrend_returnsNil_whenInsufficientData` -- pass 3 snapshots, assert nil
   - `test_detectTrend_improving_whenAccuracyIncreasingOverTime` -- pass 7 snapshots with accuracy going 50, 55, 60, 65, 70, 75, 80, assert `.improving`
   - `test_detectTrend_declining_whenAccuracyDecreasing` -- pass 7 snapshots with accuracy going 90, 85, 80, 75, 70, 65, 60, assert `.declining`
   - `test_detectTrend_stable_whenAccuracyFlat` -- pass 6 snapshots with accuracy all ~75 (+/- 0.2), assert `.stable`

3. **computeConsistency tests:**
   - `test_computeConsistency_returnsNil_whenInsufficientData`
   - `test_computeConsistency_veryConsistent_whenLowCV` -- pass 6 snapshots with very similar abs(differenceSeconds) values (e.g., all ~30s), assert `.veryConsistent`
   - `test_computeConsistency_variable_whenHighCV` -- pass 6 snapshots with wildly different abs diffs (5, 120, 10, 200, 15, 180), assert `.variable`
   - `test_computeConsistency_perfectEstimates_returnsVeryConsistent` -- all diffs = 0

4. **contextualHint tests:**
   - `test_contextualHint_returnsNil_whenInsufficientData`
   - `test_contextualHint_returnsFormattedString_whenEnoughData` -- pass 7 snapshots for "Brush Teeth" with actual times, assert result contains "Last 5 times:" and formatted duration
   - `test_contextualHint_excludesCalibration` -- pass 5 cal + 4 non-cal, assert nil
   - `test_contextualHint_filtersToSpecificTask` -- pass mixed-task snapshots, assert hint only uses matching task

5. **generateInsights tests:**
   - `test_generateInsights_groupsByTaskAndReturnsInsights` -- pass snapshots for 2 tasks (6 each), assert 2 TaskInsight results
   - `test_generateInsights_excludesTasksWithInsufficientData` -- pass 4 snapshots for a task, assert empty

Run tests -- ALL must FAIL (RED).

**GREEN phase -- implement the functions:**

Implement `InsightEngine.detectBias(snapshots:)`:
- Filter `!isCalibration`, guard count >= minimumSessions
- Compute `meanDifference = eligible.map(\.differenceSeconds).reduce(0, +) / Double(eligible.count)`
- If meanDifference > 15.0 -> `.overestimates`, if < -15.0 -> `.underestimates`, else `.balanced`
- Use static constant `biasThresholdSeconds = 15.0`

Implement `InsightEngine.detectTrend(snapshots:)`:
- Filter `!isCalibration`, sort by recordedAt ascending, guard count >= minimumSessions
- Linear regression: x = index (0, 1, 2...), y = accuracyPercent
- Compute slope using least squares: `slope = (n*sumXY - sumX*sumY) / (n*sumX2 - sumX*sumX)`
- Guard denominator != 0
- If slope > 0.5 -> `.improving`, if < -0.5 -> `.declining`, else `.stable`
- Use static constant `trendSlopeThreshold = 0.5`

Implement `InsightEngine.computeConsistency(snapshots:)`:
- Filter `!isCalibration`, guard count >= minimumSessions
- Compute absDiffs, mean, variance, stdDev, cv = stdDev / mean
- Guard mean > 0 (if 0, return `.veryConsistent` with cv = 0)
- If cv < 0.3 -> `.veryConsistent`, if < 0.6 -> `.moderate`, else `.variable`
- Use static constants `consistencyLowCV = 0.3`, `consistencyHighCV = 0.6`

Implement `InsightEngine.contextualHint(taskName:snapshots:)`:
- Filter to matching taskName AND `!isCalibration`, sort by recordedAt descending
- Guard count >= minimumSessions
- Take prefix(5), compute mean of actualSeconds, format with `TimeFormatting.formatDuration`
- Return `"Last \(recentN.count) times: ~\(formatted)"`

Implement `InsightEngine.generateInsights(snapshots:)`:
- Filter `!isCalibration`
- Group by taskDisplayName
- For each group with count >= minimumSessions, create TaskInsight with all three analysis results and recentActualSeconds (last 5 sorted by date desc)
- Return `[TaskInsight]`

Run tests -- ALL must PASS (GREEN).

**REFACTOR phase (if needed):** Extract shared filtering logic into a private helper `eligibleSnapshots(from:)`. Ensure all threshold constants are named static lets.
  </action>
  <verify>All tests pass. No SwiftData import in InsightEngine.swift. Build succeeds.</verify>
  <done>InsightEngine correctly computes bias, trend, consistency, and contextual hints for per-task estimation data. All edge cases tested: insufficient data returns nil, calibration excluded, threshold boundaries respected.</done>
</task>

</tasks>

<verification>
1. `InsightEngine.swift` has ZERO SwiftData or SwiftUI imports
2. `EstimationSnapshot` main struct definition has ZERO SwiftData imports (extension only)
3. All InsightEngine functions return nil for < 5 non-calibration snapshots
4. Calibration snapshots are filtered out in every function
5. Bias uses mean signed difference with 15s threshold
6. Trend uses linear regression slope with 0.5 accuracy-points-per-session threshold
7. Consistency uses coefficient of variation with 0.3/0.6 breakpoints
8. Contextual hint formats using TimeFormatting.formatDuration
9. All tests pass
</verification>

<success_criteria>
- InsightEngine is a pure-Swift struct with static functions, matching TimeEstimationScorer/XPEngine pattern
- EstimationSnapshot cleanly bridges SwiftData to pure domain
- All 15+ test cases pass covering bias, trend, consistency, hints, and edge cases
- Threshold constants are exposed as static lets for future tuning
- Build succeeds with no warnings in InsightEngine.swift
</success_criteria>

<output>
After completion, create `.planning/phases/04-contextual-learning-insights/04-01-SUMMARY.md`
</output>
