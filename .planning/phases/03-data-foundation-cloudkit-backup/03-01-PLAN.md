---
phase: 03-data-foundation-cloudkit-backup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TimeQuest/Models/Schemas/TimeQuestSchemaV1.swift
  - TimeQuest/Models/Schemas/TimeQuestSchemaV2.swift
  - TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift
  - TimeQuest/Models/Routine.swift
  - TimeQuest/Models/RoutineTask.swift
  - TimeQuest/Models/GameSession.swift
  - TimeQuest/Models/TaskEstimation.swift
  - TimeQuest/Models/PlayerProfile.swift
  - generate-xcodeproj.js
autonomous: true

must_haves:
  truths:
    - "V1 schema enum exactly mirrors the current on-disk model definitions (byte-for-byte property match)"
    - "V2 schema adds cloudID: String = UUID().uuidString to all 5 models"
    - "V2 schema adds property-level defaults to every non-optional property that currently lacks one"
    - "Lightweight migration plan defines V1->V2 stage with no custom willMigrate/didMigrate"
    - "Existing model files become typealiases to V2 schema types, preserving all computed properties and convenience methods"
    - "Build system registers new Schemas/ and Migration/ files and project compiles"
  artifacts:
    - path: "TimeQuest/Models/Schemas/TimeQuestSchemaV1.swift"
      provides: "Retroactive V1 VersionedSchema with all 5 models matching current on-disk schema"
      contains: "TimeQuestSchemaV1"
    - path: "TimeQuest/Models/Schemas/TimeQuestSchemaV2.swift"
      provides: "V2 VersionedSchema with cloudID + defaults on all models"
      contains: "TimeQuestSchemaV2"
    - path: "TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift"
      provides: "SchemaMigrationPlan with lightweight V1->V2 stage"
      contains: "TimeQuestMigrationPlan"
    - path: "TimeQuest/Models/Routine.swift"
      provides: "Typealias to V2 + computed properties"
      contains: "typealias Routine"
    - path: "TimeQuest/Models/RoutineTask.swift"
      provides: "Typealias to V2 + convenience"
      contains: "typealias RoutineTask"
    - path: "TimeQuest/Models/GameSession.swift"
      provides: "Typealias to V2 + computed properties"
      contains: "typealias GameSession"
    - path: "TimeQuest/Models/TaskEstimation.swift"
      provides: "Typealias to V2 + computed rating"
      contains: "typealias TaskEstimation"
    - path: "TimeQuest/Models/PlayerProfile.swift"
      provides: "Typealias to V2"
      contains: "typealias PlayerProfile"
  key_links:
    - from: "TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift"
      to: "TimeQuestSchemaV1 + TimeQuestSchemaV2"
      via: "schemas array and lightweight stage"
      pattern: "MigrationStage\\.lightweight"
    - from: "TimeQuest/Models/Routine.swift"
      to: "TimeQuestSchemaV2.Routine"
      via: "typealias"
      pattern: "typealias Routine = TimeQuestSchemaV2\\.Routine"
---

<objective>
Create retroactive V1 schema, V2 schema with CloudKit-compatible defaults and cloudID, lightweight migration plan, and update existing model files to typealias V2 types.

Purpose: Establishes the schema versioning foundation required before CloudKit can be enabled. Without this, existing v1.0 user data would be lost on schema change, and CloudKit sync would silently fail due to missing defaults.

Output: 3 new Swift files (V1 schema, V2 schema, migration plan), 5 updated model files (typealiases + computed properties), updated build script.
</objective>

<execution_context>
@/Users/davezabihaylo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davezabihaylo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-data-foundation-cloudkit-backup/03-RESEARCH.md

@TimeQuest/Models/Routine.swift
@TimeQuest/Models/RoutineTask.swift
@TimeQuest/Models/GameSession.swift
@TimeQuest/Models/TaskEstimation.swift
@TimeQuest/Models/PlayerProfile.swift
@TimeQuest/Domain/TimeEstimationScorer.swift
@generate-xcodeproj.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create V1 and V2 VersionedSchemas + migration plan</name>
  <files>
    TimeQuest/Models/Schemas/TimeQuestSchemaV1.swift
    TimeQuest/Models/Schemas/TimeQuestSchemaV2.swift
    TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift
  </files>
  <action>
Create directory structure: `Models/Schemas/` and `Models/Migration/`.

**TimeQuestSchemaV1.swift** -- Retroactive V1 VersionedSchema.
CRITICAL: The V1 definitions MUST exactly match the current on-disk schema. Copy current model code byte-for-byte into the V1 enum. Do NOT add defaults, do NOT add cloudID, do NOT change anything. This is a snapshot of what's already on disk.

```swift
import Foundation
import SwiftData

enum TimeQuestSchemaV1: VersionedSchema {
    static var versionIdentifier = Schema.Version(1, 0, 0)
    static var models: [any PersistentModel.Type] {
        [Routine.self, RoutineTask.self, GameSession.self,
         TaskEstimation.self, PlayerProfile.self]
    }

    @Model final class Routine {
        var name: String
        var displayName: String
        var activeDays: [Int]
        var isActive: Bool
        var createdAt: Date
        var updatedAt: Date
        @Relationship(deleteRule: .cascade, inverse: \RoutineTask.routine)
        var tasks: [RoutineTask] = []
        @Relationship(deleteRule: .cascade, inverse: \GameSession.routine)
        var sessions: [GameSession] = []
        init(name: String, displayName: String, activeDays: [Int] = [],
             isActive: Bool = true, createdAt: Date = .now, updatedAt: Date = .now) {
            self.name = name; self.displayName = displayName
            self.activeDays = activeDays; self.isActive = isActive
            self.createdAt = createdAt; self.updatedAt = updatedAt
        }
    }
    // ... same pattern for RoutineTask, GameSession, TaskEstimation, PlayerProfile
    // Each MUST match the current model definitions exactly
}
```

Exact current property definitions to copy:
- **Routine:** name: String, displayName: String, activeDays: [Int], isActive: Bool, createdAt: Date, updatedAt: Date, tasks: [RoutineTask] = [], sessions: [GameSession] = []
- **RoutineTask:** name: String, displayName: String, referenceDurationSeconds: Int?, orderIndex: Int, routine: Routine?
- **GameSession:** routine: Routine?, startedAt: Date, completedAt: Date?, isCalibration: Bool, xpEarned: Int = 0, estimations: [TaskEstimation] = []
- **TaskEstimation:** taskDisplayName: String, estimatedSeconds: Double, actualSeconds: Double, differenceSeconds: Double, accuracyPercent: Double, ratingRawValue: String, orderIndex: Int, recordedAt: Date, session: GameSession?
- **PlayerProfile:** totalXP: Int = 0, currentStreak: Int = 0, lastPlayedDate: Date?, notificationsEnabled: Bool = true, notificationHour: Int = 7, notificationMinute: Int = 30, soundEnabled: Bool = true, createdAt: Date = Date.now

**TimeQuestSchemaV2.swift** -- V2 with CloudKit defaults + cloudID.
Every non-optional property MUST have a property-level default. Add `cloudID: String = UUID().uuidString` to ALL 5 models.

Properties that need NEW defaults added (not present in V1):
- Routine: `name: String = ""`, `displayName: String = ""`, `isActive: Bool = true`, `createdAt: Date = Date.now`, `updatedAt: Date = Date.now`
- RoutineTask: `name: String = ""`, `displayName: String = ""`, `orderIndex: Int = 0`
- GameSession: `startedAt: Date = Date.now`, `isCalibration: Bool = false`
- TaskEstimation: `taskDisplayName: String = ""`, `estimatedSeconds: Double = 0`, `actualSeconds: Double = 0`, `differenceSeconds: Double = 0`, `accuracyPercent: Double = 0`, `ratingRawValue: String = "way_off"`, `orderIndex: Int = 0`, `recordedAt: Date = Date.now`
- PlayerProfile: Already has all defaults -- just add `cloudID: String = UUID().uuidString`

Do NOT include computed properties (orderedTasks, orderedEstimations, rating) in schema enums -- those go in the typealias files.

Keep init() methods on V2 models that accept parameters for creation (the inits in V1 are fine as-is, the inits in V2 should match but now every param has a default since the property-level defaults exist).

**TimeQuestMigrationPlan.swift** -- Lightweight-only migration.
CRITICAL: Use ONLY `MigrationStage.lightweight()`. Custom migrations crash with CloudKit on iOS 17.x (FB13694972).

```swift
import Foundation
import SwiftData

enum TimeQuestMigrationPlan: SchemaMigrationPlan {
    static var schemas: [any VersionedSchema.Type] {
        [TimeQuestSchemaV1.self, TimeQuestSchemaV2.self]
    }
    static var stages: [MigrationStage] {
        [v1ToV2]
    }
    static let v1ToV2 = MigrationStage.lightweight(
        fromVersion: TimeQuestSchemaV1.self,
        toVersion: TimeQuestSchemaV2.self
    )
}
```

Swift 6.0 strict concurrency: These are enums with static members, no @MainActor needed. Use `@preconcurrency import SwiftData` if the compiler warns about Sendable conformance on VersionedSchema types.
  </action>
  <verify>
All 3 new files exist at the specified paths. Each file compiles in isolation (check for syntax errors). V1 models match the current on-disk schema exactly. V2 models have cloudID + defaults on every non-optional property. Migration plan uses only lightweight stages.
  </verify>
  <done>
TimeQuestSchemaV1 captures the exact current schema. TimeQuestSchemaV2 adds cloudID to all 5 models and property-level defaults to all non-optional properties. TimeQuestMigrationPlan defines a single lightweight V1->V2 stage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert model files to typealiases + update build system</name>
  <files>
    TimeQuest/Models/Routine.swift
    TimeQuest/Models/RoutineTask.swift
    TimeQuest/Models/GameSession.swift
    TimeQuest/Models/TaskEstimation.swift
    TimeQuest/Models/PlayerProfile.swift
    generate-xcodeproj.js
  </files>
  <action>
**Replace each model file** with a typealias to the V2 schema type, plus any computed properties or extensions that existed before. The rest of the app imports these files and uses the type names directly, so the typealiases make the transition transparent.

**Routine.swift:**
```swift
import Foundation
import SwiftData

typealias Routine = TimeQuestSchemaV2.Routine

extension Routine {
    /// Always use this for ordered access -- SwiftData does NOT preserve array order.
    var orderedTasks: [RoutineTask] {
        tasks.sorted { $0.orderIndex < $1.orderIndex }
    }
}
```

**RoutineTask.swift:**
```swift
import Foundation
import SwiftData

typealias RoutineTask = TimeQuestSchemaV2.RoutineTask
```

**GameSession.swift:**
```swift
import Foundation
import SwiftData

typealias GameSession = TimeQuestSchemaV2.GameSession

extension GameSession {
    /// Always use this for ordered access -- SwiftData does NOT preserve array order.
    var orderedEstimations: [TaskEstimation] {
        estimations.sorted { $0.orderIndex < $1.orderIndex }
    }
}
```

**TaskEstimation.swift:**
```swift
import Foundation
import SwiftData

typealias TaskEstimation = TimeQuestSchemaV2.TaskEstimation

extension TaskEstimation {
    /// Computed rating from stored raw value. Falls back to .way_off if invalid.
    var rating: AccuracyRating {
        AccuracyRating(rawValue: ratingRawValue) ?? .way_off
    }
}
```
Note: AccuracyRating is defined in TimeEstimationScorer.swift -- verify this import/access works. The enum is at module scope, so no import needed beyond same-module access.

**PlayerProfile.swift:**
```swift
import Foundation
import SwiftData

typealias PlayerProfile = TimeQuestSchemaV2.PlayerProfile
```

**generate-xcodeproj.js updates:**

1. Add 3 new source files to the `sourceFiles` array:
   - `{ name: 'TimeQuestSchemaV1.swift', path: 'Models/Schemas/TimeQuestSchemaV1.swift' }`
   - `{ name: 'TimeQuestSchemaV2.swift', path: 'Models/Schemas/TimeQuestSchemaV2.swift' }`
   - `{ name: 'TimeQuestMigrationPlan.swift', path: 'Models/Migration/TimeQuestMigrationPlan.swift' }`

2. Add 2 new sub-groups under the Models group. The Models group currently lists files. Add subgroups for Schemas and Migration:
   - Add to the `groups` array: `{ name: 'Schemas', path: 'Schemas', files: ['TimeQuestSchemaV1.swift', 'TimeQuestSchemaV2.swift'] }`
   - Add to the `groups` array: `{ name: 'Migration', path: 'Migration', files: ['TimeQuestMigrationPlan.swift'] }`
   - Update the Models group entry to include subgroups: add `subgroups: ['Schemas', 'Migration']` to the Models group object (keeping its existing files array)

3. Run `node generate-xcodeproj.js` to regenerate the project file.

4. Verify build: `xcodebuild -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5`

If build errors occur related to type resolution (circular references between schema types), the V2 schema file may need `@Relationship` inverse keypaths to reference the V2-internal types using backslash-dot syntax within the enum scope. The V1 schema similarly needs internal references. Both V1 and V2 schema enums must use their own nested types in relationship inverse keypaths (e.g., `\TimeQuestSchemaV2.RoutineTask.routine` not `\RoutineTask.routine`).
  </action>
  <verify>
Run `node generate-xcodeproj.js` -- should succeed without errors. Run `xcodebuild -project TimeQuest/TimeQuest.xcodeproj -scheme TimeQuest -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -20` -- project must compile successfully. Verify that existing code (repositories, view models, views) still works by confirming zero build errors. The typealias approach means all existing call sites remain unchanged.
  </verify>
  <done>
All 5 model files are typealiases to TimeQuestSchemaV2 types with computed properties preserved. generate-xcodeproj.js registers Schemas/ and Migration/ groups and files. Project compiles successfully with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `ls TimeQuest/Models/Schemas/TimeQuestSchemaV1.swift TimeQuest/Models/Schemas/TimeQuestSchemaV2.swift TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift` -- all 3 files exist
2. `grep "typealias Routine = TimeQuestSchemaV2" TimeQuest/Models/Routine.swift` -- typealias present
3. `grep "typealias PlayerProfile = TimeQuestSchemaV2" TimeQuest/Models/PlayerProfile.swift` -- typealias present
4. `grep "cloudID" TimeQuest/Models/Schemas/TimeQuestSchemaV2.swift | wc -l` -- should be 5 (one per model)
5. `grep "MigrationStage.lightweight" TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift` -- lightweight only
6. `grep -c "MigrationStage.custom" TimeQuest/Models/Migration/TimeQuestMigrationPlan.swift` -- should be 0
7. `xcodebuild build` succeeds
</verification>

<success_criteria>
- V1 schema exactly mirrors current on-disk model definitions (no new properties, no new defaults)
- V2 schema has cloudID: String = UUID().uuidString on all 5 models
- V2 schema has property-level defaults on every non-optional property
- Migration plan uses only MigrationStage.lightweight (no custom stages)
- Model files are typealiases preserving all computed properties (orderedTasks, orderedEstimations, rating)
- Build system updated and project compiles with zero errors
- All existing code (repositories, view models, views) works without modification
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-foundation-cloudkit-backup/03-01-SUMMARY.md`
</output>
